(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{1367:function(t,_,v){"use strict";v.r(_);var a=v(6),e=Object(a.a)({},(function(){var t=this,_=t.$createElement,a=t._self._c||_;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"_1、mysql-事务隔离级别"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、mysql-事务隔离级别"}},[t._v("#")]),t._v(" 1、MySQL 事务隔离级别")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("未提交读 - 读到其它事务未提交的数据（最新的版本）")]),t._v(" "),a("ul",[a("li",[t._v("错误现象：有脏读、不可重复读、幻读现象")])])]),t._v(" "),a("li",[a("p",[t._v("提交读（RC） - 读到其它事务已提交的数据（最新已提交的版本）")]),t._v(" "),a("ul",[a("li",[t._v("错误现象：有不可重复读、幻读现象")]),t._v(" "),a("li",[t._v("使用场景：希望看到最新的有效值")])])]),t._v(" "),a("li",[a("p",[t._v("可重复读（RR） - 在事务范围内，多次读能够保证一致性（快照建立时最新已提交版本）")]),t._v(" "),a("ul",[a("li",[t._v("错误现象：有幻读现象，可以用加锁避免")]),t._v(" "),a("li",[t._v("使用场景：事务内要求更强的一致性，但看到的未必是最新的有效值")])])]),t._v(" "),a("li",[a("p",[t._v("串行读 - 在事务范围内，仅有读读可以并发，读写或写写会阻塞其它事务，用这种办法保证更强的一致性")]),t._v(" "),a("ul",[a("li",[t._v("错误现象：无")])])])]),t._v(" "),a("h4",{attrs:{id:"_1、脏读现象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、脏读现象"}},[t._v("#")]),t._v(" 1、脏读现象")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[a("strong",[t._v("tx1")])]),t._v(" "),a("th",[a("strong",[t._v("tx2")])])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("set session transaction isolation level read uncommitted;")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("start transaction;")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("select * from account;/"),a("em",[t._v("两个账户都为 1000")]),t._v("/")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td",[t._v("start transaction;")])]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td",[t._v("update account set balance = 2000 where accountNo=1;")])]),t._v(" "),a("tr",[a("td",[t._v("select * from account;/"),a("em",[t._v("1号账户2000, 2号账户1000")]),t._v("/")]),t._v(" "),a("td")])])]),t._v(" "),a("p",[a("img",{attrs:{src:v(442),alt:"image-20221022101307568"}})]),t._v(" "),a("blockquote",[a("p",[t._v("tx2 未提交的情况下，tx1 仍然读取到了它的更改，此时与第一次读取的数据不一致，则是产生了脏读")])]),t._v(" "),a("h4",{attrs:{id:"_2、不可重复读现象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、不可重复读现象"}},[t._v("#")]),t._v(" 2、不可重复读现象")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[a("strong",[t._v("tx1")])]),t._v(" "),a("th",[a("strong",[t._v("tx2")])])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("set  session transaction isolation level read committed;")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("start  transaction;")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("select  * from account; /"),a("em",[t._v("两个账户都为 1000")]),t._v("/")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td",[t._v("update  account set balance = 2000 where accountNo=1;")])]),t._v(" "),a("tr",[a("td",[t._v("select  * from account; /"),a("em",[t._v("1号账户2000, 2号账户1000")]),t._v("/")]),t._v(" "),a("td")])])]),t._v(" "),a("p",[a("img",{attrs:{src:v(443),alt:"image-20221022101453527"}})]),t._v(" "),a("blockquote",[a("p",[t._v("tx1 在同一事务内，两次读取的结果不一致，当然，此时 tx2 的事务已提交")])]),t._v(" "),a("h4",{attrs:{id:"_3、幻读现象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3、幻读现象"}},[t._v("#")]),t._v(" 3、幻读现象")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[a("strong",[t._v("tx1")])]),t._v(" "),a("th",[a("strong",[t._v("tx2")])])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("set  session transaction isolation level repeatable read;")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("start  transaction;")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("select  * from account; /"),a("em",[t._v("存在 1,2 两个账户")]),t._v("/")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td",[t._v("insert  into account values(3, 1000);")])]),t._v(" "),a("tr",[a("td",[t._v("select  * from account; /"),a("em",[t._v("发现还是只有 1,2 两个账户")]),t._v("/")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("insert  into account values(3, 5000);  /* ERROR  1062 (23000): Duplicate entry '3' for key 'PRIMARY'  */")]),t._v(" "),a("td")])])]),t._v(" "),a("p",[a("img",{attrs:{src:v(444),alt:"image-20221022105234049"}})]),t._v(" "),a("blockquote",[a("p",[t._v("tx1 查询时并没有发现 3 号账户，执行插入时却发现主键冲突异常，就好像出现了幻觉一样")])]),t._v(" "),a("h4",{attrs:{id:"_4、使用-for-update-避免幻读现象"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4、使用-for-update-避免幻读现象"}},[t._v("#")]),t._v(" 4、使用 for update 避免幻读现象")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[a("strong",[t._v("tx1")])]),t._v(" "),a("th",[a("strong",[t._v("tx2")])])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("set  session transaction isolation level repeatable read;")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("start  transaction;")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("select  * from account; /"),a("em",[t._v("存在 1,2 两个账户")]),t._v("/")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("select  * from account where accountNo=3  for update;")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td",[t._v("insert  into account values(3, 1000);  /* 阻塞 */")])]),t._v(" "),a("tr",[a("td",[t._v("insert  into account values(3, 5000);")]),t._v(" "),a("td")])])]),t._v(" "),a("ul",[a("li",[t._v("在 for update 这行语句执行时，虽然此时 3 号账户尚不存在，但 MySQL 在 repeatable read 隔离级别下会用间隙锁，锁住 2 号记录与正无穷大之间的间隙")]),t._v(" "),a("li",[t._v("此时 tx2 想插入 3 号记录就不行了，被间隙锁挡住了")])]),t._v(" "),a("h4",{attrs:{id:"_5、串行读避免幻读"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5、串行读避免幻读"}},[t._v("#")]),t._v(" 5、串行读避免幻读")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[a("strong",[t._v("tx1")])]),t._v(" "),a("th",[a("strong",[t._v("tx2")])])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("set  session transaction isolation level serializable;")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("start  transaction;")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td",[t._v("select  * from account; /* 存在 1,2 两个账户 */")]),t._v(" "),a("td")]),t._v(" "),a("tr",[a("td"),t._v(" "),a("td",[t._v("insert  into account values(3, 1000);  /* 阻塞 */")])]),t._v(" "),a("tr",[a("td",[t._v("insert  into account values(3, 5000);")]),t._v(" "),a("td")])])]),t._v(" "),a("blockquote",[a("p",[t._v("串行读隔离级别下，普通的 select 也会加共享读锁，其它事务的查询可以并发，但增删改就只能阻塞了")])])])}),[],!1,null,null,null);_.default=e.exports},442:function(t,_,v){t.exports=v.p+"assets/img/image-20221022101307568.a4c07013.png"},443:function(t,_,v){t.exports=v.p+"assets/img/image-20221022101453527.622f2694.png"},444:function(t,_,v){t.exports=v.p+"assets/img/image-20221022105234049.de3df162.png"}}]);