<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1、MySQL 事务隔离级别 | 小熊学Java</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="./xiaobear.ico">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?c1b38aee20eeeb56adb65146a17e0b47";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
        </script>
    <meta name="description" content="放弃很容易，但坚持一定很酷！">
    <meta name="baidu-site-verification" content="code-FVmKyJMz00">
    <meta name="360-site-verification" content="b9b356af59f019380844a85d5b887d22">
    
    <link rel="preload" href="/assets/css/0.styles.f5efb75f.css" as="style"><link rel="preload" href="/assets/js/app.9fae93c2.js" as="script"><link rel="preload" href="/assets/js/8.6de2748b.js" as="script"><link rel="preload" href="/assets/js/18.b9c6dd45.js" as="script"><link rel="prefetch" href="/assets/js/10.1e7a1022.js"><link rel="prefetch" href="/assets/js/11.14eba8f6.js"><link rel="prefetch" href="/assets/js/12.ee089ac5.js"><link rel="prefetch" href="/assets/js/13.14a6f585.js"><link rel="prefetch" href="/assets/js/14.262ed780.js"><link rel="prefetch" href="/assets/js/15.9de44e9e.js"><link rel="prefetch" href="/assets/js/16.f5a6bfd8.js"><link rel="prefetch" href="/assets/js/17.39e7febc.js"><link rel="prefetch" href="/assets/js/19.4019bc23.js"><link rel="prefetch" href="/assets/js/2.8ab847ea.js"><link rel="prefetch" href="/assets/js/20.7dba5cb1.js"><link rel="prefetch" href="/assets/js/21.88b21250.js"><link rel="prefetch" href="/assets/js/22.4b706d27.js"><link rel="prefetch" href="/assets/js/23.226347b2.js"><link rel="prefetch" href="/assets/js/24.71326735.js"><link rel="prefetch" href="/assets/js/25.69884879.js"><link rel="prefetch" href="/assets/js/26.3e008d08.js"><link rel="prefetch" href="/assets/js/27.bd9e99da.js"><link rel="prefetch" href="/assets/js/28.4d9fa21f.js"><link rel="prefetch" href="/assets/js/29.f9724161.js"><link rel="prefetch" href="/assets/js/3.34476678.js"><link rel="prefetch" href="/assets/js/30.30c1f3ff.js"><link rel="prefetch" href="/assets/js/31.b09048ee.js"><link rel="prefetch" href="/assets/js/32.a8554058.js"><link rel="prefetch" href="/assets/js/33.a5110493.js"><link rel="prefetch" href="/assets/js/34.2b9786c3.js"><link rel="prefetch" href="/assets/js/35.5728728f.js"><link rel="prefetch" href="/assets/js/36.03c75877.js"><link rel="prefetch" href="/assets/js/37.c51f58e0.js"><link rel="prefetch" href="/assets/js/38.43ffcaca.js"><link rel="prefetch" href="/assets/js/39.5c3642cf.js"><link rel="prefetch" href="/assets/js/4.c9105f19.js"><link rel="prefetch" href="/assets/js/40.0bd5fb5d.js"><link rel="prefetch" href="/assets/js/41.c5d82cf9.js"><link rel="prefetch" href="/assets/js/42.ca15b1f4.js"><link rel="prefetch" href="/assets/js/43.99507c47.js"><link rel="prefetch" href="/assets/js/44.ec6c0574.js"><link rel="prefetch" href="/assets/js/45.23ad772b.js"><link rel="prefetch" href="/assets/js/46.876d924a.js"><link rel="prefetch" href="/assets/js/47.78c8581c.js"><link rel="prefetch" href="/assets/js/48.6dd683f3.js"><link rel="prefetch" href="/assets/js/49.8bacc727.js"><link rel="prefetch" href="/assets/js/5.3fa9fdce.js"><link rel="prefetch" href="/assets/js/50.87de12f2.js"><link rel="prefetch" href="/assets/js/51.bcf83bdd.js"><link rel="prefetch" href="/assets/js/52.9030e5a8.js"><link rel="prefetch" href="/assets/js/53.7329a1c0.js"><link rel="prefetch" href="/assets/js/54.3df55bdf.js"><link rel="prefetch" href="/assets/js/55.440988ee.js"><link rel="prefetch" href="/assets/js/56.6feee735.js"><link rel="prefetch" href="/assets/js/57.39b0d6e1.js"><link rel="prefetch" href="/assets/js/58.ae18f65a.js"><link rel="prefetch" href="/assets/js/59.1d4da83d.js"><link rel="prefetch" href="/assets/js/6.13af6b79.js"><link rel="prefetch" href="/assets/js/60.62f64e9d.js"><link rel="prefetch" href="/assets/js/61.4e7c0e3e.js"><link rel="prefetch" href="/assets/js/62.fd1fd9ee.js"><link rel="prefetch" href="/assets/js/63.dbefdbfc.js"><link rel="prefetch" href="/assets/js/64.e76fce52.js"><link rel="prefetch" href="/assets/js/65.79c28e3c.js"><link rel="prefetch" href="/assets/js/66.65b14369.js"><link rel="prefetch" href="/assets/js/67.dedfa5bb.js"><link rel="prefetch" href="/assets/js/68.782b701b.js"><link rel="prefetch" href="/assets/js/69.7b228322.js"><link rel="prefetch" href="/assets/js/7.091c60c8.js"><link rel="prefetch" href="/assets/js/70.4095ca82.js"><link rel="prefetch" href="/assets/js/71.9e859f7d.js"><link rel="prefetch" href="/assets/js/72.09b45fd2.js"><link rel="prefetch" href="/assets/js/73.04728c96.js"><link rel="prefetch" href="/assets/js/74.130ba569.js"><link rel="prefetch" href="/assets/js/75.513060c3.js"><link rel="prefetch" href="/assets/js/76.83087703.js"><link rel="prefetch" href="/assets/js/77.9f1f552a.js"><link rel="prefetch" href="/assets/js/78.e1ef8d5b.js"><link rel="prefetch" href="/assets/js/79.8e1e7a5f.js"><link rel="prefetch" href="/assets/js/9.b275c17b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f5efb75f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小熊学Java</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  🏠首页
</a></div><div class="nav-item"><a href="/brush/" class="nav-link">
  📝码不停题
</a></div><div class="nav-item"><a href="/interview/" class="nav-link router-link-active">
  💸面试专栏
</a></div><div class="nav-item"><a href="/install/" class="nav-link">
  📖安装教程
</a></div><div class="nav-item"><a href="/notes/" class="nav-link">
  📓学习笔记
</a></div><div class="nav-item"><a href="/architecture/" class="nav-link">
  🛠架构设计
</a></div><div class="nav-item"><a href="/about/me.html" class="nav-link">
  👨‍关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  🏠首页
</a></div><div class="nav-item"><a href="/brush/" class="nav-link">
  📝码不停题
</a></div><div class="nav-item"><a href="/interview/" class="nav-link router-link-active">
  💸面试专栏
</a></div><div class="nav-item"><a href="/install/" class="nav-link">
  📖安装教程
</a></div><div class="nav-item"><a href="/notes/" class="nav-link">
  📓学习笔记
</a></div><div class="nav-item"><a href="/architecture/" class="nav-link">
  🛠架构设计
</a></div><div class="nav-item"><a href="/about/me.html" class="nav-link">
  👨‍关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/javaBasics/overview.html" class="sidebar-link">Java概述</a></li><li><a href="/interview/javaBasics/objectOriented.html" class="sidebar-link">Java面向对象</a></li><li><a href="/interview/javaBasics/javaSE.html" class="sidebar-link">JavaSE</a></li><li><a href="/interview/javaBasics/typeOfData.html" class="sidebar-link">Java数据类型</a></li><li><a href="/interview/javaBasics/exception.html" class="sidebar-link">Java异常</a></li><li><a href="/interview/javaBasics/collection.html" class="sidebar-link">Java集合</a></li><li><a href="/interview/javaBasics/multithreading.html" class="sidebar-link">Java多线程</a></li><li><a href="/interview/javaBasics/io.html" class="sidebar-link">Java IO</a></li><li><a href="/interview/javaBasics/innerClass.html" class="sidebar-link">Java内部类</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java高级</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/javaHighLevel/reflection.html" class="sidebar-link">Java反射</a></li><li><a href="/interview/javaHighLevel/jvm.html" class="sidebar-link">JVM</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>计算机基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/computer/network.html" class="sidebar-link">计算机网络</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/database/redis.html" class="sidebar-link">Redis</a></li><li><a href="/interview/database/MySQL.html" class="sidebar-link">MySQL</a></li><li><a href="/interview/database/MySQLTopics.html" aria-current="page" class="active sidebar-link">MySQL专题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview/database/MySQLTopics.html#_1、mysql-事务隔离级别" class="sidebar-link">1、MySQL 事务隔离级别</a></li><li class="sidebar-sub-header"><a href="/interview/database/MySQLTopics.html#_2、快照读与当前读" class="sidebar-link">2、快照读与当前读</a></li><li class="sidebar-sub-header"><a href="/interview/database/MySQLTopics.html#_3、innodb-vs-myisam" class="sidebar-link">3、InnoDB vs MyISAM</a></li><li class="sidebar-sub-header"><a href="/interview/database/MySQLTopics.html#_4、查询语句执行流程" class="sidebar-link">4、查询语句执行流程</a></li><li class="sidebar-sub-header"><a href="/interview/database/MySQLTopics.html#_5、undo-log-与-redo-log" class="sidebar-link">5、undo log 与 redo log</a></li><li class="sidebar-sub-header"><a href="/interview/database/MySQLTopics.html#_6、mysql锁" class="sidebar-link">6、MySQL锁</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/framework/Spring.html" class="sidebar-link">Spring</a></li><li><a href="/interview/framework/Spring MVC.html" class="sidebar-link">Spring MVC</a></li><li><a href="/interview/framework/Mybatis.html" class="sidebar-link">Mybatis</a></li><li><a href="/interview/framework/Spring Boot.html" class="sidebar-link">Spring Boot</a></li><li><a href="/interview/framework/Spring Cloud.html" class="sidebar-link">Spring Cloud</a></li><li><a href="/interview/framework/Spring Cloud Alibaba.html" class="sidebar-link">Spring Cloud Alibaba</a></li><li><a href="/interview/framework/RabbitMQ.html" class="sidebar-link">RabbitMQ</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>底层源码</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/sourceCode/ArrayList.html" class="sidebar-link">ArrayList扩容机制</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1、mysql-事务隔离级别"><a href="#_1、mysql-事务隔离级别" class="header-anchor">#</a> 1、MySQL 事务隔离级别</h2> <ul><li><p>未提交读 - 读到其它事务未提交的数据（最新的版本）</p> <ul><li>错误现象：有脏读、不可重复读、幻读现象</li></ul></li> <li><p>提交读（RC） - 读到其它事务已提交的数据（最新已提交的版本）</p> <ul><li>错误现象：有不可重复读、幻读现象</li> <li>使用场景：希望看到最新的有效值</li></ul></li> <li><p>可重复读（RR） - 在事务范围内，多次读能够保证一致性（快照建立时最新已提交版本）</p> <ul><li>错误现象：有幻读现象，可以用加锁避免</li> <li>使用场景：事务内要求更强的一致性，但看到的未必是最新的有效值</li></ul></li> <li><p>串行读 - 在事务范围内，仅有读读可以并发，读写或写写会阻塞其它事务，用这种办法保证更强的一致性</p> <ul><li>错误现象：无</li></ul></li></ul> <h4 id="_1、脏读现象"><a href="#_1、脏读现象" class="header-anchor">#</a> 1、脏读现象</h4> <table><thead><tr><th><strong>tx1</strong></th> <th><strong>tx2</strong></th></tr></thead> <tbody><tr><td>set session transaction isolation level read uncommitted;</td> <td></td></tr> <tr><td>start transaction;</td> <td></td></tr> <tr><td>select * from account;/<em>两个账户都为 1000</em>/</td> <td></td></tr> <tr><td></td> <td>start transaction;</td></tr> <tr><td></td> <td>update account set balance = 2000 where accountNo=1;</td></tr> <tr><td>select * from account;/<em>1号账户2000, 2号账户1000</em>/</td> <td></td></tr></tbody></table> <p><img src="/assets/img/image-20221022101307568.a4c07013.png" alt="image-20221022101307568"></p> <blockquote><p>tx2 未提交的情况下，tx1 仍然读取到了它的更改，此时与第一次读取的数据不一致，则是产生了脏读</p></blockquote> <h4 id="_2、不可重复读现象"><a href="#_2、不可重复读现象" class="header-anchor">#</a> 2、不可重复读现象</h4> <table><thead><tr><th><strong>tx1</strong></th> <th><strong>tx2</strong></th></tr></thead> <tbody><tr><td>set  session transaction isolation level read committed;</td> <td></td></tr> <tr><td>start  transaction;</td> <td></td></tr> <tr><td>select  * from account; /<em>两个账户都为 1000</em>/</td> <td></td></tr> <tr><td></td> <td>update  account set balance = 2000 where accountNo=1;</td></tr> <tr><td>select  * from account; /<em>1号账户2000, 2号账户1000</em>/</td> <td></td></tr></tbody></table> <p><img src="/assets/img/image-20221022101453527.622f2694.png" alt="image-20221022101453527"></p> <blockquote><p>tx1 在同一事务内，两次读取的结果不一致，当然，此时 tx2 的事务已提交</p></blockquote> <h4 id="_3、幻读现象"><a href="#_3、幻读现象" class="header-anchor">#</a> 3、幻读现象</h4> <table><thead><tr><th><strong>tx1</strong></th> <th><strong>tx2</strong></th></tr></thead> <tbody><tr><td>set  session transaction isolation level repeatable read;</td> <td></td></tr> <tr><td>start  transaction;</td> <td></td></tr> <tr><td>select  * from account; /<em>存在 1,2 两个账户</em>/</td> <td></td></tr> <tr><td></td> <td>insert  into account values(3, 1000);</td></tr> <tr><td>select  * from account; /<em>发现还是只有 1,2 两个账户</em>/</td> <td></td></tr> <tr><td>insert  into account values(3, 5000);  /* ERROR  1062 (23000): Duplicate entry '3' for key 'PRIMARY'  */</td> <td></td></tr></tbody></table> <p><img src="/assets/img/image-20221022105234049.de3df162.png" alt="image-20221022105234049"></p> <blockquote><p>tx1 查询时并没有发现 3 号账户，执行插入时却发现主键冲突异常，就好像出现了幻觉一样</p></blockquote> <h4 id="_4、使用-for-update-避免幻读现象"><a href="#_4、使用-for-update-避免幻读现象" class="header-anchor">#</a> 4、使用 for update 避免幻读现象</h4> <table><thead><tr><th><strong>tx1</strong></th> <th><strong>tx2</strong></th></tr></thead> <tbody><tr><td>set  session transaction isolation level repeatable read;</td> <td></td></tr> <tr><td>start  transaction;</td> <td></td></tr> <tr><td>select  * from account; /<em>存在 1,2 两个账户</em>/</td> <td></td></tr> <tr><td>select  * from account where accountNo=3  for update;</td> <td></td></tr> <tr><td></td> <td>insert  into account values(3, 1000);  /* 阻塞 */</td></tr> <tr><td>insert  into account values(3, 5000);</td> <td></td></tr></tbody></table> <ul><li>在 for update 这行语句执行时，虽然此时 3 号账户尚不存在，但 MySQL 在 repeatable read 隔离级别下会用间隙锁，锁住 2 号记录与正无穷大之间的间隙</li> <li>此时 tx2 想插入 3 号记录就不行了，被间隙锁挡住了</li></ul> <h4 id="_5、串行读避免幻读"><a href="#_5、串行读避免幻读" class="header-anchor">#</a> 5、串行读避免幻读</h4> <table><thead><tr><th><strong>tx1</strong></th> <th><strong>tx2</strong></th></tr></thead> <tbody><tr><td>set  session transaction isolation level serializable;</td> <td></td></tr> <tr><td>start  transaction;</td> <td></td></tr> <tr><td>select  * from account; /* 存在 1,2 两个账户 */</td> <td></td></tr> <tr><td></td> <td>insert  into account values(3, 1000);  /* 阻塞 */</td></tr> <tr><td>insert  into account values(3, 5000);</td> <td></td></tr></tbody></table> <blockquote><p>串行读隔离级别下，普通的 select 也会加共享读锁，其它事务的查询可以并发，但增删改就只能阻塞了</p></blockquote> <h2 id="_2、快照读与当前读"><a href="#_2、快照读与当前读" class="header-anchor">#</a> 2、快照读与当前读</h2> <h4 id="_1、当前读"><a href="#_1、当前读" class="header-anchor">#</a> 1、当前读</h4> <blockquote><p>当前读，即读取最新提交的数据，查询时需要加锁，以下情况都属于当前读</p> <ul><li><p>select … for update</p></li> <li><p>insert、update、delete，都会按最新提交的数据进行操作</p></li></ul></blockquote> <h4 id="_2、快照读"><a href="#_2、快照读" class="header-anchor">#</a> 2、快照读</h4> <blockquote><p>快照读，读取某一个快照建立时（可以理解为某一时间点）的数据，快照读主要体现在 select 时，不同隔离级别下，select 的行为不同</p> <ul><li>在 Serializable 隔离级别下 - 普通 select 也变成当前读</li> <li>在 RC 隔离级别下 - 每次 select 都会建立新的快照</li> <li>在 RR 隔离级别下
<ul><li>事务启动后，首次 select 会建立快照</li> <li>如果事务启动选择了 with consistent snapshot，事务启动时就建立快照</li> <li>基于旧数据的修改操作，会重新建立快照</li></ul></li></ul> <p><strong>快照读本质上读取的是历史数据（原理是回滚段），属于无锁查询</strong></p></blockquote> <h5 id="_1、rr-下-快照建立时机-第一次-select-时"><a href="#_1、rr-下-快照建立时机-第一次-select-时" class="header-anchor">#</a> 1、RR 下，快照建立时机 - 第一次 select 时</h5> <table><thead><tr><th><strong>tx1</strong></th> <th><strong>tx2</strong></th></tr></thead> <tbody><tr><td>set  session transaction isolation level repeatable read;</td> <td></td></tr> <tr><td>start  transaction;</td> <td></td></tr> <tr><td>select  * from account;  /* 此时建立快照，两个账户为 1000  */</td> <td></td></tr> <tr><td></td> <td>update  account set balance = 2000 where accountNo=1;</td></tr> <tr><td>select  * from account;  /* 两个账户仍为 1000 */</td> <td></td></tr></tbody></table> <ul><li>快照一旦建立，以后的查询都基于此快照，因此 tx1 中第二次 select 仍然得到 1 号账户余额为 1000</li></ul> <p>如果 tx2 的 update 先执行</p> <table><thead><tr><th><strong>tx1</strong></th> <th><strong>tx2</strong></th></tr></thead> <tbody><tr><td>set  session transaction isolation level repeatable read;</td> <td></td></tr> <tr><td>start  transaction;</td> <td></td></tr> <tr><td></td> <td>update  account set balance = 2000 where accountNo=1;</td></tr> <tr><td>select  * from account; /* 此时建立快照，1号余额已经为2000 */</td> <td></td></tr></tbody></table> <h5 id="_2、rr-下-快照建立时机-事务启动时"><a href="#_2、rr-下-快照建立时机-事务启动时" class="header-anchor">#</a> 2、RR 下，快照建立时机 - 事务启动时</h5> <p>如果希望事务启动时就建立快照，可以添加 with consistent snapshot 选项</p> <table><thead><tr><th><strong>tx1</strong></th> <th><strong>tx2</strong></th></tr></thead> <tbody><tr><td>set  session transaction isolation level repeatable read;</td> <td></td></tr> <tr><td>start  transaction with consistent snapshot; /* 此时建立快照，两个账户为 1000  */</td> <td></td></tr> <tr><td></td> <td>update  account set balance = 2000 where accountNo=1;</td></tr> <tr><td>select  * from account; /* 两个账户仍为 1000 */</td> <td></td></tr></tbody></table> <h5 id="_3、rr-下-快照建立时机-修改数据时"><a href="#_3、rr-下-快照建立时机-修改数据时" class="header-anchor">#</a> 3、RR 下，快照建立时机 - 修改数据时</h5> <table><thead><tr><th><strong>tx1</strong></th> <th><strong>tx2</strong></th></tr></thead> <tbody><tr><td>set  session transaction isolation level repeatable read;</td> <td></td></tr> <tr><td>start  transaction;</td> <td></td></tr> <tr><td>select  * from account; /* 此时建立快照，两个账户为 1000 */</td> <td></td></tr> <tr><td></td> <td>update  account set balance=balance+1000 where accountNo=1;</td></tr> <tr><td>update  account set balance=balance+1000 where accountNo=1;</td> <td></td></tr> <tr><td>select  * from account; /* 1号余额为3000 */</td> <td></td></tr></tbody></table> <ul><li>tx1 内的修改必须重新建立快照，否则，就会发生丢失更新的问题</li></ul> <h2 id="_3、innodb-vs-myisam"><a href="#_3、innodb-vs-myisam" class="header-anchor">#</a> 3、InnoDB vs MyISAM</h2> <h4 id="_1、innodb"><a href="#_1、innodb" class="header-anchor">#</a> 1、InnoDB</h4> <blockquote><ul><li><p>索引分为聚簇索引与二级索引</p> <ul><li>聚簇索引：主键值作为索引数据，叶子节点还包含了所有字段数据，索引和数据是存储在一起的</li> <li>二级索引：除主键外的其它字段建立的索引称为二级索引。被索引的字段值作为索引数据，叶子节点还包含了主键值</li></ul></li> <li><p>支持事务</p> <ul><li>通过 undo log 支持事务回滚、当前读（多版本查询）</li> <li>通过 redo log 实现持久性</li> <li>通过两阶段提交实现一致性</li> <li>通过当前读、锁实现隔离性</li></ul></li> <li><p>支持行锁、间隙锁</p></li> <li><p>支持外键</p></li></ul></blockquote> <p><strong>InnoDB 索引特点</strong></p> <p>聚簇索引：主键值作为索引数据，叶子节点还包含了所有字段数据，索引和数据是存储在一起的</p> <p><img src="/assets/img/image-20210901155308778.3ca6ec2f.png" alt="image-20210901155308778"></p> <ul><li>主键即 7369、7499、7521 等</li></ul> <p>二级索引：除主键外的其它字段建立的索引称为二级索引。被索引的字段值作为索引数据，叶子节点还包含了主键值</p> <p><img src="/assets/img/image-20210901155317460.5e9e106e.png" alt="image-20210901155317460"></p> <ul><li>上图中 800、950、1100 这些是工资字段的值，根据它们建立了二级索引</li></ul> <p><img src="/assets/img/image-20210901155327838.80dc4251.png" alt="image-20210901155327838"></p> <ul><li>上图中，如果执行查询 <code>select empno, ename, sal from emp where sal = 800</code>，这时候可以利用二级索引定位到 800 这个工资，同时还能知道主键值 7369</li> <li>但 select 字句中还出现了 ename 字段，在二级索引中不存在，因此需要根据主键值 7369 查询聚簇索引来获取 ename 的信息，这个过程俗称<strong>回表</strong></li></ul> <h4 id="_2、myisam"><a href="#_2、myisam" class="header-anchor">#</a> 2、MyISAM</h4> <blockquote><ul><li><p>索引只有一种</p> <ul><li>被索引字段值作为索引数据，叶子节点还包含了该记录数据页地址，数据和索引是分开存储的</li></ul></li> <li><p>不支持事务，没有 undo log 和 redo log</p></li> <li><p>仅支持表锁</p></li> <li><p>不支持外键</p></li> <li><p>会保存表的总行数</p></li></ul></blockquote> <p><strong>MyISAM 索引特点</strong></p> <p>被索引字段值作为索引数据，叶子节点还包含了该记录数据页地址，数据和索引是分开存储的</p> <p><img src="/assets/img/image-20210901155226621.b34d7bfa.png" alt="image-20210901155226621"></p> <h2 id="_4、查询语句执行流程"><a href="#_4、查询语句执行流程" class="header-anchor">#</a> 4、查询语句执行流程</h2> <p><strong>执行 SQL 语句 select * from user where id = 1 时发生了什么</strong></p> <p><img src="/assets/img/image-20210902082718756.5ba275bc.png" alt="image-20210902082718756"></p> <ol><li><p>连接器：负责建立连接、检查权限、连接超时时间由 wait_timeout 控制，默认 8 小时</p></li> <li><p>查询缓存：会将 SQL 和查询结果以键值对方式进行缓存，修改操作会以表单位导致缓存失效</p></li> <li><p>分析器：词法、语法分析</p></li> <li><p>优化器：决定用哪个索引，决定表的连接顺序等</p></li> <li><p>执行器：根据存储引擎类型，调用存储引擎接口</p></li> <li><p>存储引擎：数据的读写接口，索引、表都在此层实现</p></li></ol> <h2 id="_5、undo-log-与-redo-log"><a href="#_5、undo-log-与-redo-log" class="header-anchor">#</a> 5、undo log 与 redo log</h2> <h4 id="_1、undo-log"><a href="#_1、undo-log" class="header-anchor">#</a> 1、undo log</h4> <ul><li>回滚数据，以行为单位，记录数据每次的变更，一行记录有多个版本并存</li> <li>多版本并发控制，即快照读（也称为一致性读），让查询操作可以去访问历史版本</li></ul> <p><img src="/assets/img/image-20210902083051903.30d2a51b.png" alt="image-20210902083051903"></p> <ol><li>每个事务会按照开始时间，分配一个单调递增的事务编号 trx id</li> <li>每次事务的改动都会以行为单位记入回滚日志，包括当时的事务编号，改动的值等</li> <li>查询操作，事务编号大于自己的数据是不可见的，事务编号小于等于自己的数据才是可见的</li></ol> <ul><li>例如图中红色事务看不到 trx id=102 以及 trx id=101 的数据，只有 trx id=99 的数据对它可见</li></ul> <h4 id="_2、redo-log"><a href="#_2、redo-log" class="header-anchor">#</a> 2、redo log</h4> <p>redo log 的作用主要是实现 ACID 中的持久性，保证提交的数据不丢失</p> <ul><li>它记录了事务提交的变更操作，服务器意外宕机重启时，利用 redo log 进行回放，重新执行已提交的变更操作</li> <li>事务提交时，首先将变更写入 redo log，事务就视为成功。至于数据页（表、索引）上的变更，可以放在后面慢慢做
<ul><li>数据页上的变更宕机丢失也没事，因为 redo log 里已经记录了</li> <li>数据页在磁盘上位置随机，写入速度慢，redo log 的写入是顺序的速度快</li></ul></li></ul> <p>它由两部分组成，内存中的 redo log buffer，磁盘上的 redo log file</p> <ul><li>redo log file 由一组文件组成，当写满了会循环覆盖较旧的日志，这意味着不能无限依赖 redo log，更早的数据恢复需要 binlog</li> <li>buffer 和 file 两部分组成意味着，写入了文件才真正安全，同步策略由参数 innodb_flush_log_at_trx_commit  控制
<ul><li>0 - 每隔 1s 将日志 write and flush 到磁盘</li> <li>1 - 每次事务提交将日志 write and flush（默认值）</li> <li>2 - 每次事务提交将日志 write，每隔 1s flush 到磁盘，意味着 write 意味着写入操作系统缓存，如果 MySQL 挂了，而操作系统没挂，那么数据不会丢失</li></ul></li></ul> <h2 id="_6、mysql锁"><a href="#_6、mysql锁" class="header-anchor">#</a> 6、MySQL锁</h2> <h4 id="_1、全局锁"><a href="#_1、全局锁" class="header-anchor">#</a> 1、全局锁</h4> <p>用作全量备份时，保证<strong>表与表之间的数据一致性</strong></p> <p>如果不加任何包含，数据备份时就可能产生不一致的情况，如下图所示</p> <p><img src="/assets/img/image-20210902090302805.350b17e9.png" alt="image-20210902090302805"></p> <p>全局锁的语法：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>flush <span class="token keyword">tables</span> <span class="token keyword">with</span> <span class="token keyword">read</span> <span class="token keyword">lock</span><span class="token punctuation">;</span>	
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>使用全局读锁锁定所有数据库的所有表。这时会阻塞其它所有 DML 以及 DDL 操作，这样可以避免备份过程中的数据不一致。接下来可以执行备份，最后用 unlock tables 来解锁</li></ul> <blockquote><p><em><strong>注意</strong></em></p> <p>但 flush tables 属于比较重的操作，可以使用 --single-transaction 参数来完成不加锁的一致性备份（仅针对 InnoDB 引擎的表）</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysqldump <span class="token comment">--single-transaction -uroot -p test &gt; 1.sql</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></blockquote> <h4 id="_2、表级锁"><a href="#_2、表级锁" class="header-anchor">#</a> 2、表级锁</h4> <h5 id="_1、表锁"><a href="#_1、表锁" class="header-anchor">#</a> 1、表锁</h5> <blockquote><ul><li>语法：加锁 lock tables 表名 read/write，解锁 unlock tables</li> <li>缺点：粒度较粗，在 InnoDB 引擎很少使用</li></ul></blockquote> <h5 id="_2、-元数据锁"><a href="#_2、-元数据锁" class="header-anchor">#</a> 2、 元数据锁</h5> <blockquote><ul><li><p>即 metadata-lock（MDL），主要是为<strong>了避免 DML 与 DDL 冲突</strong>，DML 的元数据锁之间不互斥</p></li> <li><p>加元数据锁的几种情况</p> <ul><li><code>lock tables read/write</code>，类型为 SHARED_READ_ONLY 和 SHARED_NO_READ_WRITE</li> <li><code>alter table</code>，类型为 EXCLUSIVE，与其它 MDL 都互斥</li> <li><code>select，select … lock in share mode</code>，类型为 SHARED_READ</li> <li><code>insert，update，delete，select for update</code>，类型为 SHARED_WRITE</li></ul></li> <li><p>查看元数据锁（适用于 MySQL 8.0 以上版本）</p> <p><code>select object_type,object_schema,object_name,lock_type,lock_duration from performance_schema.metadata_locks;</code></p></li></ul></blockquote> <h5 id="_3、is-意向共享-与-ix-意向排他"><a href="#_3、is-意向共享-与-ix-意向排他" class="header-anchor">#</a> 3、IS（意向共享） 与 IX（意向排他）</h5> <ul><li>主要是<strong>避免 DML 与表锁冲突</strong>，DML 主要目的是加行锁，为了让表锁不用检查每行数据是否加锁，加意向锁（表级）来减少表锁的判断，意向锁之间不会互斥</li> <li>加意向表锁的几种情况
<ul><li><code>select … lock in share mode</code> 会加 IS 锁</li> <li><code>insert，update，delete， select … for update</code> 会加 IX 锁</li></ul></li> <li>查看意向表锁（适用于 MySQL 8.0 以上版本）
<ul><li>select object_schema,object_name,index_name,lock_type,lock_mode,lock_data from performance_schema.data_locks;</li></ul></li></ul> <h4 id="_3、行级锁"><a href="#_3、行级锁" class="header-anchor">#</a> 3、行级锁</h4> <ul><li><p>种类</p> <ul><li>行锁 – 在 RC 下，锁住的是行，防止其他事务对此行 update 或 delete</li> <li>间隙锁 – 在 RR 下，锁住的是间隙，防止其他事务在这个间隙 insert 产生幻读</li> <li>临键锁 – 在 RR 下，锁住的是前面间隙+行，特定条件下可优化为行锁</li></ul></li> <li><p>查看行级锁</p> <ul><li><code>select object_schema,object_name,index_name,lock_type,lock_mode,lock_data from performance_schema.data_locks where object_name='表名';</code></li></ul></li></ul> <blockquote><p><em><strong>注意</strong></em></p> <ul><li>它们锁定的其实都是<strong>索引</strong>上的行与间隙，根据索引的有序性来确定间隙</li></ul></blockquote> <p>测试数据</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> t <span class="token punctuation">(</span>id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span> name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>age <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'lisi'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'wangwu'</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'zhang'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token string">'zhang'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p><strong>说明</strong></p> <ul><li>1,2,3,4 之间其实并不可能有间隙</li> <li>4 与 8 之间有间隙</li> <li>8 与 12 之间有间隙</li> <li>12 与正无穷大之间有间隙</li> <li>其实我们的例子中还有负无穷大与 1 之间的间隙，想避免负数可以通过建表时选择数据类型为 unsigned int</li></ul></blockquote> <p>间隙锁例子</p> <p>事务1：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">9</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span> <span class="token comment">/* 锁住的是 8 与 12 之间的间隙 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>事务2：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">/* 不会阻塞 */</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">/* 不会阻塞 */</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'aaa'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 会阻塞 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>临键锁和记录锁例子</p> <p>事务1：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t <span class="token keyword">where</span> id <span class="token operator">&gt;=</span> <span class="token number">8</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>临键锁锁定的是左开右闭的区间，与上条查询条件相关的区间有 (4,8]，(8,12]，(12,+∞)</li> <li>临键锁在某些条件下可以被优化为记录锁，例如 (4,8] 被优化为只针对 8 的记录锁，前面的区间不会锁住</li></ul> <p>事务2：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">'aaa'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 不会阻塞 */</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">/* 会阻塞 */</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'aaa'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 会阻塞 */</span>
<span class="token keyword">update</span> t <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">100</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span> <span class="token comment">/* 会阻塞 */</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token string">'aaa'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 会阻塞 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022-10-23</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/interview/database/MySQL.html" class="prev">
        MySQL
      </a></span> <span class="next"><a href="/interview/framework/Spring.html">
        Spring
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div id="goTop" class="hide-cat" data-v-bf92849a></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/assets/js/app.9fae93c2.js" defer></script><script src="/assets/js/8.6de2748b.js" defer></script><script src="/assets/js/18.b9c6dd45.js" defer></script>
  </body>
</html>
