<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1、redis简介 | 小熊学Java</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="./xiaobear.ico">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?c1b38aee20eeeb56adb65146a17e0b47";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
        </script>
    <meta name="description" content="放弃很容易，但坚持一定很酷！">
    <meta name="baidu-site-verification" content="code-FVmKyJMz00">
    <meta name="360-site-verification" content="b9b356af59f019380844a85d5b887d22">
    
    <link rel="preload" href="/assets/css/0.styles.f5efb75f.css" as="style"><link rel="preload" href="/assets/js/app.9fae93c2.js" as="script"><link rel="preload" href="/assets/js/8.6de2748b.js" as="script"><link rel="preload" href="/assets/js/5.3fa9fdce.js" as="script"><link rel="prefetch" href="/assets/js/10.1e7a1022.js"><link rel="prefetch" href="/assets/js/11.14eba8f6.js"><link rel="prefetch" href="/assets/js/12.ee089ac5.js"><link rel="prefetch" href="/assets/js/13.14a6f585.js"><link rel="prefetch" href="/assets/js/14.262ed780.js"><link rel="prefetch" href="/assets/js/15.9de44e9e.js"><link rel="prefetch" href="/assets/js/16.f5a6bfd8.js"><link rel="prefetch" href="/assets/js/17.39e7febc.js"><link rel="prefetch" href="/assets/js/18.b9c6dd45.js"><link rel="prefetch" href="/assets/js/19.4019bc23.js"><link rel="prefetch" href="/assets/js/2.8ab847ea.js"><link rel="prefetch" href="/assets/js/20.7dba5cb1.js"><link rel="prefetch" href="/assets/js/21.88b21250.js"><link rel="prefetch" href="/assets/js/22.4b706d27.js"><link rel="prefetch" href="/assets/js/23.226347b2.js"><link rel="prefetch" href="/assets/js/24.71326735.js"><link rel="prefetch" href="/assets/js/25.69884879.js"><link rel="prefetch" href="/assets/js/26.3e008d08.js"><link rel="prefetch" href="/assets/js/27.bd9e99da.js"><link rel="prefetch" href="/assets/js/28.4d9fa21f.js"><link rel="prefetch" href="/assets/js/29.f9724161.js"><link rel="prefetch" href="/assets/js/3.34476678.js"><link rel="prefetch" href="/assets/js/30.30c1f3ff.js"><link rel="prefetch" href="/assets/js/31.b09048ee.js"><link rel="prefetch" href="/assets/js/32.a8554058.js"><link rel="prefetch" href="/assets/js/33.a5110493.js"><link rel="prefetch" href="/assets/js/34.2b9786c3.js"><link rel="prefetch" href="/assets/js/35.5728728f.js"><link rel="prefetch" href="/assets/js/36.03c75877.js"><link rel="prefetch" href="/assets/js/37.c51f58e0.js"><link rel="prefetch" href="/assets/js/38.43ffcaca.js"><link rel="prefetch" href="/assets/js/39.5c3642cf.js"><link rel="prefetch" href="/assets/js/4.c9105f19.js"><link rel="prefetch" href="/assets/js/40.0bd5fb5d.js"><link rel="prefetch" href="/assets/js/41.c5d82cf9.js"><link rel="prefetch" href="/assets/js/42.ca15b1f4.js"><link rel="prefetch" href="/assets/js/43.99507c47.js"><link rel="prefetch" href="/assets/js/44.ec6c0574.js"><link rel="prefetch" href="/assets/js/45.23ad772b.js"><link rel="prefetch" href="/assets/js/46.876d924a.js"><link rel="prefetch" href="/assets/js/47.78c8581c.js"><link rel="prefetch" href="/assets/js/48.6dd683f3.js"><link rel="prefetch" href="/assets/js/49.8bacc727.js"><link rel="prefetch" href="/assets/js/50.87de12f2.js"><link rel="prefetch" href="/assets/js/51.bcf83bdd.js"><link rel="prefetch" href="/assets/js/52.9030e5a8.js"><link rel="prefetch" href="/assets/js/53.7329a1c0.js"><link rel="prefetch" href="/assets/js/54.3df55bdf.js"><link rel="prefetch" href="/assets/js/55.440988ee.js"><link rel="prefetch" href="/assets/js/56.6feee735.js"><link rel="prefetch" href="/assets/js/57.39b0d6e1.js"><link rel="prefetch" href="/assets/js/58.ae18f65a.js"><link rel="prefetch" href="/assets/js/59.1d4da83d.js"><link rel="prefetch" href="/assets/js/6.13af6b79.js"><link rel="prefetch" href="/assets/js/60.62f64e9d.js"><link rel="prefetch" href="/assets/js/61.4e7c0e3e.js"><link rel="prefetch" href="/assets/js/62.fd1fd9ee.js"><link rel="prefetch" href="/assets/js/63.dbefdbfc.js"><link rel="prefetch" href="/assets/js/64.e76fce52.js"><link rel="prefetch" href="/assets/js/65.79c28e3c.js"><link rel="prefetch" href="/assets/js/66.65b14369.js"><link rel="prefetch" href="/assets/js/67.dedfa5bb.js"><link rel="prefetch" href="/assets/js/68.782b701b.js"><link rel="prefetch" href="/assets/js/69.7b228322.js"><link rel="prefetch" href="/assets/js/7.091c60c8.js"><link rel="prefetch" href="/assets/js/70.4095ca82.js"><link rel="prefetch" href="/assets/js/71.9e859f7d.js"><link rel="prefetch" href="/assets/js/72.09b45fd2.js"><link rel="prefetch" href="/assets/js/73.04728c96.js"><link rel="prefetch" href="/assets/js/74.130ba569.js"><link rel="prefetch" href="/assets/js/75.513060c3.js"><link rel="prefetch" href="/assets/js/76.83087703.js"><link rel="prefetch" href="/assets/js/77.9f1f552a.js"><link rel="prefetch" href="/assets/js/78.e1ef8d5b.js"><link rel="prefetch" href="/assets/js/79.8e1e7a5f.js"><link rel="prefetch" href="/assets/js/9.b275c17b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f5efb75f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小熊学Java</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  🏠首页
</a></div><div class="nav-item"><a href="/brush/" class="nav-link">
  📝码不停题
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  💸面试专栏
</a></div><div class="nav-item"><a href="/install/" class="nav-link">
  📖安装教程
</a></div><div class="nav-item"><a href="/notes/" class="nav-link router-link-active">
  📓学习笔记
</a></div><div class="nav-item"><a href="/architecture/" class="nav-link">
  🛠架构设计
</a></div><div class="nav-item"><a href="/about/me.html" class="nav-link">
  👨‍关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  🏠首页
</a></div><div class="nav-item"><a href="/brush/" class="nav-link">
  📝码不停题
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  💸面试专栏
</a></div><div class="nav-item"><a href="/install/" class="nav-link">
  📖安装教程
</a></div><div class="nav-item"><a href="/notes/" class="nav-link router-link-active">
  📓学习笔记
</a></div><div class="nav-item"><a href="/architecture/" class="nav-link">
  🛠架构设计
</a></div><div class="nav-item"><a href="/about/me.html" class="nav-link">
  👨‍关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开发工具篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/devTools/GitNote.html" class="sidebar-link">Git</a></li><li><a href="/notes/devTools/Linux.html" class="sidebar-link">Linux常用命令</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/basic/features.html" class="sidebar-link">Java 8新特性</a></li><li><a href="/notes/basic/dataAndAlgorithm.html" class="sidebar-link">数据结构与算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>数据库篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/database/MySQL.html" class="sidebar-link">MySQL</a></li><li><a href="/notes/frame/RedisNote.html" aria-current="page" class="active sidebar-link">Redis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、redis简介" class="sidebar-link">1、redis简介</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、linux安装" class="sidebar-link">2、linux安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、下载" class="sidebar-link">1、下载</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、安装" class="sidebar-link">2、安装</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、启动服务端跟客户端" class="sidebar-link">3、启动服务端跟客户端</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_4、关闭" class="sidebar-link">4、关闭</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_5、docker安装redis" class="sidebar-link">5、docker安装redis</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、redis配置" class="sidebar-link">3、redis配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、redis-conf" class="sidebar-link">1、redis.conf</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、内存维护策略-缓存清理策略" class="sidebar-link">2、内存维护策略（缓存清理策略）</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_4、redis基本操作" class="sidebar-link">4、Redis基本操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、数据库" class="sidebar-link">1、数据库</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、key" class="sidebar-link">2、Key</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、string" class="sidebar-link">3、String</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_4、list" class="sidebar-link">4、List</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_5、set" class="sidebar-link">5、Set</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_6、hash" class="sidebar-link">6、Hash</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_7、zset" class="sidebar-link">7、Zset</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_8、hyperloglog" class="sidebar-link">8、HyperLogLog</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_9、redis发布订阅" class="sidebar-link">9、redis发布订阅</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_5、持久化" class="sidebar-link">5、持久化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、rdb" class="sidebar-link">1、RDB</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、aof" class="sidebar-link">2、AOF</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、备份建议" class="sidebar-link">3、备份建议</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_6、事务" class="sidebar-link">6、事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、事务简介" class="sidebar-link">1、事务简介</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、常用命令" class="sidebar-link">2、常用命令</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、错误命令处理" class="sidebar-link">3、错误命令处理</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_4、锁" class="sidebar-link">4、锁</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_5、redis-中的锁策略" class="sidebar-link">5、Redis 中的锁策略</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_7、redis-cluste集群" class="sidebar-link">7、Redis Cluste集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、搭建集群环境" class="sidebar-link">1、搭建集群环境</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、集群验证" class="sidebar-link">2、集群验证</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、集群开启与关闭" class="sidebar-link">3、集群开启与关闭</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_4、集群中故障恢复" class="sidebar-link">4、集群中故障恢复</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_5、集群的优缺点" class="sidebar-link">5、集群的优缺点</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_8、windows安装redis" class="sidebar-link">8、windows安装Redis</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_9、redis实战" class="sidebar-link">9、Redis实战</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、短信登录" class="sidebar-link">1、短信登录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、流程讲解" class="sidebar-link">1、流程讲解</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、基于session实现登录" class="sidebar-link">2、基于Session实现登录</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、集群的session共享问题" class="sidebar-link">3、集群的session共享问题</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_4、基于redis实现共享session登录" class="sidebar-link">4、基于Redis实现共享session登录</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、查询缓存" class="sidebar-link">2、查询缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、什么是缓存" class="sidebar-link">1、什么是缓存</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、添加redis缓存" class="sidebar-link">2、添加Redis缓存</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、缓存更新策略" class="sidebar-link">3、缓存更新策略</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_4、缓存穿透" class="sidebar-link">4、缓存穿透</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_5、缓存雪崩" class="sidebar-link">5、缓存雪崩</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_6、缓存击穿" class="sidebar-link">6、缓存击穿</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_7、缓存工具封装" class="sidebar-link">7、缓存工具封装</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、优惠券秒杀" class="sidebar-link">3、优惠券秒杀</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、全局唯一id" class="sidebar-link">1、全局唯一ID</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、实现优惠券秒杀下单" class="sidebar-link">2、实现优惠券秒杀下单</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、超卖问题" class="sidebar-link">3、超卖问题</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_4、一人一单" class="sidebar-link">4、一人一单</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_5、分布式锁" class="sidebar-link">5、分布式锁</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_6、redis优化秒杀" class="sidebar-link">6、Redis优化秒杀</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_7、redis消息队列实现异步秒杀" class="sidebar-link">7、Redis消息队列实现异步秒杀</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_4、达人探店" class="sidebar-link">4、达人探店</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、发布探店笔记" class="sidebar-link">1、发布探店笔记</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、点赞" class="sidebar-link">2、点赞</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、点赞排行榜" class="sidebar-link">3、点赞排行榜</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_5、好友关注" class="sidebar-link">5、好友关注</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、关注和取关" class="sidebar-link">1、关注和取关</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、共同关注" class="sidebar-link">2、共同关注</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、关注推送" class="sidebar-link">3、关注推送</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_6、附近商户" class="sidebar-link">6、附近商户</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、geo数据结构" class="sidebar-link">1、GEO数据结构</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、附近商户搜索" class="sidebar-link">2、附近商户搜索</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_7、用户签到" class="sidebar-link">7、用户签到</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、bitmap用法" class="sidebar-link">1、BitMap用法</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、签到功能" class="sidebar-link">2、签到功能</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、签到统计" class="sidebar-link">3、签到统计</a></li></ul></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_8、uv统计" class="sidebar-link">8、UV统计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_1、hyperloglog用法" class="sidebar-link">1、HyperLogLog用法</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_2、实现uv统计" class="sidebar-link">2、实现UV统计</a></li><li class="sidebar-sub-header"><a href="/notes/frame/RedisNote.html#_3、总结-3" class="sidebar-link">3、总结</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>框架篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/frame/JavaWebNote.html" class="sidebar-link">Java Web</a></li><li><a href="/notes/frame/SpringMVCNote.html" class="sidebar-link">Spring MVC</a></li><li><a href="/notes/frame/MybatisNote.html" class="sidebar-link">Mybatis</a></li><li><a href="/notes/frame/MybatisPlusNote.html" class="sidebar-link">Mybatis-plus</a></li><li><a href="/notes/frame/SpringBootNote.html" class="sidebar-link">Spring Boot</a></li><li><a href="/notes/frame/SpringCloudNote.html" class="sidebar-link">Spring Cloud</a></li><li><a href="/notes/frame/Docker.html" class="sidebar-link">Docker</a></li><li><a href="/notes/frame/RabbitMQ.html" class="sidebar-link">RabbitMQ</a></li><li><a href="/notes/frame/Elasticsearch.html" class="sidebar-link">Elasticsearch</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>组件篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/components/CAT.html" class="sidebar-link">CAT链路追踪</a></li><li><a href="/notes/components/HATEOAS.html" class="sidebar-link">HATEOAS</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1、redis简介"><a href="#_1、redis简介" class="header-anchor">#</a> 1、redis简介</h2> <blockquote><p><strong>Redis</strong>是一个使用<a href="https://zh.wikipedia.org/wiki/ANSI_C" target="_blank" rel="noopener noreferrer">ANSI C<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>编写的<a href="https://zh.wikipedia.org/wiki/%E5%BC%80%E6%BA%90" target="_blank" rel="noopener noreferrer">开源<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、支持<a href="https://zh.wikipedia.org/wiki/%E7%94%B5%E8%84%91%E7%BD%91%E7%BB%9C" target="_blank" rel="noopener noreferrer">网络<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、基于<a href="https://zh.wikipedia.org/wiki/%E5%86%85%E5%AD%98" target="_blank" rel="noopener noreferrer">内存<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、可选<a href="https://zh.wikipedia.org/w/index.php?title=%E6%8C%81%E4%B9%85%E6%80%A7_(%E6%95%B0%E6%8D%AE%E5%BA%93)&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener noreferrer">持久性<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的[键值对存储数据库]</p> <p>它通常被称为数据结构服务器，因为值（value）可以是 字符串(String), 哈希(Hash), 列表(list), 集合(sets) 和 有序集合(sorted sets)等类型。</p></blockquote> <h2 id="_2、linux安装"><a href="#_2、linux安装" class="header-anchor">#</a> 2、linux安装</h2> <h3 id="_1、下载"><a href="#_1、下载" class="header-anchor">#</a> 1、下载</h3> <ul><li><p>在线下载</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>$ wget http<span class="token operator">:</span><span class="token comment">//download.redis.io/releases/redis-5.0.7.tar.gz</span>
$ tar xzf redis<span class="token operator">-</span><span class="token number">5.0</span><span class="token number">.7</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz <span class="token operator">-</span>C <span class="token operator">/</span>root<span class="token operator">/</span>tool <span class="token comment">//解压到指定目录</span>
$ cd redis<span class="token operator">-</span><span class="token number">5.0</span><span class="token number">.7</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
$ make
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>利用ftp等软件上传至Linux桌面</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>$ tar xzf redis<span class="token operator">-</span><span class="token number">5.0</span><span class="token number">.7</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
$ cd redis<span class="token operator">-</span><span class="token number">5.0</span><span class="token number">.7</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
$ make
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>**注：**我们需要将源码编译后再安装，因此需要安装 c 语言的编译环境！不能直接 make</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>yum install gcc<span class="token operator">-</span>c<span class="token operator">++</span> <span class="token operator">-</span>y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>==make时遇到的错误：==</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>In file included from adlist<span class="token punctuation">.</span>c<span class="token operator">:</span><span class="token number">34</span><span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span>
zmalloc<span class="token punctuation">.</span>h<span class="token operator">:</span><span class="token number">50</span><span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span> fatal error<span class="token operator">:</span> jemalloc<span class="token operator">/</span>jemalloc<span class="token punctuation">.</span>h<span class="token operator">:</span> No such file or directory
 <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jemalloc/jemalloc.h&gt;</span></span>
                               <span class="token operator">^</span>
compilation terminated<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>解决办法：==make MALLOC=libc==</strong></p></li></ul> <h3 id="_2、安装"><a href="#_2、安装" class="header-anchor">#</a> 2、安装</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code>make PREFIX<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>redis instal
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装到指定目录，若没有，则创建该目录；PREFIX必须大写</p> <h3 id="_3、启动服务端跟客户端"><a href="#_3、启动服务端跟客户端" class="header-anchor">#</a> 3、启动服务端跟客户端</h3> <p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/20200401214417.png" alt=""></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token punctuation">.</span><span class="token operator">/</span>redis<span class="token operator">-</span>server
<span class="token punctuation">.</span><span class="token operator">/</span>redis<span class="token operator">-</span>cli
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Redis服务器默认会使用6379端口1) , 通过－－port参数可以自定义端口号：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>redis<span class="token operator">-</span>server <span class="token operator">--</span>port <span class="token number">6380</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_4、关闭"><a href="#_4、关闭" class="header-anchor">#</a> 4、关闭</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code>shutdown
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_5、docker安装redis"><a href="#_5、docker安装redis" class="header-anchor">#</a> 5、docker安装redis</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code>docker search redis        <span class="token comment">//命令来查看可用版本</span>
    
docker pull redis<span class="token operator">:</span>latest   <span class="token comment">//拉取官方的最新版本的镜像</span>
    
docker images              <span class="token comment">//查看镜像</span>
 
docker run <span class="token operator">-</span>d <span class="token operator">--</span>name redis<span class="token operator">-</span>test <span class="token operator">-</span>p <span class="token number">6379</span><span class="token operator">:</span><span class="token number">6379</span> redis <span class="token operator">--</span>requirepass <span class="token string">&quot;密码&quot;</span><span class="token comment">//创建并运行容器</span>
  <span class="token comment">//  --requirepass 密码 -d: 后台运行容器，并返回容器ID；</span>
docker exec <span class="token operator">-</span>it redis redis<span class="token operator">-</span>cli <span class="token operator">-</span>a 密码            <span class="token comment">//运行客户端 --it 交互</span>
 
<span class="token comment">/*docker常用命令
1、docker ps 查看进程
2、docker container rm 删除容器
https://www.runoob.com/docker/docker-command-manual.html
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="_3、redis配置"><a href="#_3、redis配置" class="header-anchor">#</a> 3、redis配置</h2> <h3 id="_1、redis-conf"><a href="#_1、redis-conf" class="header-anchor">#</a> 1、redis.conf</h3> <h3 id="_2、内存维护策略-缓存清理策略"><a href="#_2、内存维护策略-缓存清理策略" class="header-anchor">#</a> 2、内存维护策略（缓存清理策略）</h3> <ol><li><table><thead><tr><th style="text-align:left;">属性</th> <th style="text-align:center;">含义</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;">bind</td> <td style="text-align:center;">限定访问的主机地</td> <td style="text-align:left;">如果没有bind，就是任意ip 地址都可以访问。生产环境下，需要写自己应用服务器的ip 地址。</td></tr> <tr><td style="text-align:left;">protected-mode</td> <td style="text-align:center;">安全防护模式</td> <td style="text-align:left;">如果没有指定bind 指令，也没有配置密码，那么保护模式就开启，只允许本机访问。</td></tr> <tr><td style="text-align:left;">port</td> <td style="text-align:center;">端口号</td> <td style="text-align:left;">默认是6379</td></tr> <tr><td style="text-align:left;">timeout</td> <td style="text-align:center;">超时时间</td> <td style="text-align:left;">默认永不超时</td></tr> <tr><td style="text-align:left;">daemonize</td> <td style="text-align:center;">是否为守护进程模式运行</td> <td style="text-align:left;">守护进程模式可以在后台运行，默认是no</td></tr> <tr><td style="text-align:left;">pidfile</td> <td style="text-align:center;">进程id 文件保存的路径</td> <td style="text-align:left;">配置PID 文件路径，当redis 作为守护进程运行的时候，它会把pid默认写到/var/redis/run/redis_6379.pid 文件里面</td></tr> <tr><td style="text-align:left;">logfile</td> <td style="text-align:center;">日志文件的位置</td> <td style="text-align:left;">当指定为空字符串时，为标准输出，如果redis 以守护进程模式运行，那么日志将会输出到/dev/null</td></tr> <tr><td style="text-align:left;">databases</td> <td style="text-align:center;">设置数据库数量</td> <td style="text-align:left;">默认是0</td></tr> <tr><td style="text-align:left;">requirepass</td> <td style="text-align:center;">设置密码</td> <td style="text-align:left;">默认没有，但远程连接可能会连接不上</td></tr> <tr><td style="text-align:left;">maxclients</td> <td style="text-align:center;">最大连接数</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">maxmemory</td> <td style="text-align:center;">最大占用多少内存</td> <td style="text-align:left;">一旦占用内存超限，就开始根据缓存清理策略移除数据如果Redis无法根据移除规则来移除内存中的数据，或者设置了“不允许移除”，那么Redis 则会针对那些需要申请内存的指令返回错误信息，比如SET、LPUSH 等。</td></tr> <tr><td style="text-align:left;"><strong>maxmemory-policy noeviction</strong></td> <td style="text-align:center;"><strong>缓存清理策略</strong></td> <td style="text-align:left;"><strong>（1）volatile-lru：使用LRU 算法移除key，只对设置了过期时间的键<br>（2）allkeys-lru：使用LRU 算法移除key<br>（3）volatile-random：在过期集合中移除随机的key，只对设置了过期时间的键<br>（4）allkeys-random：移除随机的key<br>（5）volatile-ttl：移除那些TTL 值最小的key，即那些最近要过期的key<br>（6）noeviction：不进行移除。针对写操作，只是返回错误信息</strong></td></tr></tbody></table></li></ol> <h2 id="_4、redis基本操作"><a href="#_4、redis基本操作" class="header-anchor">#</a> 4、Redis基本操作</h2> <h3 id="_1、数据库"><a href="#_1、数据库" class="header-anchor">#</a> 1、数据库</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code>select <span class="token operator">&lt;</span>dbid<span class="token operator">&gt;</span>  <span class="token comment">//切换数据库 select 1 切换到1号数据库，默认为0</span>
flushdb        <span class="token comment">//清空当前库</span>
dbsize         <span class="token comment">//查看数据库个数</span>
flushall       <span class="token comment">//通杀全部库</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2、key"><a href="#_2、key" class="header-anchor">#</a> 2、Key</h3> <p>Redis 中的数据以<strong>键值对（key-value）<strong>为基本存储方式，其中</strong>key 都是字符串</strong>。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>KEYS pattern   <span class="token comment">//查询符合指定表达式的所有key，支持*，？等</span>
TYPE key       <span class="token comment">//查看key 对应值的类型</span>
EXISTS key     <span class="token comment">//指定的key 是否存在，0 代表不存在，1 代表存在</span>
DEL key       <span class="token comment">//删除指定key</span>
RANDOMKEY     <span class="token comment">//在现有的KEY 中随机返回一个</span>
EXPIRE key seconds   <span class="token comment">//为键值设置过期时间，单位是秒，过期后key 会被redis 移除</span>
TTL key       <span class="token comment">//查看key 还有多少秒过期，-1 表示永不过期，-2 表示已过期</span>
RENAME key newkey
<span class="token comment">//重命名一个key，NEWKEY 不管是否是已经存在的都会执行，如果NEWKEY 已经存在则会被覆盖</span>
RENAMENX key newkey  <span class="token comment">//只有在NEWKEY 不存在时能够执行成功，否则失败</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200404225335437.png" alt="image-20200404225335437"></p> <h3 id="_3、string"><a href="#_3、string" class="header-anchor">#</a> 3、String</h3> <p>String 类型是Redis 中最基本的类型，它是key 对应的一个单一值。</p> <p>二进制安全，不必担心由于编码等问题导致二进制数据变化。所以redis 的string 可以包含任何数据，比如jpg</p> <p>图片或者序列化的对象。Redis 中一个字符串值的最大容量是512M。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>SET key value              <span class="token comment">//添加键值对</span>
GET key                    <span class="token comment">//查询指定key 的值</span>
APPEND key value           <span class="token comment">//将给定的value 追加到原值的末尾</span>
STRLEN key                <span class="token comment">//获取值的长度</span>
SETNX key value           <span class="token comment">//只有在key 不存在时设置key 的值</span>
INCR key                  <span class="token comment">//指定key 的值自增1，只对数字有效</span>
DECR key                  <span class="token comment">//指定key 的值自减1，只对数字有效</span>
INCRBY key num            <span class="token comment">//自增num</span>
DECRBY key num            <span class="token comment">//自减num</span>
MSET key1 value1 key2 value2…    <span class="token comment">//同时设置多个key-value 对</span>
MGET key1 key2            <span class="token comment">//同时获取一个或多个value</span>
MSETNX key1 value1 key2 value2   <span class="token comment">//当key 不存在时，设置多个key-value 对</span>
GETRANGE key 起始索引 结束索       <span class="token comment">//获取指定范围的值，都是闭区间</span>
SETRANGE key 起始索引value        <span class="token comment">//从起始位置开始覆写指定的值</span>
GETSET key value                 <span class="token comment">//以新换旧，同时获取旧值</span>
SETEX key 过期时间value           <span class="token comment">//设置键值的同时，设置过期时间，单位秒</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200404230347984.png" alt="image-20200404230347984"></p> <h3 id="_4、list"><a href="#_4、list" class="header-anchor">#</a> 4、List</h3> <p>Redis列表是简单的字符串列表，按照插入<strong>顺序排序</strong>。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。一个列表最多可以包含 232 - 1 个元素 (4294967295, 每个列表超过40亿个元素)</p> <p>常见操作：</p> <p><strong>遍历：遍历的时候，是从左往右取值；</strong></p> <p><strong>删除：弹栈，POP；</strong></p> <p><strong>添加：压栈，PUSH ；</strong></p> <p>它的底层实际是个<strong>双向链表</strong>，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>LPUSH<span class="token operator">/</span>RPUSH key value1 value2…  <span class="token comment">//从左边/右边压入一个或多个值,头尾效率高，中间效率低</span>
LPOP<span class="token operator">/</span>RPOP key                   <span class="token comment">//从左边/右边弹出一个值,值在键在，值光键亡,弹出=返回+删除</span>
LRANGE key start stop          <span class="token comment">//查看指定区间的元素,正着数：0,1,2,3,...倒着数：-1,-2,-3,...</span>
LINDEX key index              <span class="token comment">//按照索引下标获取元素（从左到右）</span>
LLEN key                      <span class="token comment">//获取列表长度</span>
LINSERT key BEFORE<span class="token operator">|</span>AFTER value newvalue <span class="token comment">//在指定value 的前后插入newvalue</span>
LREM key n value             <span class="token comment">//从左边删除n 个value</span>
LSET key index value         <span class="token comment">//把指定索引位置的元素替换为另一个值</span>
LTRIM key start stop         <span class="token comment">//仅保留指定区间的数据</span>
RPOPLPUSH key1 key2         <span class="token comment">//从key1 右边弹出一个值，左侧压入到key2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200405152307205.png" alt="image-20200405152307205"></p> <h3 id="_5、set"><a href="#_5、set" class="header-anchor">#</a> 5、Set</h3> <h6 id="set-是无序的-且是不可重复的。"><a href="#set-是无序的-且是不可重复的。" class="header-anchor">#</a> ==set 是无序的，且是不可重复的。==</h6> <div class="language-c line-numbers-mode"><pre class="language-c"><code>SADD key member <span class="token punctuation">[</span>member <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> 
<span class="token comment">//将一个或多个member 元素加入到集合key 当中，已经存在于集合的member 元素将被忽略。</span>
SMEMBERS key                     <span class="token comment">//取出该集合的所有值</span>
SISMEMBER key value              <span class="token comment">//判断集合&lt;key&gt;是否为含有该&lt;value&gt;值，有返回1，没有返回0</span>
SCARD key                        <span class="token comment">//返回集合中元素的数量</span>
SREM key member <span class="token punctuation">[</span>member <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>    <span class="token comment">//从集合中删除元素</span>
SPOP key <span class="token punctuation">[</span>count<span class="token punctuation">]</span>                <span class="token comment">//从集合中随机弹出count 个数量的元素，count 不指定就弹出1 个</span>
SRANDMEMBER key <span class="token punctuation">[</span>count<span class="token punctuation">]</span>         <span class="token comment">//从集合中随机返回count 个数量的元素，count 不指定就返回1 个</span>
SINTER key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>            <span class="token comment">//将指定的集合进行“交集”操作</span>
SINTERSTORE dest key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>  <span class="token comment">//取交集，另存为一个set</span>
SUNION key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>             <span class="token comment">//将指定的集合执行“并集”操作</span>
SUNIONSTORE dest key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>  <span class="token comment">//取并集，另存为set</span>
SDIFF key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>             <span class="token comment">//将指定的集合执行“差集”操作</span>
SDIFFSTORE dest key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>  <span class="token comment">//取差集，另存为set</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200405153111672.png" alt="image-20200405153111672"></p> <h3 id="_6、hash"><a href="#_6、hash" class="header-anchor">#</a> 6、Hash</h3> <p>Hash 数据类型的键值对中的值是“单列”的，不支持进一步的层次结构。hash 特别适合用于<strong>存储对象</strong>。</p> <p>Redis 中每个 hash 可以存储 232 - 1 键值对（40多亿）。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//从前到后的数据对应关系</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;yhx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code>HSET key field value                          <span class="token comment">//为key 中的field 赋值value</span>
HMSET key field value <span class="token punctuation">[</span>field value <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>       <span class="token comment">//为指定key 批量设置field-value</span>
HSETNX key field value                        <span class="token comment">//当指定key 的field 不存在时，设置其value</span>
HGETALL key                                   <span class="token comment">//获取指定key 的所有信息（field 和value）</span>
HKEYS key                                     <span class="token comment">//获取指定key 的所有field</span>
HVALS key                                     <span class="token comment">//获取指定key 的所有value</span>
HLEN key                                     <span class="token comment">//指定key 的field 个数</span>
HGET key field                               <span class="token comment">//从key 中根据field 取出value</span>
HMGET key field <span class="token punctuation">[</span>field <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>                  <span class="token comment">//为指定key 获取多个filed 的值</span>
HEXISTS key field                            <span class="token comment">//指定key 是否有field</span>
HINCRBY key field increment                  <span class="token comment">//为指定key 的field 加上增量increment</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200405154227541.png" alt="image-20200405154227541"></p> <h3 id="_7、zset"><a href="#_7、zset" class="header-anchor">#</a> 7、Zset</h3> <p>zset 是一种特殊的set（sorted set），在保存value 的时候，为每个value 多保存了一个score 信息。根据score
信息，可以进行排序。</p> <p>这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。集合的成员是唯一的，但是评分可
以是重复了</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>ZADD key <span class="token punctuation">[</span>score member <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>               <span class="token comment">//添加</span>
ZSCORE key member                        <span class="token comment">//返回指定值的分数</span>
ZRANGE key start stop <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span>      <span class="token comment">//返回指定区间的值，可选择是否一起返回scores</span>
ZRANGEBYSCORE key min max <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span><span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span>
<span class="token comment">//在分数的指定区间内返回数据，从小到大排列</span>
ZREVRANGEBYSCORE key max min<span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span>
<span class="token comment">//在分数的指定区间内返回数据，从大到小排列</span>
ZCARD key                               <span class="token comment">//返回集合中所有的元素的数量</span>
ZCOUNT key min max                      <span class="token comment">//统计分数区间内的元素个数</span>
ZREM key member                        <span class="token comment">//删除该集合下，指定值的元素</span>
ZRANK key member                       <span class="token comment">//返回该值在集合中的排名，从0 开始</span>
ZINCRBY key increment value            <span class="token comment">//为元素的score 加上增量</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200405154822259.png" alt="image-20200405154822259"></p> <h3 id="_8、hyperloglog"><a href="#_8、hyperloglog" class="header-anchor">#</a> 8、HyperLogLog</h3> <p>Redis 在 <strong>2.8.9 版本添加了 HyperLogLog 结构</strong>。</p> <p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，==在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定 的、并且是很小的。==</p> <p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基 数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p> <p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p> <h5 id="什么是基数"><a href="#什么是基数" class="header-anchor">#</a> 什么是基数?</h5> <p>比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8}, 基数(不重复元素)为5。 基数估计就是</p> <p>在误差可接受的范围内，快速计算基数。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>PFADD key element <span class="token punctuation">[</span>element <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>               <span class="token comment">//添加指定元素到 HyperLogLog 中。</span>
PFCOUNT key <span class="token punctuation">[</span>key <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>                         <span class="token comment">//返回给定 HyperLogLog 的基数估算值。</span>
PFMERGE destkey sourcekey <span class="token punctuation">[</span>sourcekey <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>     <span class="token comment">//将多个 HyperLogLog 合并为一个 HyperLogLog</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200405155752941.png" alt="image-20200405155752941"></p> <h5 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h5> <ul><li>统计注册ip数</li> <li>统计每日访问IP数</li> <li>统计页面实时uv数</li> <li>统计在线用户数</li> <li>统计用户每天搜索不同词条的个数</li> <li>统计真实文章阅读数</li></ul> <h3 id="_9、redis发布订阅"><a href="#_9、redis发布订阅" class="header-anchor">#</a> 9、redis发布订阅</h3> <p>Redis 发布订阅(pub/sub)是一种消息通信模式：发送者(pub)发送消息，订阅者(sub)接收消息。</p> <p>Redis 客户端可以订阅任意数量的频道。</p> <p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200406201522100.png" alt=""></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>SUBSCRIBE channel <span class="token punctuation">[</span>channel <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>            <span class="token comment">//订阅给定的一个或多个频道的信息。</span>
PUBLISH channel message                    <span class="token comment">//将信息发送到指定的频道。</span>
PUBSUB subcommand <span class="token punctuation">[</span>argument <span class="token punctuation">[</span>argument <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token comment">//查看订阅与发布系统状态。</span>
PSUBSCRIBE pattern <span class="token punctuation">[</span>pattern <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>           <span class="token comment">//订阅一个或多个符合给定模式的频道。</span>
UNSUBSCRIBE <span class="token punctuation">[</span>channel <span class="token punctuation">[</span>channel <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span>        <span class="token comment">//指退订给定的频道。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_5、持久化"><a href="#_5、持久化" class="header-anchor">#</a> 5、持久化</h2> <p>Redis 主要是<strong>工作在内存中</strong>。内存本身就不是一个持久化设备，断电后数据会清空。所以Redis 在工作过程中，如果发生了意外停电事故，如何尽可能减少数据丢失。</p> <h3 id="_1、rdb"><a href="#_1、rdb" class="header-anchor">#</a> 1、RDB</h3> <p>在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是Snapshot 快照，它恢复时是将<strong>快照文件直接读到内存里。</strong>
==工作机制：每隔一段时间，就把内存中的数据保存到硬盘上的指定文件中。==RDB 是默认开启的！</p> <blockquote><p>Redis 会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何IO 操作的，这就确保了极高的性能如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB 方式要比AOF 方式更加的高效。
RDB 的缺点是<strong>最后一次持久化后的数据可能丢失。</strong></p></blockquote> <h4 id="_1、rdb保存策略"><a href="#_1、rdb保存策略" class="header-anchor">#</a> 1、RDB保存策略</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>save <span class="token number">900</span> <span class="token number">1</span>      <span class="token comment">//900 秒内如果至少有1 个key 的值变化，则保存</span>
save <span class="token number">300</span> <span class="token number">10</span>     <span class="token comment">//300 秒内如果至少有10 个key 的值变化，则保存</span>
save <span class="token number">60</span> <span class="token number">10000</span>   <span class="token comment">//60 秒内如果至少有10000 个key 的值变化，则保存</span>
save “”         <span class="token comment">//就是禁用RDB 模式；</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_2、rdb-常用属性配置"><a href="#_2、rdb-常用属性配置" class="header-anchor">#</a> 2、RDB 常用属性配置</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>save                        <span class="token comment">//保存策略</span>
dbfilename RDB              <span class="token comment">//快照文件名</span>
dir RDB                     <span class="token comment">//快照保存的目录必须是一个目录，不能是文件名。最好改为固定目录。默认为./代表执行redis-server 命令时的当前目录！</span>
    
stop<span class="token operator">-</span>writes<span class="token operator">-</span>on<span class="token operator">-</span>bgsave<span class="token operator">-</span>error 
    <span class="token comment">//是否在备份出错时，继续接受写操作如果用户开启了RDB 快照功能，那么在redis 持久化数据到磁盘时如果出现失败，默认情况下，redis 会停止接受所有的写请求</span>
    
rdbcompression             
    <span class="token comment">//对于存储到磁盘中的快照，可以设置是否进行压缩存储。如果是的话，redis 会采用LZF 算法进行压缩。如果你不想消耗CPU 来进行压缩的话，可以设置为关闭此功能，但是存储在磁盘上的快照会比较大。</span>
    
rdbchecksum                 
    <span class="token comment">//是否进行数据校验在存储快照后，我们还可以让redis 使用CRC64 算法来进行数据校验，但是这样做会增加大约10%的性能消耗，如果希望获取到最大的性能提升，可以关闭此功能。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="_3、rdb-数据丢失的情况"><a href="#_3、rdb-数据丢失的情况" class="header-anchor">#</a> 3、RDB 数据丢失的情况</h4> <p><strong>两次保存的时间间隔内，服务器宕机，或者发生断电问题。</strong></p> <h4 id="_4、rdb-的触发"><a href="#_4、rdb-的触发" class="header-anchor">#</a> 4、RDB 的触发</h4> <p>​	① 基于自动保存的策略</p> <p>​	② 执行save，或者bgsave 命令！执行时，是阻塞状态。</p> <p>​	③ 执行flushdb 命令，也会产生dump.rdb，但里面是空的，没有意义。</p> <p>​	④ 当执行shutdown 命令时，也会主动地备份数据。</p> <h4 id="_5、rdb的优缺点"><a href="#_5、rdb的优缺点" class="header-anchor">#</a> 5、RDB的优缺点</h4> <p><strong>RDB优点：</strong></p> <p>（1）RDB会生成多个数据文件，每个数据文件都代表了某一个时刻中redis的数据，这种多个数据文件的方式，非常适合做冷备。
（2）RDB对redis对外提供读写服务的时候，影像非常小，因为redis 主进程只需要fork一个子进程出来，让子进程对磁盘io来进行rdb持久化
（3）RDB 在恢复大数据集时的速度比 AOF 的恢复速度要快</p> <p>（4）RDB 适合用于灾难恢复，因为它只有一个文件，而且体积小，方便拷贝。</p> <p><strong>RDB缺点：</strong></p> <p>（1）如果redis要故障时要尽可能少的丢失数据，RDB没有AOF好，例如1:00进行的快照，在1:10又要进行快照的时候宕机了，这个时候就会丢失10分钟的数据。
（2）RDB每次fork出子进程来执行RDB快照生成文件时，如果文件特别大，可能会导致客户端提供服务暂停数毫秒或者几秒</p> <h3 id="_2、aof"><a href="#_2、aof" class="header-anchor">#</a> 2、AOF</h3> <ul><li>AOF 是 以日志的形式来记录每个写操作，将每一次对数据进行修改，都把新建、修改数据的命令保存到指
定文件中。Redis 重新启动时读取这个文件，重新执行新建、修改数据的命令恢复数据。</li> <li>默认不开启，需要手动开启</li> <li>AOF 文件的保存路径，同RDB 的路径一致。</li> <li>AOF 在保存命令的时候，只会保存对数据有修改的命令，也就是写操作！</li> <li>当RDB 和AOF 存的不一致的情况下，按照AOF 来恢复。因为AOF 是对RDB 的补充。备份周期更短，也就更
可靠。</li></ul> <h4 id="_1、aof-保存策略"><a href="#_1、aof-保存策略" class="header-anchor">#</a> 1、AOF 保存策略</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>appendfsync always：每次产生一条新的修改数据的命令都执行保存操作；效率低，但是安全！
appendfsync everysec：每秒执行一次保存操作。如果在未保存当前秒内操作时发生了断电，仍然会导致一部分数据丢失（即<span class="token number">1</span> 秒钟的数据）。
appendfsync no：从不保存，将数据交给操作系统来处理。更快，也更不安全的选择。
推荐（并且也是默认）的措施为每秒fsync 一次， 这种fsync 策略可以兼顾速度和安全性。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_2、aof-常用属性"><a href="#_2、aof-常用属性" class="header-anchor">#</a> 2、AOF 常用属性</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>appendonly                   <span class="token comment">//是否开启AOF 功能默认是关闭的</span>
appendfilename               <span class="token comment">//AOF文件名称</span>
appendfsync AOF              <span class="token comment">//保存策略官方建议everysec</span>
no<span class="token operator">-</span>appendfsync<span class="token operator">-</span>on<span class="token operator">-</span>rewrite     
    <span class="token comment">//在重写时，是否执行保存策略执行重写，可以节省AOF 文件的体积；而且在恢复的时候效率也更高。</span>
<span class="token keyword">auto</span><span class="token operator">-</span>aof<span class="token operator">-</span>rewrite<span class="token operator">-</span>percentage   
    <span class="token comment">//重写的触发条件当目前aof文件大小超过上一次重写的aof文件大小的百分之多少进行重写</span>
<span class="token keyword">auto</span><span class="token operator">-</span>aof<span class="token operator">-</span>rewrite<span class="token operator">-</span>min<span class="token operator">-</span>size     
    <span class="token comment">//设置允许重写的最小aof文件大小,避免了达到约定百分比但尺寸仍然很小的情况还要重写</span>
aof<span class="token operator">-</span>load<span class="token operator">-</span>truncated            
    <span class="token comment">//截断设置如果选择的是yes，当截断的aof 文件被导入的时候，会自动发布一个log 给客户端然后load</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_3、aof-文件的修复"><a href="#_3、aof-文件的修复" class="header-anchor">#</a> 3、AOF 文件的修复</h4> <p>如果AOF 文件中出现了残余命令，会导致服务器无法重启。此时需要借助redis-check-aof 工具来修复！</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>redis<span class="token operator">-</span>check<span class="token operator">-</span>aof –fix 文件
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_4、aof-的优缺点"><a href="#_4、aof-的优缺点" class="header-anchor">#</a> 4、AOF 的优缺点</h4> <p><strong>AOF的优点：</strong></p> <p>（1）AOF可以更好的保护数据不丢失，一般AOF会以每隔1秒，通过后台的一个线程去执行一次fsync操作，如果</p> <p>redis进程挂掉，最多丢失1秒的数据。</p> <p>（2）AOF以appen-only的模式写入，所以没有任何磁盘寻址的开销，写入性能非常高。9</p> <p>（3）AOF日志文件的命令通过非常可读的方式进行记录，这个非常适合做灾难性的误删除紧急恢复，如果某人不</p> <p>小心用flushall命令清空了所有数据，只要这个时候还没有执行rewrite，那么就可以将日志文件中的flushall删除，</p> <p>进行恢复。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- 备份机制更稳健，丢失数据概率更低
- 可读的日志文本，通过操作AOF 稳健，可以处理误操作
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>AOF的缺点：</strong></p> <p>（1）对于同一份文件AOF文件比RDB数据快照要大。</p> <p>（2）AOF开启后支持写的QPS会比RDB支持的写的QPS低，因为AOF一般会配置成每秒fsync操作，每秒的fsync</p> <p>操作还是很高的</p> <p>（3）数据恢复比较慢，不适合做冷备。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- 比起RDB 占用更多的磁盘空间
- 恢复备份速度要慢
- 每次读写都同步的话，有一定的性能压力
- 存在个别Bug，造成恢复不能
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_3、备份建议"><a href="#_3、备份建议" class="header-anchor">#</a> 3、备份建议</h3> <p><strong>如何看待数据“绝对”安全？</strong></p> <blockquote><p>Redis 作为内存数据库从本质上来说，如果不想牺牲性能，就不可能做到数据的“绝对”安全。
RDB 和AOF 都只是尽可能在兼顾性能的前提下降低数据丢失的风险，如果真的发生数据丢失问题，尽可能
减少损失。
在整个项目的架构体系中，Redis 大部分情况是扮演“二级缓存”角色。</p> <p>二级缓存适合保存的数据</p> <ul><li><p>经常要查询，很少被修改的数据。</p></li> <li><p>不是非常重要，允许出现偶尔的并发问题。</p></li> <li><p>不会被其他应用程序修改。</p> <p>如果Redis 是作为缓存服务器，那么说明数据在MySQL 这样的传统关系型数据库中是有正式版本的。数据最终以MySQL 中的为准。</p></li></ul></blockquote> <p><strong>RDB和AOF到底如何选择?</strong></p> <p>（1）不要仅仅使用RDB这样会丢失很多数据。</p> <p>（2）也不要仅仅使用AOF，因为这会有两个问题，第一通过AOF做冷备没有RDB做冷备恢复的速度快；第二</p> <p>RDB每次简单粗暴生成数据快照，更加健壮。</p> <p>（3）综合AOF和RDB两种持久化方式，用AOF来保证数据不丢失，作为恢复数据的第一选择；用RDB来做不同程</p> <p>度的冷备，在AOF文件都丢失或损坏不可用的时候，可以使用RDB进行快速的数据恢复。</p> <p><strong>官方推荐两个都用：</strong>==如果对数据不敏感，可以选单独用RDB；不建议单独用AOF，因为可能出现Bug;如果只是
做纯内存缓存，可以都不用==</p> <h2 id="_6、事务"><a href="#_6、事务" class="header-anchor">#</a> 6、事务</h2> <p><strong>Redis 事务可以一次执行多个命令</strong>， 并且带有以下三个重要的保证：</p> <ul><li>批量操作在发送 EXEC 命令前被放入队列缓存。</li> <li>收到 EXEC 命令后进入事务执行，事务中任意命令执行失败，其余的命令依然被执行。</li> <li>在事务执行过程，其他客户端提交的命令请求不会插入到事务执行命令序列中。</li></ul> <p>一个事务从开始到执行会经历以下三个阶段：</p> <ul><li>开始事务。</li> <li>命令入队。</li> <li>执行事务。</li></ul> <h3 id="_1、事务简介"><a href="#_1、事务简介" class="header-anchor">#</a> 1、事务简介</h3> <ul><li>Redis 中事务，不同于传统的关系型数据库中的事务。</li> <li>Redis 中的事务指的是一个单独的隔离操作。</li> <li>Redis 的事务中的所有命令都会序列化、按顺序地执行且不会被其他客户端发送来的命令请求所打</li> <li>Redis 事务的主要作用是串联多个命令防止别的命令插队</li></ul> <h3 id="_2、常用命令"><a href="#_2、常用命令" class="header-anchor">#</a> 2、常用命令</h3> <div class="language-c line-numbers-mode"><pre class="language-c"><code>MULTI          <span class="token comment">//标记一个事务块的开始</span>

EXEC           
                <span class="token comment">//执行所有事务块内的命令。执行事务中所有在排队等待的指令并将链接状态恢复到正常当使用WATCH时，只有当被监视的键没有被修改，且允许检查设定机制时，EXEC会被执行</span>
                
WATCH           <span class="token comment">//标记所有指定的key 被监视起来，在事务中有条件的执行（乐观锁）</span>

UNWATCH         <span class="token comment">//取消 WATCH 命令对所有 key 的监视。</span>

DISCARD         
<span class="token comment">//刷新一个事务中所有在排队等待的指令，并且将连接状态恢复到正常。如果已使用WATCH，DISCARD将释放所有被WATCH 的key。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200406215622035.png" alt="image-20200406215622035"></p> <p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200406221329363.png" alt="image-20200406221329363"></p> <p><strong>MULTI 开启组队，EXEC 依次执行队列中的命令。</strong></p> <p><strong>DISCARD 中途取消组队</strong></p> <p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200406215934571.png" alt="image-20200406215934571"></p> <h3 id="_3、错误命令处理"><a href="#_3、错误命令处理" class="header-anchor">#</a> 3、错误命令处理</h3> <p>1、此种情况，语法符合规范，Redis 只有在执行中，才可以发现错误。而在Redis 中，并没有回滚机制，因此错误的命令，无法执行，正确的命令会全部执行！</p> <p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200406220325713.png" alt="image-20200406220325713"></p> <p>2、在编译的过程中，Redis 检测出来了错误的语法命令，因此它认为这条组队，一定会发生错误，因此全体取消；</p> <p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200406220528937.png" alt="image-20200406220528937"></p> <h3 id="_4、锁"><a href="#_4、锁" class="header-anchor">#</a> 4、锁</h3> <h4 id="_1、悲观锁"><a href="#_1、悲观锁" class="header-anchor">#</a> 1、悲观锁</h4> <p>执行操作前假设当前的操作肯定（或有很大几率）会被打断（悲观）。基于这个假设，我们在做操作前就会把相关</p> <p>资源锁定，不允许自己执行期间有其他操作干扰。</p> <p>Redis 不支持悲观锁。Redis 作为缓存服务器使用时，以读操作为主，很少写操作，相应的操作被打断的几率较</p> <p>少。不采用悲观锁是为了防止降低性能。</p> <h4 id="_2、乐观锁"><a href="#_2、乐观锁" class="header-anchor">#</a> 2、乐观锁</h4> <p>执行操作前假设当前操作不会被打断（乐观）。基于这个假设，我们在做操作前不会锁定资源，万一发生了其他操</p> <p>作的干扰，那么本次操作将被放弃。</p> <h3 id="_5、redis-中的锁策略"><a href="#_5、redis-中的锁策略" class="header-anchor">#</a> 5、Redis 中的锁策略</h3> <ul><li><p>Redis 采用了乐观锁策略**（通过watch 操作）**。乐观锁支持读操作，适用于多读少写的情况！</p></li> <li><p>在事务中，可以通过<strong>watch 命令来加锁</strong>；使用<strong>UNWATCH 可以取消加锁</strong>；</p></li> <li><p>如果在事务之前，执行了WATCH（加锁），那么执行EXEC 命令或DISCARD 命令后，锁对自动释放，即不需</p> <p>要再执行UNWATCH 了</p></li></ul> <h2 id="_7、redis-cluste集群"><a href="#_7、redis-cluste集群" class="header-anchor">#</a> 7、Redis Cluste集群</h2> <blockquote><p>什么是集群：
Redis 集群实现了对Redis 的水平扩容，即启动N 个redis 节点，将整个数据库分布存储在这N 个节点中，每个节点存储总数据的1/N。
Redis 集群通过分区（partition）来提供一定程度的可用性（availability）： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。</p></blockquote> <h3 id="_1、搭建集群环境"><a href="#_1、搭建集群环境" class="header-anchor">#</a> 1、搭建集群环境</h3> <h4 id="_1、创建目录并修改集群配置文件-redis-conf"><a href="#_1、创建目录并修改集群配置文件-redis-conf" class="header-anchor">#</a> 1、创建目录并修改集群配置文件（redis.conf）</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>mkdir cluster<span class="token operator">-</span>test
cd cluster<span class="token operator">-</span>test
mkdir <span class="token number">7000</span> <span class="token number">7001</span> <span class="token number">7002</span> <span class="token number">7003</span> <span class="token number">7004</span> <span class="token number">7005</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code>port <span class="token number">7000</span>
<span class="token comment">//开启集群模式</span>
cluster<span class="token operator">-</span>enabled yes
cluster<span class="token operator">-</span>config<span class="token operator">-</span>file nodes<span class="token punctuation">.</span>conf
cluster<span class="token operator">-</span>node<span class="token operator">-</span>timeout <span class="token number">5000</span>
appendonly yes

<span class="token comment">//依次修改6个配置文件</span>
cp <span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">7000</span><span class="token operator">/</span>redis<span class="token punctuation">.</span>conf <span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">7000</span><span class="token operator">/</span>
<span class="token operator">:</span><span class="token operator">%</span>s<span class="token operator">/</span><span class="token number">7000</span><span class="token operator">/</span><span class="token number">7001</span><span class="token operator">/</span>g      替换
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_2、启动节点"><a href="#_2、启动节点" class="header-anchor">#</a> 2、启动节点</h4> <p>把安装Redis目录下的src复制到redis_cluster下，方便启动服务</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//进入安装目录下 cd /root/tool/redis-5.0.8/（我的为例）</span>
cp <span class="token operator">-</span>r <span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>redis_cluster
    
<span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>redis<span class="token operator">-</span>server <span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">7000</span><span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>redis<span class="token operator">-</span>server <span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">7001</span><span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>redis<span class="token operator">-</span>server <span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">7002</span><span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>redis<span class="token operator">-</span>server <span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">7003</span><span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>redis<span class="token operator">-</span>server <span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">7004</span><span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
<span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>redis<span class="token operator">-</span>server <span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">7005</span><span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200407231906916.png" alt="image-20200407231906916"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>ps <span class="token operator">-</span>ef <span class="token operator">|</span>grep <span class="token operator">-</span>i redis          <span class="token comment">//查看进程</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="_3、创建集群"><a href="#_3、创建集群" class="header-anchor">#</a> 3、创建集群</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//redis5之后</span>
<span class="token punctuation">.</span><span class="token operator">/</span>src<span class="token operator">/</span>redis<span class="token operator">-</span>cli <span class="token operator">--</span>cluster create <span class="token operator">-</span>a 密码 <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">7000</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">7001</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">7002</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">7003</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">7004</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">7005</span> <span class="token operator">--</span>cluster<span class="token operator">-</span>replicas <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://raw.githubusercontent.com/yhx1001/PicGo/img/image-20200408194731829.png" alt="image-20200408194731829"></p> <h3 id="_2、集群验证"><a href="#_2、集群验证" class="header-anchor">#</a> 2、集群验证</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>./src/redis-cli -p 7000 -a 密码
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>127.0.0.1:7000&gt; CLUSTER nodes
b7959193eb80fa0abc8cf9d296d08de76cf47f4d 127.0.0.1:7002@17002 master - 0 1586346968000 3 connected 10923-16383
74dc8b2155478d22d147d86dd052f84824bcc021 127.0.0.1:7001@17001 master - 0 1586346969041 2 connected 5461-10922
26764a2d2dc63b0ba3216de62ac0a171329e6f43 127.0.0.1:7005@17005 slave 1af6831ee1e7f9448fed04fab40b68f30b001b59 0 1586346968033 6 connected
1af6831ee1e7f9448fed04fab40b68f30b001b59 127.0.0.1:7000@17000 myself,master - 0 1586346968000 1 connected 0-5460
6373481e4202f55a6d3a0f46a0da00a395573861 127.0.0.1:7003@17003 slave 74dc8b2155478d22d147d86dd052f84824bcc021 0 1586346968537 4 connected
20c5257ce6ea6a2aa666f283e068e865152c52a6 127.0.0.1:7004@17004 slave b7959193eb80fa0abc8cf9d296d08de76cf47f4d 0 1586346969544 5 connected
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_3、集群开启与关闭"><a href="#_3、集群开启与关闭" class="header-anchor">#</a> 3、集群开启与关闭</h3> <h4 id="_1、开启"><a href="#_1、开启" class="header-anchor">#</a> 1、开启</h4> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment">#redisstart.sh     –c 参数实现自动重定向</span>
/usr/local/redis_cluster/src/redis-server ./7000/redis.conf
/usr/local/redis_cluster/src/redis-server ./7001/redis.conf
/usr/local/redis_cluster/src/redis-server ./7002/redis.conf
/usr/local/redis_cluster/src/redis-server ./7003/redis.conf
/usr/local/redis_cluster/src/redis-server ./7004/redis.conf
/usr/local/redis_cluster/src/redis-server ./7005/redis.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code>chmod u<span class="token operator">+</span>x redisall<span class="token punctuation">.</span>sh  <span class="token comment">//变成可执行文件</span>
<span class="token punctuation">.</span><span class="token operator">/</span>redisall<span class="token punctuation">.</span>sh          <span class="token comment">//在当前目录下启动</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#startall.sh</span>
/usr/local/redis_cluster/src/redis-cli --cluster create -a 密码 <span class="token number">127.0</span>.0.1:7000 <span class="token number">127.0</span>.0.1:7001 <span class="token number">127.0</span>.0.1:7002 <span class="token number">127.0</span>.0.1:7003 <span class="token number">127.0</span>.0.1:7004 <span class="token number">127.0</span>.0.1:7005 --cluster-replicas <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-c line-numbers-mode"><pre class="language-c"><code>chmod u<span class="token operator">+</span>x startall<span class="token punctuation">.</span>sh
<span class="token punctuation">.</span><span class="token operator">/</span>startall<span class="token punctuation">.</span>sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_2、关闭"><a href="#_2、关闭" class="header-anchor">#</a> 2、关闭</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#shutdown.sh</span>
/usr/local/redis_cluster/src/redis-cli -c -h <span class="token number">127.0</span>.0.1 -p <span class="token number">7000</span> -a 密码 <span class="token function">shutdown</span>
/usr/local/redis_cluster/src/redis-cli -c -h <span class="token number">127.0</span>.0.1 -p <span class="token number">7001</span> -a 密码 <span class="token function">shutdown</span>
/usr/local/redis_cluster/src/redis-cli -c -h <span class="token number">127.0</span>.0.1 -p <span class="token number">7002</span> -a 密码 <span class="token function">shutdown</span>
/usr/local/redis_cluster/src/redis-cli -c -h <span class="token number">127.0</span>.0.1 -p <span class="token number">7003</span> -a 密码 <span class="token function">shutdown</span>
/usr/local/redis_cluster/src/redis-cli -c -h <span class="token number">127.0</span>.0.1 -p <span class="token number">7004</span> -a 密码 <span class="token function">shutdown</span>
/usr/local/redis_cluster/src/redis-cli -c -h <span class="token number">127.0</span>.0.1 -p <span class="token number">7005</span> -a 密码 <span class="token function">shutdown</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>chmod u+x shutdown.sh
./shutdown.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_4、集群中故障恢复"><a href="#_4、集群中故障恢复" class="header-anchor">#</a> 4、集群中故障恢复</h3> <p>问题1：如果主节点下线？从节点能否自动升为主节点？</p> <blockquote><p>答：<strong>主节点下线，从节点自动升为主节点</strong>。</p></blockquote> <p>问题2：主节点恢复后，主从关系会如何？</p> <blockquote><p><strong>主节点恢复后，主节点变为从节点！</strong></p></blockquote> <p>问题3：如果所有某一段插槽的主从节点都宕掉，redis 服务是否还能继续?</p> <blockquote><p>答：<strong>服务是否继续，可以通过redis.conf 中的cluster-require-full-coverage 参数进行控制。</strong></p></blockquote> <blockquote><p>主从都宕掉，意味着有一片数据，会变成真空，没法再访问了！
如果无法访问的数据，是连续的业务数据，我们需要停止集群，避免缺少此部分数据，造成整个业务的异常。此时可以通过配置cluster-require-full-coverage 为yes.
如果无法访问的数据，是相对独立的，对于其他业务的访问，并不影响，那么可以继续开启集群体提供服务。此时，可以配置cluster-require-full-coverage 为no。</p></blockquote> <h3 id="_5、集群的优缺点"><a href="#_5、集群的优缺点" class="header-anchor">#</a> 5、集群的优缺点</h3> <p><strong>优点：</strong></p> <ul><li>实现扩容</li> <li>分摊压力</li> <li>无中心配置相对简单</li></ul> <p><strong>缺点：</strong></p> <ul><li>多键操作是不被支持的</li> <li>多键的Redis 事务是不被支持的。lua 脚本不被支持。</li> <li>由于集群方案出现较晚，很多公司已经采用了其他的集群方案，而代理或者客户端分片的方案想要迁
移至redis cluster，需要整体迁移而不是逐步过渡，复杂度较大。</li></ul> <h1 id="_8、windows安装redis"><a href="#_8、windows安装redis" class="header-anchor">#</a> 8、windows安装Redis</h1> <p>下载地址：https://github.com/MicrosoftArchive/redis/releases</p> <p>官网只提供linux版本</p> <p><img src="/assets/img/image-20200814140330246.8ad2bb04.png" alt="image-20200814140330246"></p> <p>解压之后，进入安装目录</p> <p><img src="/assets/img/image-20200814142452682.443ec73c.png" alt="image-20200814142452682"></p> <p>快速进入cmd窗口</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#启动服务</span>
redis-server redis.windows.conf
<span class="token comment">#会出现命令行界面，表示成功</span>
<span class="token comment">#redis安装为windows服务</span>
redis-server --service-install redis.windows-service.conf --loglevel verbose
 <span class="token comment"># --loglevel verbose表示记录日志等级</span>
<span class="token comment">#卸载服务</span>
redis-server --service-uninstall
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#启动redis服务</span>
redis-server --service-start
<span class="token comment">#关闭redis服务</span>
redis-server  --service-stop
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#带密码登录</span>
redis-cli -h <span class="token number">127.0</span>.0.1 -p <span class="token number">6379</span> -a xxxxx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="为redis设置密码"><a href="#为redis设置密码" class="header-anchor">#</a> 为redis设置密码</h4> <p>进入redis.windows.conf文件</p> <p><img src="/assets/img/image-20200814142903721.6f332c3a.png" alt="image-20200814142903721"></p> <p>找到 #requirepass foobared 关键字</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>requirepass 你的密码
<span class="token comment">#然后重新启动redis</span>
redis-server redis.windows.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h1 id="_9、redis实战"><a href="#_9、redis实战" class="header-anchor">#</a> 9、Redis实战</h1> <blockquote><p>Redis应用范围：</p> <ul><li>短信登录：Redis的共享session应用</li> <li>商户查询缓存：企业的缓存使用技巧；缓存雪崩、穿透等问题解决</li> <li>优惠券秒杀：Redis的计数器、Lua脚本Redis；分布式锁；Redis的三种消息队列</li> <li>附近的商户：Redis的GeoHash的应用</li> <li>UV统计：Redis的HyperLogLog的统计功能</li> <li>用户签到：Redis的BitMap数据统计功能</li> <li>好友关注：基于Set集合的关注、取关、共同关注、消息推送等功能</li> <li>达人探店：基于List的点赞列表、基于SortedSet的点赞排行榜</li></ul></blockquote> <h2 id="_1、短信登录"><a href="#_1、短信登录" class="header-anchor">#</a> 1、短信登录</h2> <h3 id="_1、流程讲解"><a href="#_1、流程讲解" class="header-anchor">#</a> 1、流程讲解</h3> <p><img src="/assets/img/image-20220522141213096.82c99db5.png" alt="image-20220522141213096"></p> <h3 id="_2、基于session实现登录"><a href="#_2、基于session实现登录" class="header-anchor">#</a> 2、基于Session实现登录</h3> <h4 id="_1、发送短信验证码"><a href="#_1、发送短信验证码" class="header-anchor">#</a> 1、发送短信验证码</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 发送验证码
     * @param phone
     * @param session
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//【1】校验手机号</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;手机号格式错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//【2】生成验证码</span>
        <span class="token class-name">String</span> numbers <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomNumbers</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//保存到session</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span>numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="_2、短信验证码登录、注册"><a href="#_2、短信验证码登录、注册" class="header-anchor">#</a> 2、短信验证码登录、注册</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">/**
     * 用户登录
     * @param loginForm
     * @param session
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginFormDTO</span> loginForm<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//【1】校验手机号</span>
        <span class="token class-name">String</span> phone <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;手机号格式错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//【2】校验验证码</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//存在session的数据</span>
        <span class="token class-name">Object</span> sessionCode <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> sessionCode <span class="token operator">||</span> <span class="token operator">!</span>sessionCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;验证码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//【3】查询用户是否存在</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
            user <span class="token operator">=</span> <span class="token function">createUserWithPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据手机号创建用户
     * @param phone
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> <span class="token function">createUserWithPhone</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span><span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>USER_NICK_NAME_PREFIX <span class="token operator">+</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h4 id="_3、校验登录状态"><a href="#_3、校验登录状态" class="header-anchor">#</a> 3、校验登录状态</h4> <blockquote><p>我们大部分接口都需要登录才能访问，这时我们需要增加一个拦截器，拦截需要登录才能访问的功能</p></blockquote> <p><img src="/assets/img/image-20220523161934499.134a8b73.png" alt="image-20220523161934499"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @author xiaoBear
 * @date 2022/5/22 15:14
 * @description 登录拦截
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 前置拦截
     * @param request
     * @param response
     * @param handler
     * @return
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取session</span>
        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取session用户</span>
        <span class="token class-name">Object</span> user <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断用户是否存在</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//存在，保存在ThreadLocal</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">UserDTO</span><span class="token punctuation">)</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//放行</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 拦截之后
     *
     * @param request
     * @param response
     * @param handler
     * @param ex
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//移除用户</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterCompletion</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><ul><li>再把拦截器加入到配置中</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;/user/code&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/user/login&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/blog/hot&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/shop/**&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/shop-type/**&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/voucher/**&quot;</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p><code>excludePathPatterns</code>：代表放行的接口，不需要拦截</p></blockquote> <h3 id="_3、集群的session共享问题"><a href="#_3、集群的session共享问题" class="header-anchor">#</a> 3、集群的session共享问题</h3> <blockquote><p><strong>session共享问题</strong>：多台Tomcat并不共享session存储空间，当请求切换到不同tomcat服务时导致数据丢失的问题。</p> <p>session的替代方案应该满足：</p> <ul><li>数据共享</li> <li>内存存储</li> <li>key、value结构</li></ul></blockquote> <p><img src="/assets/img/image-20220523104349542.b81d6c13.png" alt="image-20220523104956552"></p> <p><strong>解决方案：使用Redis进行存储</strong></p> <h3 id="_4、基于redis实现共享session登录"><a href="#_4、基于redis实现共享session登录" class="header-anchor">#</a> 4、基于Redis实现共享session登录</h3> <p><img src="/assets/img/image-20220523163140956.c4053c8f.png" alt="image-20220523163140956"></p> <p><img src="/assets/img/image-20220523163205724.55c99301.png" alt="image-20220523163205724"></p> <p>保存登录的用户信息，可以使用String结构，以JSON字符串来保存，比较直观：</p> <table><thead><tr><th><strong>KEY</strong></th> <th><strong>VALUE</strong></th></tr></thead> <tbody><tr><td>heima:user:1</td> <td>{name:&quot;Jack&quot;, age:21}</td></tr> <tr><td>heima:user:2</td> <td>{name:&quot;Rose&quot;, age:18}</td></tr></tbody></table> <p>但是Hash结构可以将对象中的每个字段独立存储，可以针对单个字段做CRUD，并且内存占用更少：</p> <p><img src="/assets/img/image-20220523163347277.9299a5b2.png" alt="image-20220523163347277"></p> <p>Redis代替session需要考虑的问题：</p> <ul><li>选择合适的数据结构</li> <li>选择合适的key</li> <li>选择合适的存储粒度</li></ul> <h4 id="_1、发送短信验证码-2"><a href="#_1、发送短信验证码-2" class="header-anchor">#</a> 1、发送短信验证码</h4> <blockquote><p>这里采用的是<code>StringRedisTemplate</code>这个Bean对象</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">/**
     * 发送验证码
     * @param phone
     * @param session
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token class-name">String</span> phone<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//【1】校验手机号</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;手机号格式错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//【2】生成验证码</span>
        <span class="token class-name">String</span> numbers <span class="token operator">=</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomNumbers</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置两分钟过期 set key value expire 120</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_CODE_KEY <span class="token operator">+</span> phone<span class="token punctuation">,</span> numbers<span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_CODE_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="_2、短信验证码登录注册"><a href="#_2、短信验证码登录注册" class="header-anchor">#</a> 2、短信验证码登录注册</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 用户登录
     * @param loginForm
     * @param session
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginFormDTO</span> loginForm<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//【1】校验手机号</span>
        <span class="token class-name">String</span> phone <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RegexUtils</span><span class="token punctuation">.</span><span class="token function">isPhoneInvalid</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;手机号格式错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//【2】校验验证码</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> loginForm<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//从redis获取验证码并校验</span>
        <span class="token class-name">String</span> sessionCode <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_CODE_KEY <span class="token operator">+</span> phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> sessionCode <span class="token operator">||</span> <span class="token operator">!</span>sessionCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;验证码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//【3】查询用户是否存在</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;phone&quot;</span><span class="token punctuation">,</span> phone<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
            user <span class="token operator">=</span> <span class="token function">createUserWithPhone</span><span class="token punctuation">(</span>phone<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">//【4】保存用户到redis中</span>

        <span class="token comment">//生成随机token，作为登录令牌</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将user对象转为HashMap存储</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//存储</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">beanToMap</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">CopyOptions</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setIgnoreNullValue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setFieldValueEditor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> v<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置有效期 30分钟</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h4 id="_3、校验登录状态-2"><a href="#_3、校验登录状态-2" class="header-anchor">#</a> 3、校验登录状态</h4> <blockquote><p><strong>最开始登录拦截器流程</strong>：前面session拦截的时候，只拦截需要登录的路径，然后查询用户是否存在。存在则继续，将用户信息保存到<code>ThreadLocal</code>中，刷新token的有效时间，放行；不存在则拦截；</p> <p><strong>存在的问题</strong>：如果访问的路径并不是需要拦截的路径，token的有效期就不会一直刷新，就会导致在登录状态下，会自动退出登录。</p> <p><strong>解决办法</strong>：再添加一个拦截器，用于拦截一切路径。先获取接口中的token，根据token查询Redis，若存在则保存到<code>ThreadLocal</code>中，刷新token时间，最后放行；而登录拦截器只用于从<code>ThreadLocal</code>中获取用户信息，不存在则拦截，存在则放行。</p></blockquote> <p><img src="/assets/img/image-20220525103516643.df33005c.png" alt="image-20220525103516643"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefreshTokenInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RefreshTokenInterceptor</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 前置拦截
     * @param request
     * @param response
     * @param handler
     * @return
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取请求头的token 基于token获取redis的用户</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果用户信息为空，则放行 进行第二次拦截LoginInterceptor</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">UserDTO</span> userDTO <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UserDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        //存在，保存在ThreadLocal</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">saveUser</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//刷新过期时间</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOGIN_USER_KEY <span class="token operator">+</span> token<span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//放行</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 拦截之后
     *
     * @param request
     * @param response
     * @param handler
     * @param ex
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//移除用户</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterCompletion</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>登录拦截器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 前置拦截
     * @param request
     * @param response
     * @param handler
     * @return
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断是否需要拦截 （ThreadLocal中存在用户）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//放行</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 拦截之后
     *
     * @param request
     * @param response
     * @param handler
     * @param ex
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//移除用户</span>
        <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HandlerInterceptor</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterCompletion</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h2 id="_2、查询缓存"><a href="#_2、查询缓存" class="header-anchor">#</a> 2、查询缓存</h2> <h3 id="_1、什么是缓存"><a href="#_1、什么是缓存" class="header-anchor">#</a> 1、什么是缓存</h3> <blockquote><p>缓存就是数据交换的缓冲区（称作Cache [ kæʃ ] ），是存贮数据的临时地方，一般读写性能较高。</p></blockquote> <p><img src="/assets/img/image-20220525111117211.86332210.png" alt="image-20220525111117211"></p> <ul><li><p>浏览器缓存：缓存常用的样式css，js</p></li> <li><p>应用层缓存：浏览器未命中的缓存，则缓存在应用中</p></li> <li><p>数据库缓存：应用层未命中，则命中到数据库缓存，可缓存索引；通过索引查询时可快速检索，减少磁盘的读写</p></li> <li><p>CPU缓存：在Cache中的数据是内存中的一小部分，但这一小部分是短时间内CPU即将访问的，当CPU调用大量数据时，就可避开内</p> <p>存直接从Cache中调用，从而加快读取速度。由此可见，在CPU中加入Cache是一种高效的解决方案，这样整个内存储器（Cache+内</p> <p>存）就变成了既有Cache的高速度，又有内存的大容量的存储系统了。</p></li> <li><p>磁盘缓存：为了减少CPU透过I/O读取磁盘机的次数，提升磁盘I/O的效率，用一块内存来储存存取较频繁的磁盘内容；因为内存的存取是电子动作，而磁盘的存取是I/O动作，感觉上磁盘I/O变得较为快速。</p></li></ul> <h4 id="缓存的作用"><a href="#缓存的作用" class="header-anchor">#</a> 缓存的作用</h4> <ul><li>降低后端负载</li> <li>提高读写效率，降低响应时间</li></ul> <h4 id="缓存的成本"><a href="#缓存的成本" class="header-anchor">#</a> 缓存的成本</h4> <ul><li>数据一致性成本</li> <li>代码维护成本</li> <li>运维成本</li></ul> <h3 id="_2、添加redis缓存"><a href="#_2、添加redis缓存" class="header-anchor">#</a> 2、添加Redis缓存</h3> <h4 id="_1、未添加缓存作用模型"><a href="#_1、未添加缓存作用模型" class="header-anchor">#</a> 1、未添加缓存作用模型</h4> <blockquote><p>客户端直接将请求打到数据库，数据库查询到之后直接返回给客户端</p></blockquote> <p><img src="data:image/png;base64,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" alt="image-20220525113114209"></p> <h4 id="_2、添加缓存作用模型"><a href="#_2、添加缓存作用模型" class="header-anchor">#</a> 2、添加缓存作用模型</h4> <blockquote><p>客户端请求到Redis，如果redis命中则返回客户端，未命中则请求到数据库，查询到之后则返回给客户端，同时，将结果写入到redis中</p></blockquote> <p><img src="/assets/img/image-20220525113214796.28015dd3.png" alt="image-20220525113214796"></p> <h4 id="_3、商户缓存到redis"><a href="#_3、商户缓存到redis" class="header-anchor">#</a> 3、商户缓存到redis</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从redis查询缓存</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> shopInfo <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//存在则返回</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopInfo<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//不存在，则查询数据库</span>
    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//不存在则返回错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> shop<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;店铺不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//写入缓存</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//数据库存在，则返回</span>

    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="_3、缓存更新策略"><a href="#_3、缓存更新策略" class="header-anchor">#</a> 3、缓存更新策略</h3> <p><img src="/assets/img/image-20220525154742282.eeec6174.png" alt="image-20220525154742282"></p> <p>业务场景：</p> <ul><li>低一致性需求：使用内存淘汰机制。例如店铺类型的查询缓存</li> <li>高一致性需求：主动更新，并以超时剔除作为兜底方案。例如店铺详情查询的缓存</li></ul> <h4 id="_1、主动更新"><a href="#_1、主动更新" class="header-anchor">#</a> 1、主动更新</h4> <ol><li>Cache Aside Pattern：由缓存的调用者，在更新数据库的同时更新缓存</li> <li>Read/Write Through Pattern：缓存与数据库整合为一个服务，由服务维护一致性，调用者调用该服务，无需关心缓存一致性问题</li> <li>Write Behind Caching Pattern：调用者只操作缓存，由其他线程异步的将缓存的数据持久化到数据库，保证最终一致。</li></ol> <p>PS：<strong>一般使用方案1，由缓存的调用者，在更新数据库的同时更新缓存</strong></p> <h4 id="_2、cache-aside-pattern"><a href="#_2、cache-aside-pattern" class="header-anchor">#</a> 2、Cache Aside Pattern</h4> <blockquote><p>由缓存的调用者，在更新数据库的同时更新缓存</p></blockquote> <p>操作缓存和数据库时有三个问题需要考虑：</p> <ol><li>删除缓存还是更新缓存？</li> <li>如何保证缓存与数据库的操作的同时成功或失败？</li> <li>先操作缓存还是先操作数据库？</li></ol> <h5 id="_1、删除缓存还是更新缓存"><a href="#_1、删除缓存还是更新缓存" class="header-anchor">#</a> 1、删除缓存还是更新缓存？</h5> <blockquote><ul><li><p>更新缓存：每次更新数据库都更新缓存，无效写操作较多 ❌</p> <p>如果更新数据库的次数多，而读取的次数较少，则每次更新时，都会增加无效的更新缓存操作</p></li> <li><p>删除缓存：更新数据库时让缓存失效，查询时再更新缓存 ✔️</p></li></ul></blockquote> <h5 id="_2、如何保证缓存与数据库的操作的同时成功或失败"><a href="#_2、如何保证缓存与数据库的操作的同时成功或失败" class="header-anchor">#</a> 2、如何保证缓存与数据库的操作的同时成功或失败？</h5> <blockquote><ul><li>单体系统，将缓存与数据库操作放在一个事务</li> <li>分布式系统，利用TCC等分布式事务方案</li></ul></blockquote> <h5 id="_3、先操作缓存还是先操作数据库"><a href="#_3、先操作缓存还是先操作数据库" class="header-anchor">#</a> 3、先操作缓存还是先操作数据库？</h5> <blockquote><ul><li>先删除缓存，再操作数据库</li> <li>先操作数据库，再删除缓存</li></ul></blockquote> <h6 id="_1、先删除缓存-再操作数据库"><a href="#_1、先删除缓存-再操作数据库" class="header-anchor">#</a> 1、先删除缓存，再操作数据库</h6> <p><strong>不存在线程安全问题场景</strong></p> <ol><li>线程1收到请求后，先删除缓存，然后更新数据库值为20</li> <li>线程2收到请求后，先查询缓存，并没有命中，则查询数据库的值为20，再写入缓存</li></ol> <p><img src="data:image/png;base64,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" alt="image-20220525160818661"></p> <p><strong>存在线程安全问题场景</strong></p> <ol><li>线程1收到请求后，先删除缓存</li> <li>线程2收到查询请求，查询缓存发现没有命中，则去查询数据库的值为10</li> <li>线程2将数据库的值写入缓存</li> <li>线程1更新数据库的值为20，此时导致数据不一致问题</li></ol> <p><img src="data:image/png;base64,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" alt="image-20220525161027087"></p> <h6 id="_2、先操作数据库-再删除缓存"><a href="#_2、先操作数据库-再删除缓存" class="header-anchor">#</a> 2、先操作数据库，再删除缓存✔️</h6> <p><strong>不存在线程安全问题场景</strong></p> <ol><li>线程2收到请求后更新数据库值为20</li> <li>线程2更新完成后，删除缓存</li> <li>线程1收到请求后，查询缓存，未命中，则查询数据库</li> <li>线程1查询到数据后，写入缓存</li></ol> <p><img src="data:image/png;base64,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" alt="image-20220525162539721"></p> <p><strong>存在线程安全问题场景</strong></p> <ol><li>线程1收到查询请求后，查询缓存，未名中，则去查询数据库值为10</li> <li>线程2收到更新请求，更新数据库值为20</li> <li>线程2更新数据库后，删除缓存</li> <li>线程1写入缓存值为10，此时缓存写入的是旧数据</li></ol> <p><img src="/assets/img/image-20220525164117876.63943d3e.png" alt="image-20220525164117876"></p> <h4 id="_3、总结"><a href="#_3、总结" class="header-anchor">#</a> 3、总结</h4> <p>缓存更新策略的最佳实践方案：</p> <ol><li>低一致性需求：使用Redis自带的内存淘汰机制</li> <li>高一致性需求：主动更新，并以超时剔除作为兜底方案
<ul><li>读操作
<ul><li>缓存命中则直接返回</li> <li>缓存未命中则查询数据库，并写入缓存，设定超时时间</li></ul></li> <li>写操作
<ul><li>先写数据库，然后再删除缓存</li> <li>要确保数据库与缓存操作的原子性</li></ul></li></ul></li></ol> <h4 id="_4、实战"><a href="#_4、实战" class="header-anchor">#</a> 4、实战</h4> <h5 id="_1、查询设置超时时间"><a href="#_1、查询设置超时时间" class="header-anchor">#</a> 1、查询设置超时时间</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从redis查询缓存</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> shopInfo <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//存在则返回</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopInfo<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//不存在，则查询数据库</span>
    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//不存在则返回错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> shop<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;店铺不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//写入缓存 设置超时时间为30min</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//数据库存在，则返回</span>

    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h5 id="_2、更新时删除缓存"><a href="#_2、更新时删除缓存" class="header-anchor">#</a> 2、更新时删除缓存</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Shop</span> shop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Long</span> id <span class="token operator">=</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;店铺id不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//1.更新数据库</span>
    <span class="token function">updateById</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2.删除缓存</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_4、缓存穿透"><a href="#_4、缓存穿透" class="header-anchor">#</a> 4、缓存穿透</h3> <h4 id="_1、定义"><a href="#_1、定义" class="header-anchor">#</a> 1、定义</h4> <blockquote><p>缓存穿透是指客户端请求的数据在缓存中和数据库中都不存在，这样缓存永远不会生效，这些请求都会打到数据库。</p> <p>通俗点就是：key对应的数据在数据源并不存在，每次针对此key的请求从缓存获取不到，请求都会到数据源，从而可能压垮数据源。比如用一个不存在的用户id获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库。</p></blockquote> <img src="/assets/img/image-20220525171004467.15d7b67e.png" alt="image-20220525171004467" style="zoom:50%;"> <h4 id="_2、解决方案"><a href="#_2、解决方案" class="header-anchor">#</a> 2、解决方案</h4> <h5 id="_1、缓存空对象"><a href="#_1、缓存空对象" class="header-anchor">#</a> 1、缓存空对象</h5> <blockquote><p>当客户端请求到redis后，未命中去查询数据库，数据库查询返回为null，则缓存为null</p></blockquote> <p>优点：</p> <ul><li>实现简单，维护方便</li></ul> <p>缺点：</p> <ul><li><p>额外的内存消耗</p> <blockquote><p>若客户端请求大量数据都是不存在的，则redis会缓存大量的null数据</p></blockquote></li> <li><p>可能造成短期的不一致</p> <blockquote><p>客户端请求不存在的数据后，redis缓存数据为null，并设置了超时时间，此时就新增了一条数据，则再去查询时（还在TTL内），还是为null，只有当时间失效时，才会查询到</p> <ul><li>可在新增时，更新缓存，可解决短期的不一致</li></ul></blockquote></li></ul> <p><img src="https://gitee.com/Xiao_bear/PicGo/raw/img/2022/202206101639622.png" alt="image-20220525171301096"></p> <h5 id="_2、布隆过滤器"><a href="#_2、布隆过滤器" class="header-anchor">#</a> 2、布隆过滤器</h5> <blockquote><p>布隆过滤器是一个 bit 向量或者说 bit 数组（超长超长，记住一定要足够长）</p> <p>将所有可能存在的数据哈希到一个足够大的bitmap中，一个一定不存在的数据会被 这个bitmap拦截掉，从而避免了对底层存储系统的查询压力。</p></blockquote> <p>优点：</p> <ul><li>内存占用较少，没有多余key</li></ul> <p>缺点：</p> <ul><li>实现复杂</li> <li>存在误判可能</li></ul> <p><img src="/assets/img/image-20220525172112838.23046169.png" alt="image-20220525172112838"></p> <h4 id="_3、实战"><a href="#_3、实战" class="header-anchor">#</a> 3、实战</h4> <div class="language-JAVA line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从redis查询缓存</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> shopInfo <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//存在则返回</span>
        <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopInfo<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> shopInfo<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;店铺不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//不存在，则查询数据库</span>
    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//不存在则返回错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> shop<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//将空值写入redis</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_NULL_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;店铺不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//写入缓存 设置超时时间为30min</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//数据库存在，则返回</span>

    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h4 id="_4、总结"><a href="#_4、总结" class="header-anchor">#</a> 4、总结</h4> <h5 id="原因"><a href="#原因" class="header-anchor">#</a> 原因</h5> <blockquote><p>用户请求的数据在缓存中和数据库中都不存在，不断发起这样的请求，给数据库带来巨大压力</p></blockquote> <h5 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h5> <blockquote><ul><li>缓存null值</li> <li>布隆过滤</li> <li>增强id的复杂度，避免被猜测id规律</li> <li>做好数据的基础格式校验</li> <li>加强用户权限校验</li> <li>做好热点参数的限流</li></ul></blockquote> <h3 id="_5、缓存雪崩"><a href="#_5、缓存雪崩" class="header-anchor">#</a> 5、缓存雪崩</h3> <h4 id="_1、定义-2"><a href="#_1、定义-2" class="header-anchor">#</a> 1、定义</h4> <blockquote><p>缓存雪崩是指在同一时段大量的缓存key同时失效或者Redis服务宕机，导致大量请求到达数据库，带来巨大压力。</p> <p>key可能会在某些时间点被超高并发地访问，是一种非常“热点”的数据。这个时候，需要考虑一个问题：缓存被“击穿”的问题。</p></blockquote> <p><img src="/assets/img/image-20220530092108056.41db0629.png" alt="image-20220530092108056"></p> <h4 id="_2、解决方案-2"><a href="#_2、解决方案-2" class="header-anchor">#</a> 2、解决方案</h4> <ul><li>给不同的Key的TTL添加随机值</li> <li>利用Redis集群提高服务的可用性</li> <li>给缓存业务添加降级限流策略</li> <li>给业务添加多级缓存</li></ul> <h3 id="_6、缓存击穿"><a href="#_6、缓存击穿" class="header-anchor">#</a> 6、缓存击穿</h3> <h4 id="_1、定义-3"><a href="#_1、定义-3" class="header-anchor">#</a> 1、定义</h4> <blockquote><p>缓存击穿问题也叫热点Key问题，就是一个被<strong>高并发访问</strong>并且<strong>缓存重建业务较复杂</strong>的key突然失效了，无数的请求访问会在瞬间给数据库带来巨大的冲击。</p></blockquote> <p><img src="/assets/img/image-20220530095954573.1aa7abfc.png" alt="image-20220530095954573"></p> <p>4个线程同时访问，且redis数据失效了，4个线程同时请求，查询缓存，发现未命中，则去查询数据库，重建缓存数据，最后写入缓存。</p> <p>会发现，4个线程会同时访问数据库并写入缓存。</p> <p>解决方案：</p> <ul><li>互斥锁</li> <li>逻辑过期</li></ul> <h4 id="_2、解决方案-3"><a href="#_2、解决方案-3" class="header-anchor">#</a> 2、解决方案</h4> <h5 id="_1、互斥锁"><a href="#_1、互斥锁" class="header-anchor">#</a> 1、互斥锁</h5> <blockquote><p>所谓互斥，就是不同线程，通过竞争进入临界区（共享的数据和硬件资源），为了防止访问冲突，在有限的时间内只允许其中之一独占性的使用共享资源。如不允许同时写。</p></blockquote> <p><img src="/assets/img/image-20220530101002279.2bca4ab5.png" alt="image-20220530101002279"></p> <ol><li>线程1发起请求，查询缓存发现未命中，然后获取互斥锁，成功之后，则去查询数据库重建缓存数据，写入缓存，释放锁。</li> <li>线程2在线程1未释放锁之前发起请求，查询缓存未命中，然后获取互斥锁，发现被线程1占用了，则获取失败，休眠一会儿，再重新获取锁（直到线程1释放），最后缓存命中。</li></ol> <p>存在的问题：互斥等待时间，如果1000个线程同时访问，则只有1个获取成功，其他999个都是在等待，性能会下降</p> <h5 id="_2、逻辑过期"><a href="#_2、逻辑过期" class="header-anchor">#</a> 2、逻辑过期</h5> <blockquote><p>逻辑过期：原来我们存储数据到redis中的时候，存的是k:v键值对，那逻辑过期，就是手动给value增加一个expire时间</p></blockquote> <table><thead><tr><th><strong>KEY</strong></th> <th><strong>VALUE</strong></th></tr></thead> <tbody><tr><td>heima:user:1</td> <td>{name:&quot;Jack&quot;, age:21, <strong>expire:152141223</strong>}</td></tr></tbody></table> <p><img src="/assets/img/image-20220530102216651.2629cbb0.png" alt="image-20220530102216651"></p> <ol><li>线程1发起请求，查询缓存，发现逻辑时间已过期，则回获取互斥锁，此时线程会开启一个新线程2（用于查询数据存入缓存），先返回过期的数据</li> <li>线程2查询数据库后，重建缓存数据，写入缓存后，重置逻辑过期时间，最后释放锁</li> <li>线程3发起请求（与线程1同步），查询缓存，发现逻辑时间已过期，获取互斥锁失败，就先返回旧数据</li> <li>线程4查询缓存，此时线程2已经释放锁，缓存命中，逻辑过期时间未过期，则直接返回</li></ol> <h5 id="_3、比较"><a href="#_3、比较" class="header-anchor">#</a> 3、比较</h5> <table><thead><tr><th><strong>解决方案</strong></th> <th><strong>优点</strong></th> <th><strong>缺点</strong></th></tr></thead> <tbody><tr><td><strong>互斥锁</strong>（一致性）</td> <td>没有额外的内存消耗、保证一致性、实现简单</td> <td>线程需要等待，性能受影响可能有死锁风险</td></tr> <tr><td><strong>逻辑过期</strong>（性能）</td> <td>线程无需等待，性能较好</td> <td>不保证一致性、有额外内存消耗、实现复杂</td></tr></tbody></table> <h4 id="_3、实战-2"><a href="#_3、实战-2" class="header-anchor">#</a> 3、实战</h4> <h5 id="_1、基于互斥锁方式解决缓存击穿问题"><a href="#_1、基于互斥锁方式解决缓存击穿问题" class="header-anchor">#</a> 1、基于互斥锁方式解决缓存击穿问题</h5> <p><img src="/assets/img/image-20220530105046768.890d02ff.png" alt="image-20220530105046768"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 缓存穿透解决方案
     * @param id
     * @return
     */</span>
<span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryByCacheMutex</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//从redis查询缓存</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> shopInfo <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>shopInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//存在则返回</span>
        <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopInfo<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> shopInfo<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//尝试获取互斥锁</span>
        <span class="token keyword">boolean</span> tryLock <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否获取成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tryLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//不成功，则休眠，重试</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">queryByCacheMutex</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//成功则查询数据库</span>
        shop <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//模拟延迟</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//不存在则返回错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> shop<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//将空值写入redis</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_NULL_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//写入缓存 设置超时时间为30min</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//释放锁</span>
        <span class="token function">unLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
     * 获取锁
     * @param key
     * @return
     */</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOCK_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
     * 释放锁
     * @param key
     */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">{</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h5 id="_2、基于逻辑过期方式解决缓存击穿问题"><a href="#_2、基于逻辑过期方式解决缓存击穿问题" class="header-anchor">#</a> 2、基于逻辑过期方式解决缓存击穿问题</h5> <p><img src="/assets/img/image-20220530113335700.83773dfb.png" alt="image-20220530113335700"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Shop</span> <span class="token function">queryWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//从redis查询缓存</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> shopInfo <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>shopInfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//存在则返回</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">RedisData</span> data <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>shopInfo<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LocalDateTime</span> expireTime <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> data<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否过期</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expireTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//未过期，直接返回</span>
        <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//过期则获取互斥锁</span>
    <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> lock <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//获取系统处理器个数，作为线程池数量</span>
        <span class="token comment">//            int nThreads = Runtime.getRuntime().availableProcessors();</span>
        <span class="token comment">//手动创建线程池</span>
        <span class="token class-name">ThreadFactory</span> build <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNamePrefix</span><span class="token punctuation">(</span><span class="token string">&quot;demo-build-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Common Thread Pool</span>
        <span class="token class-name">ExecutorService</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span>
                                                      <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                                                      <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> build<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">saveShopToRedis</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token number">20L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">//释放锁</span>
                <span class="token function">unLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> shop<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
     * 保存数据到redis
     * @param id
     * @param expire
     */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveShopToRedis</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">Long</span> expire<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//查询店铺数据</span>
    <span class="token class-name">Shop</span> byId <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//封装逻辑过期时间</span>
    <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>byId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>expire<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//写入redis</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisData</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> expireTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_7、缓存工具封装"><a href="#_7、缓存工具封装" class="header-anchor">#</a> 7、缓存工具封装</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisCacheClient</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">RedisCacheClient</span><span class="token punctuation">(</span><span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">{</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 逻辑过期时间
     * @param key
     * @param value
     * @param time
     * @param timeUnit
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RedisData</span> redisData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span>timeUnit<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//写入redis</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toJsonStr</span><span class="token punctuation">(</span>redisData<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 缓存穿透
     * @param keyPrefix
     * @param id
     * @param type
     * @param dbFallBack
     * @param time
     * @param timeUnit
     * @param &lt;R&gt;
     * @param &lt;ID&gt;
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span> <span class="token function">queryWithPassThrough</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> dbFallBack<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//从redis查询缓存</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> keyPrefix <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//存在则返回</span>
            <span class="token keyword">return</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> json<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//不存在，则查询数据库</span>
        <span class="token class-name">R</span> r <span class="token operator">=</span> dbFallBack<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//不存在则返回错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> r<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//将空值写入redis</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_NULL_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//写入缓存 设置超时时间为30min</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> r<span class="token punctuation">,</span> time<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//数据库存在，则返回</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 缓存击穿
     * @param keyPrefix
     * @param id
     * @param type
     * @param dbFallBack
     * @param time
     * @param timeUnit
     * @param &lt;R&gt;
     * @param &lt;ID&gt;
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">,</span> ID<span class="token punctuation">&gt;</span></span> <span class="token class-name">R</span>  <span class="token function">queryWithLogicalExpire</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> keyPrefix<span class="token punctuation">,</span> <span class="token class-name">ID</span> id<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> type<span class="token punctuation">,</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span>ID<span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">&gt;</span></span> dbFallBack<span class="token punctuation">,</span> <span class="token class-name">Long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//从redis查询缓存</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> keyPrefix <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//存在则返回</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">RedisData</span> data <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">RedisData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocalDateTime</span> expireTime <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">R</span> r <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">toBean</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> data<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否过期</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expireTime<span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//未过期，直接返回</span>
            <span class="token keyword">return</span> r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//过期则获取互斥锁</span>
        <span class="token class-name">String</span> lockKey <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOCK_SHOP_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> lock <span class="token operator">=</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//获取系统处理器个数，作为线程池数量</span>
<span class="token comment">//            int nThreads = Runtime.getRuntime().availableProcessors();</span>
            <span class="token class-name">ThreadFactory</span> build <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNamePrefix</span><span class="token punctuation">(</span><span class="token string">&quot;demo-build-%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//Common Thread Pool</span>
            <span class="token class-name">ExecutorService</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span>
                    <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> build<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//查询数据库</span>
                    <span class="token class-name">R</span> r1 <span class="token operator">=</span> dbFallBack<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//写入缓存</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setWithLogicalExpire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> r1<span class="token punctuation">,</span> time<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">//释放锁</span>
                    <span class="token function">unLock</span><span class="token punctuation">(</span>lockKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 获取锁
     * @param key
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>LOCK_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放锁
     * @param key
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">{</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br></div></div><p>调用</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//缓存穿透解决方案</span>
    <span class="token class-name">Shop</span> shop <span class="token operator">=</span> redisCacheClient
        <span class="token punctuation">.</span><span class="token function">queryWithPassThrough</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getById</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//缓存击穿</span>
    redisCacheClient<span class="token punctuation">.</span><span class="token function">queryWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_KEY<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token class-name">Shop</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">getById</span><span class="token punctuation">,</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>CACHE_SHOP_TTL<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> shop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;店铺不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shop<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="_3、优惠券秒杀"><a href="#_3、优惠券秒杀" class="header-anchor">#</a> 3、优惠券秒杀</h2> <h3 id="_1、全局唯一id"><a href="#_1、全局唯一id" class="header-anchor">#</a> 1、全局唯一ID</h3> <h4 id="_1、场景引入"><a href="#_1、场景引入" class="header-anchor">#</a> 1、场景引入</h4> <blockquote><p>当用户抢购时，就会生成订单并保存到tb_voucher_order这张表中，而订单表如果使用数据库自增ID就存在一些问题:</p> <ul><li><p>id的规律性太明显</p> <p>例如今天下单的订单ID为10，明天接着下一单，订单号为100，则会知道，今天----明天商城一共卖了90单</p></li> <li><p>受单表数据量的限制</p></li></ul></blockquote> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tb_voucher_order<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单的用户id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>voucher_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'购买的代金券id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pay_type<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'1'</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付方式 1：余额支付；2：支付宝；3：微信'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'1'</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单状态，1：未支付；2：已支付；3：已核销；4：已取消；5：退款中；6：已退款'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'下单时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pay_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>use_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'核销时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>refund_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_general_ci ROW_FORMAT<span class="token operator">=</span>COMPACT<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="_2、全局id生成器"><a href="#_2、全局id生成器" class="header-anchor">#</a> 2、全局ID生成器</h4> <blockquote><p>全局ID生成器，是一种在分布式系统下用来生成全局唯一ID的工具，一般要满足下列特性：</p> <ul><li>唯一性</li> <li>高可用</li> <li>高性能</li> <li>递增性</li> <li>安全性</li></ul></blockquote> <p>为了增加ID的安全性，我们可以不直接使用Redis自增的数值，而是拼接一些其它信息：</p> <p><img src="/assets/img/image-20220601094627079.33b5b849.png" alt="image-20220601094627079"></p> <p>ID的组成部分：</p> <ul><li>符号位：1bit，永远为0</li> <li>时间戳：31bit，以秒为单位，可以使用69年</li> <li>序列号：32bit，秒内的计数器，支持每秒产生2^32个不同ID</li></ul> <h4 id="_3、代码实现"><a href="#_3、代码实现" class="header-anchor">#</a> 3、代码实现</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisIdWorker</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> BEGIN_TIMESTAMP <span class="token operator">=</span> <span class="token number">1640995200L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COUNT_BITS <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * redis 生成器
     * @param keyPrefix
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyPrefix<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//1.生成时间戳</span>
        <span class="token class-name">LocalDateTime</span> now <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> nowSecond <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">toEpochSecond</span><span class="token punctuation">(</span><span class="token class-name">ZoneOffset</span><span class="token punctuation">.</span>UTC<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> nowSecond <span class="token operator">-</span> BEGIN_TIMESTAMP<span class="token punctuation">;</span>
        <span class="token comment">//生成序列号</span>
        <span class="token comment">//获取当前日期，精确到天</span>
        <span class="token class-name">String</span> date <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy:MM:dd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这样可用根据日期去统计订单量 自动拆箱回产生空指针，但事实上这里并不会，redis发现没有，会自动生成</span>
        <span class="token keyword">long</span> increment <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">&quot;icr:&quot;</span> <span class="token operator">+</span> keyPrefix <span class="token operator">+</span> date<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拼接返回</span>
        <span class="token comment">// 这里拼接返回的是long类型，字符串拼接返回的是字符串</span>
        <span class="token comment">//这里需要使用 位运算 时间戳向左移动32位 在高位, 系列号采用或运算去填充</span>
        <span class="token keyword">return</span> timestamp <span class="token operator">&lt;&lt;</span> COUNT_BITS <span class="token operator">|</span> increment<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 测试并发的情况
     */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">redisIdTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadFactory</span> build <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setNamePrefix</span><span class="token punctuation">(</span><span class="token string">&quot;redis_id_%d&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//定义500个线程池</span>
    <span class="token class-name">ExecutorService</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span>
                                                  <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span>
                                                  <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> build<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Runnable</span> task <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> order <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;id=&quot;</span> <span class="token operator">+</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;耗时：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>全局唯一ID生成策略：</p> <ul><li><p>UUID</p></li> <li><p>Redis自增</p></li> <li><p>snowflake算法</p></li> <li><p>数据库自增</p></li></ul> <p>Redis自增ID策略：</p> <ul><li>每天一个key，方便统计订单量</li> <li>ID构造是 时间戳 + 计数器</li></ul> <h3 id="_2、实现优惠券秒杀下单"><a href="#_2、实现优惠券秒杀下单" class="header-anchor">#</a> 2、实现优惠券秒杀下单</h3> <p><img src="/assets/img/image-20220601151810477.0439669b.png" alt="image-20220601151810477"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询优惠券信息</span>
    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> voucher<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券不存在！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//判断时间是否开始或过期</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀未开始！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀已结束！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//判断库存是否充足</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&gt;</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//扣减库存</span>
    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//创建订单</span>
    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建订单号</span>
    <span class="token keyword">long</span> id <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回订单号</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="_3、超卖问题"><a href="#_3、超卖问题" class="header-anchor">#</a> 3、超卖问题</h3> <h4 id="_1、问题描述"><a href="#_1、问题描述" class="header-anchor">#</a> 1、问题描述</h4> <blockquote><p>超卖问题是指卖出的数量已经超出库存了</p></blockquote> <p><img src="/assets/img/image-20220601163448492.99bd9ba0.png" alt="image-20220601163448492"></p> <p>库存数据为：1</p> <ol><li>线程1、线程2同时发出请求，查询库存，为1</li> <li>线程1判断是否大于0，此时为true，则扣减库存，此时库存为0</li> <li>线程2判断是否大于0，此时为true，则扣减库存，此时库存为-1</li></ol> <h4 id="_2、解决方案-4"><a href="#_2、解决方案-4" class="header-anchor">#</a> 2、解决方案</h4> <blockquote><p>超卖问题是典型的多线程安全问题，针对这一问题的常见解决方案就是加锁：</p> <ul><li>乐观锁</li> <li>悲观锁</li></ul></blockquote> <h5 id="_1、乐观锁"><a href="#_1、乐观锁" class="header-anchor">#</a> 1、乐观锁</h5> <p>认为线程安全问题不一定会发生，因此不加锁，只是在更新数据时去判断有没有其它线程对数据做了修改。</p> <ul><li>如果没有修改则认为是安全的，自己才更新数据。</li> <li>如果已经被其它线程修改说明发生了安全问题，此时可以重试或异常。</li></ul> <blockquote><p>乐观锁的关键是判断之前查询得到的数据是否有被修改过，常见的方式有两种：</p> <ul><li>版本号法</li> <li>CAS法</li></ul></blockquote> <h6 id="_1、版本号法"><a href="#_1、版本号法" class="header-anchor">#</a> 1、版本号法</h6> <blockquote><p>每次修改库存时，版本号+1，修改时根据查询的版本号进行修改</p></blockquote> <p><img src="/assets/img/image-20220601164113044.3b1a487c.png" alt="image-20220601164113044"></p> <p>初始库存为1，版本号为1</p> <ol><li>线程1查询库存和版本号都是为1，判断是否大于0，大于0则进行修改且版本号+1，扣减成功</li> <li>线程1查询库存和版本号都是为1，判断是否大于0，大于0则进行修改且版本号+1，此时线程1已经修改版本号为2了，所以不执行</li></ol> <h6 id="_2、cas方法"><a href="#_2、cas方法" class="header-anchor">#</a> 2、CAS方法</h6> <p><img src="/assets/img/image-20220601165829143.4374274a.png" alt="image-20220601165829143"></p> <p>初始库存为1，版本号为1</p> <ol><li>线程1查询库存为1，判断是否大于0，大于0则进行修改，扣减成功</li> <li>线程1查询库存为1，判断是否大于0，大于0则进行修改，此时线程1已经修改库存为0了，所以不执行</li></ol> <p>代码实现：</p> <p>采用的是<code>jmeter</code>模拟并发请求</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询优惠券信息</span>
    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> voucher<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券不存在！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//判断时间是否开始或过期</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀未开始！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀已结束！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//判断库存是否充足</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&gt;</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//扣减库存</span>
    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//创建订单</span>
    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建订单号</span>
    <span class="token keyword">long</span> id <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回订单号</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>相比优惠券秒杀下单，修改的地方：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>使用多线程模拟秒杀后，发现异常比例反而增加了</p> <p><img src="data:image/png;base64,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" alt="image-20220601170300196"></p> <p>原因：这是因为多线程访问的时候，一个线程进行修改了，那其他99个线程都未修改成功，订单失败。这也是乐观锁的一个缺点</p> <p><strong>改进方法</strong></p> <blockquote><p>前面是用库存代表的版本号进行控制高并发方法，但是其实只要库存量大于0的时候，都允许线程进行修改，这样就控制了高并发</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//扣减库存</span>
<span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="data:image/png;base64,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" alt="image-20220601171205373"></p> <p>符合预期</p> <h5 id="_2、悲观锁"><a href="#_2、悲观锁" class="header-anchor">#</a> 2、悲观锁</h5> <p>认为线程安全问题一定会发生，因此在操作数据之前先获取锁，确保线程串行执行。</p> <ul><li>例如Synchronized、Lock都属于悲观锁</li></ul> <h4 id="_3、总结-2"><a href="#_3、总结-2" class="header-anchor">#</a> 3、总结</h4> <p>超卖这样的线程安全问题，解决方案有哪些？</p> <ol><li>悲观锁：添加同步锁，让线程串行执行
<ul><li>优点：简单粗暴</li> <li>缺点：性能一般</li></ul></li> <li>乐观锁：不加锁，在更新时判断是否有其它线程在修改
<ul><li>优点：性能好</li> <li>缺点：存在成功率低的问题</li></ul></li></ol> <h3 id="_4、一人一单"><a href="#_4、一人一单" class="header-anchor">#</a> 4、一人一单</h3> <h4 id="_1、场景"><a href="#_1、场景" class="header-anchor">#</a> 1、场景</h4> <blockquote><p>需求：修改秒杀业务，要求同一个优惠券，一个用户只能下一单</p></blockquote> <p><img src="/assets/img/image-20220606151508748.3eb76808.png" alt="image-20220606151508748"></p> <h5 id="_1、代码实现"><a href="#_1、代码实现" class="header-anchor">#</a> 1、代码实现</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询优惠券信息</span>
    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> voucher<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券不存在！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//判断时间是否开始或过期</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀未开始！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀已结束！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//判断库存是否充足</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&gt;</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//一人一单</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//查询订单</span>
    <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;用户已经购买过一次了！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//扣减库存</span>
    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//创建订单</span>
    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建订单号</span>
    <span class="token keyword">long</span> id <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回订单号</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h5 id="_2、结果"><a href="#_2、结果" class="header-anchor">#</a> 2、结果</h5> <blockquote><p>发现数据库中存在10同一用户的订单</p></blockquote> <h5 id="_3、解决方案"><a href="#_3、解决方案" class="header-anchor">#</a> 3、解决方案</h5> <blockquote><p>很明显，这是线程并发问题，解决就是加锁，到底是加乐观锁呢还是悲观锁？</p> <p>这时我们分析一下，乐观锁认为在线程执行的时候，没有其他线程来修改之前的数据，悲观锁则是认为有人修改它的数据</p> <p>这里我们要控制的是同一个用户只能下一单，可以锁住用户ID来进行解决，则采用悲观锁<code>synchronized</code></p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询优惠券信息</span>
    <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> voucher<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券不存在！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//判断时间是否开始或过期</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀未开始！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀已结束！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//判断库存是否充足</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&gt;</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回字符串对象的规范表示。</span>
    <span class="token comment">//一个字符串池，最初是空的，由String类私下维护。</span>
    <span class="token comment">//当调用 intern 方法时，如果池中已经包含一个等于该String对象的字符串，由equals(Object)方法确定，则返回池中的字符串。否则，将此String对象添加到池中并返回对该String对象的引用。</span>
    <span class="token comment">//因此，对于任何两个字符串s和t ，当且仅当s.equals(t)为true时， s.intern() == t.intern()才为true 。</span>
    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取代理对象（事务）</span>
        <span class="token class-name">IVoucherOrderService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//一人一单</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//查询订单</span>
    <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;用户已经购买过一次了！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//扣减库存</span>
    <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//创建订单</span>
    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//创建订单号</span>
    <span class="token keyword">long</span> id <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回订单号</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><h6 id="引入依赖"><a href="#引入依赖" class="header-anchor">#</a> 引入依赖</h6> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.aspectj<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>aspectjweaver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h6 id="主启动类引入注解"><a href="#主启动类引入注解" class="header-anchor">#</a> 主启动类引入注解</h6> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//开启代理</span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>exposeProxy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">&quot;com.hmdp.mapper&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HmDianPingApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">HmDianPingApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_2、集群环境下一人一单"><a href="#_2、集群环境下一人一单" class="header-anchor">#</a> 2、集群环境下一人一单</h4> <h5 id="_1、创建服务集群"><a href="#_1、创建服务集群" class="header-anchor">#</a> 1、创建服务集群</h5> <p>1.复制一份微服务</p> <p><img src="/assets/img/image-20220607085156251.d71948b5.png" alt="image-20220607085156251"></p> <p>若找不到Service，可去view-&gt;Tool Windows-&gt;Services，然后Run Configure Type，选择Spring Boot项目即可</p> <p><img src="/assets/img/image-20220607085254800.71afeda5.png" alt="image-20220607085254800"></p> <p>2.配置名称以及覆盖之前的端口</p> <p><img src="/assets/img/image-20220607085445943.f1e62657.png" alt="image-20220607085445943"></p> <p>3.配置nginx作负载均衡</p> <div class="language-conf line-numbers-mode"><pre class="language-text"><code>upstream backend {
server 127.0.0.1:8081 max_fails=5 fail_timeout=10s weight=1;
server 127.0.0.1:8082 max_fails=5 fail_timeout=10s weight=1;
} 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>现在，用户请求会在这两个节点上负载均衡，再次测试下是否存在线程安全问题。</p> <h6 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h6> <h4 id="_3、一人一单的并发问题"><a href="#_3、一人一单的并发问题" class="header-anchor">#</a> 3、一人一单的并发问题</h4> <p><img src="/assets/img/image-20220607101209492.a72a7b64.png" alt="image-20220607101209492"></p> <p>对于多个微服务来说，锁监视器 锁住的是线程，而不是我们自定义的代码块，每个微服务都有一个JVM，而每个JVM都会存在锁，此时并发问题还是会存在。</p> <h3 id="_5、分布式锁"><a href="#_5、分布式锁" class="header-anchor">#</a> 5、分布式锁</h3> <h4 id="_1、场景引入-2"><a href="#_1、场景引入-2" class="header-anchor">#</a> 1、场景引入</h4> <blockquote><p>对于一人一单并发问题，可以把锁从内部提取出来，放在外部进行监视锁，这样，不管有多少个服务，共用一把锁，即可解决并发问题</p></blockquote> <p><img src="/assets/img/image-20220607101445017.8c944dc7.png" alt="image-20220607101445017"></p> <h4 id="_2、定义"><a href="#_2、定义" class="header-anchor">#</a> 2、定义</h4> <blockquote><p><strong>分布式锁</strong>：满足分布式系统或集群模式下多进程可见并且互斥的锁。</p></blockquote> <p><img src="/assets/img/image-20220607101719652.8fb5703d.png" alt="image-20220607101719652"></p> <h4 id="_3、实现"><a href="#_3、实现" class="header-anchor">#</a> 3、实现</h4> <p>分布式锁的核心是实现多进程之间互斥，而满足这一点的方式有很多，常见的有三种：</p> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;"><strong>MySQL</strong></th> <th style="text-align:center;"><strong>Redis</strong></th> <th style="text-align:center;"><strong>Zookeeper</strong></th></tr></thead> <tbody><tr><td style="text-align:center;">**互斥 **</td> <td style="text-align:center;">利用mysql本身的互斥锁机制</td> <td style="text-align:center;">利用setnx这样的互斥命令</td> <td style="text-align:center;">利用节点的唯一性和有序性实现互斥</td></tr> <tr><td style="text-align:center;">**高可用 **</td> <td style="text-align:center;">好</td> <td style="text-align:center;">好</td> <td style="text-align:center;">好</td></tr> <tr><td style="text-align:center;">**高性能 **</td> <td style="text-align:center;">一般</td> <td style="text-align:center;">好</td> <td style="text-align:center;">一般</td></tr> <tr><td style="text-align:center;">**安全性 **</td> <td style="text-align:center;">断开连接，自动释放锁</td> <td style="text-align:center;">利用锁超时时间，到期释放</td> <td style="text-align:center;">临时节点，断开连接自动释放</td></tr></tbody></table> <h4 id="_4、基于redis的分布式锁"><a href="#_4、基于redis的分布式锁" class="header-anchor">#</a> 4、基于Redis的分布式锁</h4> <p>实现分布式锁时需要实现的两个基本方法：</p> <ul><li>获取锁</li> <li>释放锁</li></ul> <h5 id="_1、获取锁"><a href="#_1、获取锁" class="header-anchor">#</a> 1、获取锁</h5> <blockquote><p>互斥：确保只能有一个线程获取锁</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 添加锁，利用setnx的互斥特性</span>
SETNX lock thread1
<span class="token comment"># 添加锁过期时间，避免服务宕机引起的死锁</span>
EXPIRE lock <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但是如果在添加锁与添加锁的过期时间之间，redis宕机了，这是我们就灭法释放锁，这是就会一直存在</p> <p><code>SET</code>有一次性到位的命令</p> <blockquote><p>非阻塞：尝试一次，成功返回true，失败返回false</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 添加锁，NX是互斥、EX是设置超时时间</span>
SET lock thread1 NX EX <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="_2、释放锁"><a href="#_2、释放锁" class="header-anchor">#</a> 2、释放锁</h5> <blockquote><ul><li>手动释放</li> <li>超时释放：获取锁时添加一个超时时间</li></ul></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 释放锁，删除即可</span>
DEL key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="_3、整体流程"><a href="#_3、整体流程" class="header-anchor">#</a> 3、整体流程</h5> <p><img src="/assets/img/image-20220607103639624.31e23d86.png" alt="image-20220607103639624"></p> <ol><li>尝试获取锁，判断获取锁的返回结果</li> <li>返回OK，则表示获取锁成功，执行相应的业务，最后释放锁</li> <li>返回nil，则表示获取锁失败</li> <li>若存在业务超时或服务宕机，则会利用超时时间释放锁</li></ol> <h5 id="_4、代码实现"><a href="#_4、代码实现" class="header-anchor">#</a> 4、代码实现</h5> <ol><li><p>定义一个锁接口，用户获取和释放锁，利用Redis实现分布式锁功能</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ILock</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 尝试获取锁
     * @param timeoutSec 锁持有的超时时间，过期后自动释放
     * @return true代表获取锁成功; false代表获取锁失败
     **/</span>
    <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutSec<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 释放锁
     */</span>
    <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li> <li><p>新建类实现锁接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">ILock</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> KEY_PREFIX <span class="token operator">=</span> <span class="token string">&quot;lock:&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutSec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取线程标识</span>
        <span class="token keyword">long</span> threadId <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取锁</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> threadId <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> timeoutSec<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放锁
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div></li> <li><p>修改下单的锁逻辑，之前采用的是悲观锁，现在引入自定义锁</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//查询优惠券信息</span>
        <span class="token class-name">SeckillVoucher</span> voucher <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> voucher<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;优惠券不存在！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//判断时间是否开始或过期</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAfter</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀未开始！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;秒杀已结束！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//判断库存是否充足</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&gt;</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回字符串对象的规范表示。</span>
        <span class="token comment">//一个字符串池，最初是空的，由String类私下维护。</span>
        <span class="token comment">//当调用 intern 方法时，如果池中已经包含一个等于该String对象的字符串，由equals(Object)方法确定，则返回池中的字符串。否则，将此String对象添加到池中并返回对该String对象的引用。</span>
        <span class="token comment">//因此，对于任何两个字符串s和t ，当且仅当s.equals(t)为true时， s.intern() == t.intern()才为true 。</span>
<span class="token comment">//        synchronized(userId.toString().intern()) {</span>
<span class="token comment">//            //获取代理对象（事务）</span>
<span class="token comment">//            IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();</span>
<span class="token comment">//            return proxy.createVoucherOrder(voucherId);</span>
<span class="token comment">//        }</span>
        <span class="token comment">//创建锁对象</span>
        <span class="token class-name">SimpleRedisLock</span> redisLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">,</span> stringRedisTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> redisLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取锁失败</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//返回错误</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;不允许重复下单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">IVoucherOrderService</span> proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//释放锁</span>
            redisLock<span class="token punctuation">.</span><span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//一人一单</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//查询订单</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;用户已经购买过一次了！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//扣减库存</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//创建订单</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建订单号</span>
        <span class="token keyword">long</span> id <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回订单号</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div></li></ol> <h5 id="_5、存在的问题"><a href="#_5、存在的问题" class="header-anchor">#</a> 5、存在的问题</h5> <p><img src="/assets/img/image-20220607161952382.1a584b2a.png" alt="image-20220607161952382"></p> <ol><li>线程1获取锁之后，执行业务阻塞了，此时超时释放锁</li> <li>线程2请求获取锁成功后，线程1的业务执行完成，并释放锁</li> <li>线程3同理</li></ol> <blockquote><p>线程1在执行完业务之后，释放的锁并不是自己持有的锁，而是线程2获取到的锁，</p></blockquote> <h5 id="_6、优化"><a href="#_6、优化" class="header-anchor">#</a> 6、优化</h5> <p><img src="/assets/img/image-20220607163019509.b9234ae3.png" alt="image-20220607163019509"></p> <p><img src="/assets/img/image-20220607163030830.deb29faa.png" alt="image-20220607163030830"></p> <blockquote><p>需求：修改之前的分布式锁实现，满足：</p> <ul><li>在获取锁时存入线程标示（可以用UUID表示）</li> <li>在释放锁时先获取锁中的线程标示，判断是否与当前线程标示一致
<ul><li>如果一致则释放锁</li> <li>如果不一致则不释放锁</li></ul></li></ul></blockquote> <p>修改获取锁和释放锁的实现</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">ILock</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> KEY_PREFIX <span class="token operator">=</span> <span class="token string">&quot;lock:&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ID_PREFIX <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutSec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取线程标识</span>
        <span class="token class-name">String</span> threadId <span class="token operator">=</span> ID_PREFIX <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取锁</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> timeoutSec<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放锁
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取线程标识</span>
        <span class="token class-name">String</span> threadId <span class="token operator">=</span> ID_PREFIX <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断标识是否一致</span>
        <span class="token class-name">String</span> id <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>threadId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h5 id="_7、redis的lua脚本"><a href="#_7、redis的lua脚本" class="header-anchor">#</a> 7、Redis的Lua脚本</h5> <blockquote><p>Redis提供了Lua脚本功能，在一个脚本中编写多条Redis命令，确保多条命令执行时的原子性。Lua是一种编程语言，它的基本语法大家可以参考网站：https://www.runoob.com/lua/lua-tutorial.html</p></blockquote> <p>介绍Redis提供的调用函数，语法如下：</p> <p><img src="data:image/png;base64,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" alt="image-20220608105654500"></p> <p>例如，我们要执行set name jack，则脚本是这样：</p> <p><img src="data:image/png;base64,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" alt="image-20220608105709727"></p> <p>例如，我们要先执行set name Rose，再执行get name，则脚本如下：</p> <p><img src="/assets/img/image-20220608105720854.655a57b0.png" alt="image-20220608105720854"></p> <p>写好脚本以后，需要用Redis命令来调用脚本，调用脚本的常见命令如下：</p> <p><img src="/assets/img/image-20220608105735275.e65ff236.png" alt="image-20220608105735275"></p> <p>例如，我们要执行 redis.call('set', 'name', 'jack') 这个脚本，语法如下：</p> <p><img src="data:image/png;base64,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" alt="image-20220608105745839"></p> <p>如果脚本中的key、value不想写死，可以作为参数传递。key类型参数会放入KEYS数组，其它参数会放入ARGV数组，在脚本中可以从KEYS和ARGV数组获取这些参数：</p> <p><img src="/assets/img/image-20220608105849968.f1a7cc9d.png" alt="image-20220608105849968"></p> <p><strong>释放锁的业务流程是这样的：</strong></p> <ol><li>获取锁中的线程标示</li> <li>判断是否与指定的标示（当前线程标示）一致</li> <li>如果一致则释放锁（删除）</li> <li>如果不一致则什么都不做</li></ol> <p>如果用Lua脚本来表示则是这样的：</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">-- 锁的key</span>
<span class="token keyword">local</span> key <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- 当前线程标识</span>
<span class="token keyword">local</span> threadId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">---</span>
<span class="token comment">---获取锁中的线程标识</span>
<span class="token comment">---</span>
<span class="token keyword">local</span> id <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
<span class="token comment">-- 比较是否一致</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> threadId<span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">-- 释放锁 del key</span>
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'del'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">------------------------------------------------------简化版-------------------------------------------------</span>

<span class="token comment">-- 这里的 KEYS[1] 就是锁的key，这里的ARGV[1] 就是当前线程标示</span>
<span class="token comment">-- 获取锁中的标示，判断是否与当前线程标示一致</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
  <span class="token comment">-- 一致，则删除锁</span>
  <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'DEL'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token comment">-- 不一致，则直接返回</span>
<span class="token keyword">return</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h5 id="_8、再次改进redis的分布式锁"><a href="#_8、再次改进redis的分布式锁" class="header-anchor">#</a> 8、再次改进Redis的分布式锁</h5> <p>需求：基于Lua脚本实现分布式锁的释放锁逻辑
提示：RedisTemplate调用Lua脚本的API如下：</p> <p><img src="/assets/img/image-20220608110129568.ceac5b0f.png" alt="image-20220608110129568"></p> <p>这里只需要更改释放锁的逻辑即可，把unlock.lua脚本放到resource目录下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRedisLock</span> <span class="token keyword">implements</span> <span class="token class-name">ILock</span><span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SimpleRedisLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringRedisTemplate <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> KEY_PREFIX <span class="token operator">=</span> <span class="token string">&quot;lock:&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> ID_PREFIX <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">;</span>
    
    <span class="token comment">//设置为静态，不需要每次释放锁都调用一次基本</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> UNLOCK_SCRIPT<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        UNLOCK_SCRIPT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用resource下的unlock脚本</span>
        UNLOCK_SCRIPT<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;unlock.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        UNLOCK_SCRIPT<span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeoutSec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取线程标识</span>
        <span class="token class-name">String</span> threadId <span class="token operator">=</span> ID_PREFIX <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取锁</span>
        <span class="token class-name">Boolean</span> flag <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> timeoutSec<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span>TRUE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 通过lua脚本释放锁
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//调用lua脚本</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                UNLOCK_SCRIPT<span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>KEY_PREFIX <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
                ID_PREFIX <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><h5 id="_9、总结"><a href="#_9、总结" class="header-anchor">#</a> 9、总结</h5> <blockquote><p>基于Redis的分布式锁实现思路：</p> <ul><li>利用set nx ex获取锁，并设置过期时间，保存线程标示</li> <li>释放锁时先判断线程标示是否与自己一致，一致则删除锁</li></ul> <p>特性：</p> <ul><li>利用set nx满足互斥性</li> <li>利用set ex保证故障时锁依然能释放，避免死锁，提高安全性</li> <li>利用Redis集群保证高可用和高并发特性</li></ul></blockquote> <h4 id="_5、基于redis的分布式锁优化"><a href="#_5、基于redis的分布式锁优化" class="header-anchor">#</a> 5、基于Redis的分布式锁优化</h4> <h5 id="_1、基于setnx实现的分布式锁存在的问题"><a href="#_1、基于setnx实现的分布式锁存在的问题" class="header-anchor">#</a> 1、基于setnx实现的分布式锁存在的问题</h5> <ol><li><p><strong>不可重入</strong>：同一个线程无法多次获取同一把锁</p> <blockquote><p>例如：方法A先获取锁，调用方法B中的业务，B也想获取同一把锁，此时无法获取到锁，只能等待A释放</p></blockquote></li> <li><p><strong>不可重试</strong>：获取锁只尝试一次就返回false，没有重试机制</p> <blockquote><p>很多业务下，不能返回立即失败，而是需要等待，重试</p></blockquote></li> <li><p><strong>超时释放</strong>：锁超时释放虽然可避免死锁，但如果业务执行耗时较长，也会导致锁释放，存在安全隐患</p> <blockquote><p>虽然之前利用判断锁标识，<code>Lua</code>脚本解决了因为超时释放解决的误删问题，</p></blockquote></li> <li><p><strong>主从一致性</strong>：如果Redis提供了主从集群，主从同步存在延迟，当主宕机时，如果从同步主中的锁数据，则会出现锁实现</p></li></ol> <h5 id="_2、redisson"><a href="#_2、redisson" class="header-anchor">#</a> 2、Redisson</h5> <blockquote><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务，其中就包含了各种分布式锁的实现。</p> <p><img src="/assets/img/image-20220608112545796.c7135c7d.png" alt="image-20220608112545796"></p></blockquote> <p>官网地址： https://redisson.org</p> <p>GitHub地址： https://github.com/redisson/redisson</p> <h6 id="_1、redisson入门"><a href="#_1、redisson入门" class="header-anchor">#</a> 1、Redisson入门</h6> <p>1、引入依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.17.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>2、配置Redisson客户端</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加redis地址，这里添加了单点的地址，也可以使用config.useClusterServers()添加集群地址</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://127.0.0.1:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建redisson对象 创建客户端</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>3、使用Redisson的分布式锁</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取锁（可重入），指定锁的名称 </span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;anyLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token comment">// 尝试获取锁，参数分别是：获取锁的最大等待时间（期间会重试），锁自动释放时间，时间单位   </span>
    <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token comment">// 判断释放获取成功   </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isLock<span class="token punctuation">)</span><span class="token punctuation">{</span>      
        <span class="token keyword">try</span> <span class="token punctuation">{</span>            
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行业务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>            
            <span class="token comment">// 释放锁          </span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h6 id="_2、redisson可重入锁原理"><a href="#_2、redisson可重入锁原理" class="header-anchor">#</a> 2、Redisson可重入锁原理</h6> <blockquote><p>为了避免并发安全问题，释放不是自己的锁，这里采用的是锁计数器，获取锁+1，判断是否为自己的锁-1，最终计数为0</p></blockquote> <p><img src="/assets/img/image-20220608155131193.f5f5e81d.png" alt="image-20220608155131193"></p> <p><strong>测试类</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">RLock</span> lock<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">121312</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//获取锁对象</span>
        <span class="token keyword">boolean</span> tryLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tryLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁失败！，1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁成功，1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;释放锁，1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> tryLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tryLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁失败！，2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁成功！，2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;释放锁！，2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>PS：这里<code>@Test</code>注解需引入<code>import org.junit.jupiter.api.Test;</code>而不是<code>import org.junit.Test;</code>，否则<code>@BeforeEach</code>不会执行</p> <p><code>@BeforeEach</code>：</p> <p>获取锁的<code>Lua</code>脚本</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">-- 锁的key</span>
<span class="token keyword">local</span> key <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- 当前线程标识</span>
<span class="token keyword">local</span> threadId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">--锁的自动释放时间</span>
<span class="token keyword">local</span> releaseTime <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token comment">--判断是否存在</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'exist'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">--不存在，则释放锁</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hset'</span><span class="token punctuation">,</span>key<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
    <span class="token comment">--设置有效期</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'expire'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> releaseTime<span class="token punctuation">)</span>
    <span class="token comment">--返回结果</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
<span class="token keyword">end</span>
<span class="token comment">--锁已经存在，判断threadId是否是自己的</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hexist'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">--不存在，则获取锁，重入次数+1</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hincrby'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span>
    <span class="token comment">--设置有效期</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'expire'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> releaseTime<span class="token punctuation">)</span>
    <span class="token comment">--返回结果</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>
<span class="token comment">-- 代码走到这里,说明获取锁的不是自己，获取锁失败</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>释放锁的<code>Lua</code>脚本</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token keyword">local</span> key <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">-- 锁的key</span>
<span class="token keyword">local</span> threadId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">-- 线程唯一标识</span>
<span class="token keyword">local</span> releaseTime <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">-- 锁的自动释放时间</span>
<span class="token comment">-- 判断当前锁是否还是被自己持有</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'HEXISTS'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">;</span>
    <span class="token comment">-- 如果已经不是自己，则直接返回</span>
<span class="token keyword">end</span>
<span class="token comment">-- 是自己的锁，则重入次数-1</span>
<span class="token keyword">local</span> count <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'HINCRBY'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 判断是否重入次数是否已经为0</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
<span class="token comment">-- 大于0说明不能释放锁，重置有效期然后返回</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'EXPIRE'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> releaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">;</span>
<span class="token keyword">else</span>  <span class="token comment">-- 等于0说明可以释放锁，直接删除</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'DEL'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h6 id="_3、redisson分布式锁原理"><a href="#_3、redisson分布式锁原理" class="header-anchor">#</a> 3、Redisson分布式锁原理</h6> <p><img src="/assets/img/image-20220609092712952.66975d3d.png" alt="image-20220609092712952"></p> <h6 id="_4、总结-2"><a href="#_4、总结-2" class="header-anchor">#</a> 4、总结</h6> <p>Redisson分布式锁原理：</p> <ul><li>可重入：利用hash结构记录线程id和重入次数</li> <li>可重试：利用信号量和PubSub功能实现等待、唤醒，获取锁失败的重试机制</li> <li>超时续约：利用watchDog，每隔一段时间（releaseTime / 3），重置超时时间</li></ul> <h6 id="_5、redisson分布式锁主从一致性问题"><a href="#_5、redisson分布式锁主从一致性问题" class="header-anchor">#</a> 5、Redisson分布式锁主从一致性问题</h6> <p><img src="/assets/img/image-20220609094007927.966566d8.png" alt="image-20220609094007927"></p> <p>Redis集群</p> <blockquote><p>存在一瞬间，redis主机突然宕机了，且此时锁并未同步到从机，此时就会出现线程并发问题，可以从其他的主机都获取到锁</p></blockquote> <p><strong>Redisson解决</strong></p> <p><img src="/assets/img/image-20220609094244997.0fc128c9.png" alt="image-20220609094244997"></p> <p>Redisson分别从所有主机获取锁，当从所有主机获取到锁且一致时，才会获取锁成功，其他一台宕机了，则会获取锁失败，这种设计也叫做联锁。</p> <blockquote><p><strong>联锁（MultiLock）</strong></p> <p>基于Redis的Redisson分布式联锁<a href="http://static.javadoc.io/org.redisson/redisson/3.10.0/org/redisson/RedissonMultiLock.html" target="_blank" rel="noopener noreferrer"><code>RedissonMultiLock</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>对象可以将多个<code>RLock</code>对象关联为一个联锁，每个<code>RLock</code>对象实例可以来自于不同的Redisson实例。</p></blockquote> <p>大家都知道，如果负责储存某些分布式锁的某些Redis节点宕机以后，而且这些锁正好处于锁住的状态时，这些锁会出现锁死的状态。为</p> <p>了避免这种情况的发生，Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期。默</p> <p>认情况下，看门狗的检查锁的超时时间是30秒钟，也可以通过修改<a href="https://github.com/redisson/redisson/wiki/2.-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95#lockwatchdogtimeout%E7%9B%91%E6%8E%A7%E9%94%81%E7%9A%84%E7%9C%8B%E9%97%A8%E7%8B%97%E8%B6%85%E6%97%B6%E5%8D%95%E4%BD%8D%E6%AF%AB%E7%A7%92" target="_blank" rel="noopener noreferrer">Config.lockWatchdogTimeout<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来另行指定。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">RLock</span> lock1 <span class="token operator">=</span> redissonInstance1<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RLock</span> lock2 <span class="token operator">=</span> redissonInstance2<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RLock</span> lock3 <span class="token operator">=</span> redissonInstance3<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">RedissonMultiLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedissonMultiLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">,</span> lock3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 同时加锁：lock1 lock2 lock3</span>
<span class="token comment">// 所有的锁都上锁成功才算成功。</span>
lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>测试</strong></p> <p>1.修改Redisson配置类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加redis地址，这里添加了单点的地址，也可以使用config.useClusterServers()添加集群地址</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://127.0.0.1:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建redisson对象 创建客户端</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加redis地址，这里添加了单点的地址，也可以使用config.useClusterServers()添加集群地址</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://127.0.0.1:6380&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建redisson对象 创建客户端</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>2、修改测试类</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedissonTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient1<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">RLock</span> lock<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">121312</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> lock1 <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> lock2 <span class="token operator">=</span> redissonClient1<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedissonMultiLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//获取锁对象</span>
        <span class="token keyword">boolean</span> tryLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tryLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁失败！，1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁成功，1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;释放锁，1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> tryLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tryLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁失败！，2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁成功！，2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;释放锁！，2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p><strong>总结：</strong></p> <ol><li>不可重入Redis分布式锁：
<ul><li>原理：利用setnx的互斥性；利用ex避免死锁；释放锁时判断线程标示</li> <li>缺陷：不可重入、无法重试、锁超时失效</li></ul></li> <li>可重入的Redis分布式锁：
<ul><li>原理：利用hash结构，记录线程标示和重入次数；利用watchDog延续锁时间；利用信号量控制锁重试等待</li> <li>缺陷：redis宕机引起锁失效问题</li></ul></li> <li>Redisson的multiLock：
<ul><li>原理：多个独立的Redis节点，必须在所有节点都获取重入锁，才算获取锁成功</li> <li>缺陷：运维成本高、实现复杂</li></ul></li></ol> <h3 id="_6、redis优化秒杀"><a href="#_6、redis优化秒杀" class="header-anchor">#</a> 6、Redis优化秒杀</h3> <h4 id="_1、场景-2"><a href="#_1、场景-2" class="header-anchor">#</a> 1、场景</h4> <blockquote><p>多用户同时请求下单时，延迟过高，tomcat需要操作整套流程</p></blockquote> <p><img src="/assets/img/image-20220609104632967.ea0b0698.png" alt="image-20220609104632967"></p> <h4 id="_2、优化方案"><a href="#_2、优化方案" class="header-anchor">#</a> 2、优化方案</h4> <blockquote><p>核心的处理是：判断秒杀库存和一人一单，可采用多个线程的方式完成下单</p></blockquote> <p><img src="/assets/img/image-20220609104826060.70e27489.png" alt="image-20220609104826060"></p> <p>整体流程：</p> <blockquote><p>Lua脚本保证redis的原子性，要么全部成功，要么就全部不执行</p> <p>userId存入set集合，保证用户一人一单</p></blockquote> <p><img src="/assets/img/image-20220609110604591.6f7ea946.png" alt="image-20220609110604591"></p> <h4 id="_3、改进秒杀业务-提高并发性能"><a href="#_3、改进秒杀业务-提高并发性能" class="header-anchor">#</a> 3、改进秒杀业务，提高并发性能</h4> <blockquote><p>需求：</p> <ul><li>新增秒杀优惠券的同时，将优惠券信息保存到Redis中</li> <li>基于Lua脚本，判断秒杀库存、一人一单，决定用户是否抢购成功</li> <li>如果抢购成功，将优惠券id和用户id封装后存入阻塞队列</li> <li>开启线程任务，不断从阻塞队列中获取信息，实现异步下单功能</li></ul></blockquote> <h5 id="_1、新增秒杀优惠券的同时-将优惠券信息保存到redis中"><a href="#_1、新增秒杀优惠券的同时-将优惠券信息保存到redis中" class="header-anchor">#</a> 1、新增秒杀优惠券的同时，将优惠券信息保存到Redis中</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addSeckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Voucher</span> voucher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保存优惠券</span>
    <span class="token function">save</span><span class="token punctuation">(</span>voucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存秒杀信息</span>
    <span class="token class-name">SeckillVoucher</span> seckillVoucher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeckillVoucher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setStock</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setBeginTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getBeginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucher<span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span>voucher<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    seckillVoucherService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>seckillVoucher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//保存秒杀到redis</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>SECKILL_STOCK_KEY <span class="token operator">+</span> voucher<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> voucher<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h5 id="_2、基于lua脚本-判断秒杀库存、一人一单-决定用户是否抢购成功"><a href="#_2、基于lua脚本-判断秒杀库存、一人一单-决定用户是否抢购成功" class="header-anchor">#</a> 2、基于Lua脚本，判断秒杀库存、一人一单，决定用户是否抢购成功</h5> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token comment">--优惠券ID</span>
<span class="token keyword">local</span> voucherId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">--用户ID</span>
<span class="token keyword">local</span> userId <span class="token operator">=</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

<span class="token comment">-- 数据key 库存key 订单key</span>
<span class="token keyword">local</span> stockKey <span class="token operator">=</span> <span class="token string">&quot;seckill:stock:&quot;</span> <span class="token operator">..</span> voucherId
<span class="token keyword">local</span> orderKey <span class="token operator">=</span> <span class="token string">&quot;seckill:order:&quot;</span> <span class="token operator">..</span> voucherId

<span class="token comment">--判断库存是否充足 tonumber函数转为数字</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span>stockKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">--库存不足</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>

<span class="token comment">--判断用户是否下单 sismember判断是否存在该字符，存在返回1，不存在返回0</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'sismember'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
    <span class="token comment">--存在，说明重复下单</span>
    <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>

<span class="token comment">--扣库存，下单</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'incrby'</span><span class="token punctuation">,</span> stockKey<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">-- 这里使用sadd往集合添加数据</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'sadd'</span><span class="token punctuation">,</span> orderKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h5 id="_3、存入阻塞队列-异步下单"><a href="#_3、存入阻塞队列-异步下单" class="header-anchor">#</a> 3、存入阻塞队列，异步下单</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> SECKILL_SCRIPT<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        SECKILL_SCRIPT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用resource下的seckill脚本</span>
        SECKILL_SCRIPT<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;seckill.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SECKILL_SCRIPT<span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 阻塞队列
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> orderTasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//开启线程</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> seckill_order_excutor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// @PostConstruct表示在系统启动时调用</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        seckill_order_excutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoucherOrderHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 内部类
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderHandle</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//1.获取队列中的订单信息</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">VoucherOrder</span> take <span class="token operator">=</span> orderTasks<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span>take<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//创建订单</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> take<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取用户</span>
            <span class="token class-name">Long</span> userId <span class="token operator">=</span> take<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RLock</span> redisLock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> redisLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取锁失败</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//返回错误</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>

                proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>take<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">//释放锁</span>
                redisLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">IVoucherOrderService</span> proxy<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//执行lua脚本</span>
        <span class="token class-name">Long</span> execute <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                SECKILL_SCRIPT<span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                voucherId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否返回为0 0-有购买资格 !0没有购买资格</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> execute<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> i <span class="token operator">?</span> <span class="token string">&quot;库存不足&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;不能重复下单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//0 把下单信息保存到阻塞队列</span>
        <span class="token comment">//创建订单号</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建订单</span>
        <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setVoucherId</span><span class="token punctuation">(</span>voucherId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        voucherOrder<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建阻塞队列</span>
        orderTasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取代理对象</span>
        proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> voucherOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//一人一单</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//查询订单</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//扣减库存</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getVoucherId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br></div></div><h4 id="_4、总结-3"><a href="#_4、总结-3" class="header-anchor">#</a> 4、总结</h4> <p>秒杀业务的优化思路是什么？</p> <ol><li>先利用Redis完成库存余量、一人一单判断，完成抢单业务</li> <li>再将下单业务放入阻塞队列，利用独立线程异步下单</li></ol> <p>基于阻塞队列的异步秒杀存在哪些问题？</p> <ul><li>内存限制问题：开启异步任务会占用CPU和内存</li> <li>数据安全问题：基于内存保存信息，若redis宕机了，则查询不到订单信息，可重复下单</li></ul> <h3 id="_7、redis消息队列实现异步秒杀"><a href="#_7、redis消息队列实现异步秒杀" class="header-anchor">#</a> 7、Redis消息队列实现异步秒杀</h3> <h4 id="_1、消息队列"><a href="#_1、消息队列" class="header-anchor">#</a> 1、消息队列</h4> <blockquote><p>消息队列（Message Queue），字面意思就是存放消息的队列。最简单的消息队列模型包括3个角色：</p> <ul><li>消息队列：存储和管理消息，也被称为消息代理（Message Broker）</li> <li>生产者：发送消息到消息队列</li> <li>消费者：从消息队列获取消息并处理消息</li></ul></blockquote> <p><img src="/assets/img/image-20220610155754095.84dd0309.png" alt="image-20220610155754095"></p> <p>Redis提供了三种不同的方式来实现消息队列：</p> <ul><li>list结构：基于List结构模拟消息队列</li> <li>PubSub：基本的点对点消息模型</li> <li>Stream：比较完善的消息队列模型</li></ul> <h5 id="_1、基于list结构模拟消息队列"><a href="#_1、基于list结构模拟消息队列" class="header-anchor">#</a> 1、基于List结构模拟消息队列</h5> <p>消息队列（Message Queue），字面意思就是存放消息的队列。而Redis的list数据结构是一个双向链表，很容易模拟出队列效果。</p> <p>队列是入口和出口不在一边，因此我们可以利用：LPUSH 结合 RPOP、或者 RPUSH 结合 LPOP来实现。</p> <p>不过要注意的是，当队列中没有消息时RPOP或LPOP操作会返回null，并不像JVM的阻塞队列那样会阻塞并等待消息。因此这里应该使用</p> <p>BRPOP或者BLPOP来实现阻塞效果。</p> <p><img src="/assets/img/image-20220610155946440.d1926412.png" alt="image-20220610155946440"></p> <p><strong>基于List的消息队列有哪些优缺点？</strong></p> <blockquote><p>优点：</p> <ul><li>利用Redis存储，不受限于JVM内存上限</li> <li>基于Redis的持久化机制，数据安全性有保证</li> <li>可以满足消息有序性</li></ul> <p>缺点：</p> <ul><li>无法避免消息丢失</li> <li>只支持单消费者</li></ul></blockquote> <h5 id="_2、基于pubsub的消息队列"><a href="#_2、基于pubsub的消息队列" class="header-anchor">#</a> 2、基于PubSub的消息队列</h5> <p>PubSub（发布订阅）是Redis2.0版本引入的消息传递模型。顾名思义，消费者可以订阅一个或多个channel，生产者向对应channel发送消息后，所有订阅者都能收到相关消息。</p> <ul><li>SUBSCRIBE channel [channel] ：订阅一个或多个频道</li> <li>PUBLISH channel msg ：向一个频道发送消息</li> <li>PSUBSCRIBE pattern[pattern] ：订阅与pattern格式匹配的所有频道</li></ul> <p><img src="/assets/img/image-20220610160149644.c8fbe06e.png" alt="image-20220610160149644"></p> <p><strong>基于PubSub的消息队列有哪些优缺点？</strong></p> <blockquote><p>优点：</p> <ul><li>采用发布订阅模型，支持多生产、多消费</li></ul> <p>缺点：</p> <ul><li>不支持数据持久化</li> <li>无法避免消息丢失</li> <li>消息堆积有上限，超出时数据丢失</li></ul></blockquote> <h5 id="_3、基于stream的消息队列"><a href="#_3、基于stream的消息队列" class="header-anchor">#</a> 3、基于Stream的消息队列</h5> <p>Stream 是 Redis 5.0 引入的一种新数据类型，可以实现一个功能非常完善的消息队列。</p> <p>发送消息的命令：</p> <p><img src="/assets/img/image-20220610160332746.1b92af99.png" alt="image-20220610160332746"></p> <p>例如：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">## 创建名为 users 的队列，并向其中发送一个消息，内容是：{name=jack,age=21}，并且使用Redis自动生成ID</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> XADD <span class="token function">users</span> * name jack age <span class="token number">21</span>
<span class="token string">&quot;1644805700523-0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h6 id="_1、xread"><a href="#_1、xread" class="header-anchor">#</a> 1、XREAD</h6> <p>读取消息的方式之一：XREAD</p> <p><img src="/assets/img/image-20220610160426369.8603135a.png" alt="image-20220610160426369"></p> <p>例如，使用XREAD读取第一个消息：</p> <p><img src="/assets/img/image-20220610160444698.e0208c86.png" alt="image-20220610160444698"></p> <p>XREAD阻塞方式，读取最新的消息：</p> <p><img src="/assets/img/image-20220610160517776.2ce4ec45.png" alt="image-20220610160517776"></p> <p>在业务开发中，我们可以循环的调用XREAD阻塞方式来查询最新消息，从而实现持续监听队列的效果，伪代码如下：</p> <p><img src="/assets/img/image-20220610160635924.b8450726.png" alt="image-20220610160635924"></p> <p>PS：当我们指定起始ID为$时，代表读取最新的消息，如果我们处理一条消息的过程中，又有超过1条以上的消息到达队列，则下次获取时也只能获取到最新的一条，会出现漏读消息的问题。</p> <p>总结：</p> <p>STREAM类型消息队列的XREAD命令特点：</p> <ul><li>消息可回溯</li> <li>一个消息可以被多个消费者读取</li> <li>可以阻塞读取</li> <li>有消息漏读的风险</li></ul> <h5 id="_4、基于stream的消息队列-消费者组"><a href="#_4、基于stream的消息队列-消费者组" class="header-anchor">#</a> 4、基于Stream的消息队列-消费者组</h5> <blockquote><p>消费者组（Consumer Group）：将多个消费者划分到一个组中，监听同一个队列。具备下列特点：</p> <ol><li><strong>消息分流</strong>：队列中的消息会分流给组内的不同消费者，而不是重复消费，从而加快消息处理的速度</li> <li><strong>消息标示</strong>：消费者组会维护一个标示，记录最后一个被处理的消息，哪怕消费者宕机重启，还会从标示之后读取消息。确保每一个消息都会被消费</li> <li><strong>消息确认</strong>：消费者获取消息后，消息处于pending状态，并存入一个pending-list。当处理完成后需要通过XACK来确认消息，标记消息为已处理，才会从pending-list移除。</li></ol></blockquote> <p>创建消费者组：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>XGROUP CREATE  key groupName ID <span class="token punctuation">[</span>MKSTREAM<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>key：队列名称</li> <li>groupName：消费者组名称</li> <li>ID：起始ID标示，$代表队列中最后一个消息，0则代表队列中第一个消息</li> <li>MKSTREAM：队列不存在时自动创建队列</li></ul> <p>其它常见命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 删除指定的消费者组</span>
XGROUP DESTORY key groupName

<span class="token comment"># 给指定的消费者组添加消费者</span>
XGROUP CREATECONSUMER key groupname consumername

<span class="token comment"># 删除消费者组中的指定消费者</span>
XGROUP DELCONSUMER key groupname consumername
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>从消费者组读取消息：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>XREADGROUP GROUP group consumer <span class="token punctuation">[</span>COUNT count<span class="token punctuation">]</span> <span class="token punctuation">[</span>BLOCK milliseconds<span class="token punctuation">]</span> <span class="token punctuation">[</span>NOACK<span class="token punctuation">]</span> STREAMS key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> ID <span class="token punctuation">[</span>ID <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>group：消费组名称</li> <li>consumer：消费者名称，如果消费者不存在，会自动创建一个消费者</li> <li>count：本次查询的最大数量</li> <li>BLOCK milliseconds：当没有消息时最长等待时间</li> <li>NOACK：无需手动ACK，获取到消息后自动确认</li> <li>STREAMS key：指定队列名称</li> <li>ID：获取消息的起始ID：
<ul><li>&quot;&gt;&quot;：从下一个未消费的消息开始</li> <li>其它：根据指定id从pending-list中获取已消费但未确认的消息，例如0，是从pending-list中的第一个消息开始</li></ul></li></ul> <p>消费者监听消息的基本思路：</p> <p><img src="/assets/img/image-20220610161403443.6d52fdee.png" alt="image-20220610161403443"></p> <p><strong>总结</strong></p> <p>STREAM类型消息队列的XREADGROUP命令特点：</p> <ul><li>消息可回溯</li> <li>可以多消费者争抢消息，加快消费速度</li> <li>可以阻塞读取</li> <li>没有消息漏读的风险</li> <li>有消息确认机制，保证消息至少被消费一次</li></ul> <h5 id="_5、对比"><a href="#_5、对比" class="header-anchor">#</a> 5、对比</h5> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;"><strong>List</strong></th> <th style="text-align:center;"><strong>PubSub</strong></th> <th style="text-align:center;"><strong>Stream</strong></th></tr></thead> <tbody><tr><td style="text-align:center;"><strong>消息持久化</strong></td> <td style="text-align:center;">支持</td> <td style="text-align:center;">不支持</td> <td style="text-align:center;">支持</td></tr> <tr><td style="text-align:center;"><strong>阻塞读取</strong></td> <td style="text-align:center;">支持</td> <td style="text-align:center;">支持</td> <td style="text-align:center;">支持</td></tr> <tr><td style="text-align:center;"><strong>消息堆积处理</strong></td> <td style="text-align:center;">受限于内存空间，可以利用多消费者加快处理</td> <td style="text-align:center;">受限于消费者缓冲区</td> <td style="text-align:center;">受限于队列长度，可以利用消费者组提高消费速度，减少堆积</td></tr> <tr><td style="text-align:center;"><strong>消息确认机制</strong></td> <td style="text-align:center;">不支持</td> <td style="text-align:center;">不支持</td> <td style="text-align:center;">支持</td></tr> <tr><td style="text-align:center;"><strong>消息回溯</strong></td> <td style="text-align:center;">不支持</td> <td style="text-align:center;">不支持</td> <td style="text-align:center;">支持</td></tr></tbody></table> <h4 id="_2、基于redis的stream结构作为消息队列-实现异步秒杀下单"><a href="#_2、基于redis的stream结构作为消息队列-实现异步秒杀下单" class="header-anchor">#</a> 2、基于Redis的Stream结构作为消息队列，实现异步秒杀下单</h4> <h5 id="_1、需求"><a href="#_1、需求" class="header-anchor">#</a> 1、需求</h5> <blockquote><p>需求：</p> <ul><li>创建一个Stream类型的消息队列，名为stream.orders</li> <li>修改之前的秒杀下单Lua脚本，在认定有抢购资格后，直接向stream.orders中添加消息，内容包含voucherId、userId、orderId</li> <li>项目启动时，开启一个线程任务，尝试获取stream.orders中的消息，完成下单</li></ul></blockquote> <h5 id="_2、创建一个stream类型的消息队列-名为stream-orders"><a href="#_2、创建一个stream类型的消息队列-名为stream-orders" class="header-anchor">#</a> 2、创建一个Stream类型的消息队列，名为stream.orders</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>XGROUP CREATE stream.orders g1 <span class="token number">0</span> MKSTREAM
<span class="token string">&quot;OK&quot;</span>
localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="_3、java代码改造"><a href="#_3、java代码改造" class="header-anchor">#</a> 3、Java代码改造</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>hutool<span class="token punctuation">.</span>core<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span><span class="token class-name">BeanUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ServiceImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>dto<span class="token punctuation">.</span></span><span class="token class-name">Result</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">VoucherOrder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">VoucherOrderMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ISeckillVoucherService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IVoucherOrderService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">RedisIdWorker</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>hmdp<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">UserHolder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RLock</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RedissonClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">AopContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ClassPathResource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span>script<span class="token punctuation">.</span></span><span class="token class-name">DefaultRedisScript</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostConstruct</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ArrayBlockingQueue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">BlockingQueue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executors</span></span><span class="token punctuation">;</span>
vv
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">VoucherOrderMapper</span><span class="token punctuation">,</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IVoucherOrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ISeckillVoucherService</span> seckillVoucherService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisIdWorker</span> redisIdWorker<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> SECKILL_SCRIPT<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        SECKILL_SCRIPT <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用resource下的seckill脚本</span>
        SECKILL_SCRIPT<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;seckill.lua&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SECKILL_SCRIPT<span class="token punctuation">.</span><span class="token function">setResultType</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 阻塞队列
     */</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> seckill_order_excutor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        seckill_order_excutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">VoucherOrderHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 内部类
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">VoucherOrderHandle</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span>

        <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token string">&quot;stream.orders&quot;</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//1.获取消息队列中的订单信息</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
                            <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//判断消息是否获取成功</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> list <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token comment">//获取失败，说明没有异常，执行下一次循环</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//解析消息中的订单信息</span>
                    <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//获取成功，可用下单</span>

                    <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//ACK确认</span>
                    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">handlePendingList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//创建订单</span>
            <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handlePendingList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//1.获取消息队列中的订单信息</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MapRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>
                            <span class="token class-name">Consumer</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">StreamReadOptions</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token class-name">StreamOffset</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token class-name">ReadOffset</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//判断消息是否获取成功</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> list <span class="token operator">||</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token comment">//获取失败，说明pending-list没有异常，执行下一次循环</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//解析消息中的订单信息</span>
                    <span class="token class-name">MapRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> values <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">VoucherOrder</span> voucherOrder <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">fillBeanWithMap</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">VoucherOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//获取成功，可用下单</span>

                    <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//ACK确认</span>
                    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> <span class="token string">&quot;g1&quot;</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> take<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取用户</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> take<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> redisLock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock:order:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isLock <span class="token operator">=</span> redisLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取锁失败</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isLock<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//返回错误</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            proxy<span class="token punctuation">.</span><span class="token function">createVoucherOrder</span><span class="token punctuation">(</span>take<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//释放锁</span>
            redisLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">IVoucherOrderService</span> proxy<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">seckillVoucher</span><span class="token punctuation">(</span><span class="token class-name">Long</span> voucherId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建订单号</span>
        <span class="token keyword">long</span> orderId <span class="token operator">=</span> redisIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//执行lua脚本</span>
        <span class="token class-name">Long</span> execute <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                SECKILL_SCRIPT<span class="token punctuation">,</span>
                <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                voucherId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否返回为0 0-有购买资格 !0没有购买资格</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> execute<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> i <span class="token operator">?</span> <span class="token string">&quot;库存不足&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;不能重复下单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//获取代理对象</span>
        proxy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IVoucherOrderService</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createVoucherOrder</span><span class="token punctuation">(</span><span class="token class-name">VoucherOrder</span> voucherOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//一人一单</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//查询订单</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//扣减库存</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> seckillVoucherService<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;stock = stock - 1&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;voucher_id&quot;</span><span class="token punctuation">,</span> voucherOrder<span class="token punctuation">.</span><span class="token function">getVoucherId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token string">&quot;stock&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">save</span><span class="token punctuation">(</span>voucherOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br></div></div><h2 id="_4、达人探店"><a href="#_4、达人探店" class="header-anchor">#</a> 4、达人探店</h2> <h3 id="_1、发布探店笔记"><a href="#_1、发布探店笔记" class="header-anchor">#</a> 1、发布探店笔记</h3> <h4 id="_1、场景-3"><a href="#_1、场景-3" class="header-anchor">#</a> 1、场景</h4> <blockquote><p>探店笔记类似点评网站的评价，往往是图文结合。对应的表有两个：
tb_blog：探店笔记表，包含笔记中的标题、文字、图片等
tb_blog_comments：其他用户对探店笔记的评价</p></blockquote> <h4 id="_2、实现查看发布探店笔记的接口"><a href="#_2、实现查看发布探店笔记的接口" class="header-anchor">#</a> 2、实现查看发布探店笔记的接口</h4> <blockquote><p>需求：点击首页的探店笔记，会进入详情页面，实现该页面的查询接口：</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 根据ID查询博客数据
     * @param id
     * @return
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Blog</span> blog <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> blog<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;笔记不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//查询博客用户</span>
    <span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
     * 查询博客用户
     * @param blog
     */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">queryBlogUser</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> blog<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    blog<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    blog<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getIcon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="_2、点赞"><a href="#_2、点赞" class="header-anchor">#</a> 2、点赞</h3> <h4 id="_1、需求与步骤"><a href="#_1、需求与步骤" class="header-anchor">#</a> 1、需求与步骤</h4> <h5 id="_1、需求-2"><a href="#_1、需求-2" class="header-anchor">#</a> 1、需求</h5> <ul><li>同一个用户只能点赞一次，再次点击则取消点赞</li> <li>如果当前用户已经点赞，则点赞按钮高亮显示（前端已实现，判断字段Blog类的isLike属性）</li></ul> <h5 id="_2、步骤"><a href="#_2、步骤" class="header-anchor">#</a> 2、步骤</h5> <blockquote><ol><li>给Blog类中添加一个isLike字段，标示是否被当前用户点赞</li> <li>修改点赞功能，利用Redis的set集合判断是否点赞过，未点赞过则点赞数+1，已点赞过则点赞数-1</li> <li>修改根据id查询Blog的业务，判断当前登录用户是否点赞过，赋值给isLike字段</li> <li>修改分页查询Blog业务，判断当前登录用户是否点赞过，赋值给isLike字段</li></ol></blockquote> <h4 id="_2、实现"><a href="#_2、实现" class="header-anchor">#</a> 2、实现</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>SADD key member1 [member2\]
向集合添加一个或多个成员

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 点赞
     * @param id
     * @return
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">likeBlog</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取登录用户</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否点赞</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;blog:liked:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> member <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isFalse</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//数据库点赞数+1</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;liked = liked + 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//保存到set集合</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//点赞取消 -1</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;liked = liked - 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//从set集合中移除</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 <span class="token comment">/**
     * 根据ID查询博客数据
     * @param id
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Blog</span> blog <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> blog<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;笔记不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//查询博客用户</span>
        <span class="token function">queryBlogUser</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//当期blog有没有被点赞</span>
        <span class="token function">isBlogLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">isBlogLiked</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取登录用户</span>
        <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//未登录不获取点赞</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//判断是否点赞</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>BLOG_LIKED_KEY <span class="token operator">+</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Boolean</span> member <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        blog<span class="token punctuation">.</span><span class="token function">setIsLike</span><span class="token punctuation">(</span><span class="token class-name">BooleanUtil</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h3 id="_3、点赞排行榜"><a href="#_3、点赞排行榜" class="header-anchor">#</a> 3、点赞排行榜</h3> <p>在探店笔记的详情页面，应该把给该笔记点赞的人显示出来，比如最早点赞的TOP5，形成点赞排行榜</p> <h4 id="_1、需求-3"><a href="#_1、需求-3" class="header-anchor">#</a> 1、需求</h4> <p>需求：按照点赞时间先后排序，返回Top5的用户</p> <table><thead><tr><th>** **</th> <th><strong>List</strong></th> <th><strong>Set</strong></th> <th><strong>SortedSet</strong></th></tr></thead> <tbody><tr><td><strong>排序方式</strong></td> <td>按添加顺序排序</td> <td>无法排序</td> <td>根据score值排序</td></tr> <tr><td><strong>唯一性</strong></td> <td>不唯一</td> <td>唯一</td> <td>唯一</td></tr> <tr><td><strong>查找方式</strong></td> <td>按索引查找或首尾查找</td> <td>根据元素查找</td> <td>根据元素查找</td></tr></tbody></table> <p>综合对比：满足唯一且排序的只有<code>SortedSet</code></p> <h4 id="_2、实现-2"><a href="#_2、实现-2" class="header-anchor">#</a> 2、实现</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">isBlogLiked</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取登录用户</span>
    <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//未登录不获取点赞</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否点赞</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>BLOG_LIKED_KEY <span class="token operator">+</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Double</span> score <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    blog<span class="token punctuation">.</span><span class="token function">setIsLike</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
     * 查询博客用户
     * @param blog
     */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">queryBlogUser</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> blog<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    blog<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getNickName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    blog<span class="token punctuation">.</span><span class="token function">setIcon</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getIcon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryHotBlog</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据用户查询</span>
    <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> blogService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token string">&quot;liked&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>MAX_PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取当前页数据</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 查询用户</span>
    records<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryBlogUser</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isBlogLiked</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
     * 点赞
     * @param id
     * @return
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">likeBlog</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取登录用户</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//判断是否点赞</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;blog:liked:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">Double</span> score <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> score<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//数据库点赞数+1</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;liked = liked + 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//保存到set集合</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//点赞取消 -1</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSql</span><span class="token punctuation">(</span><span class="token string">&quot;liked = liked - 1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//从set集合中移除</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> userId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
     * 点赞前五
     * @param id
     * @return
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogLikes</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查询top 5 zrange key 0 4</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>BLOG_LIKED_KEY <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> top5 <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//解析用户iD</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> top5 <span class="token operator">||</span> top5<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> top5<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> ids <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//查询用户返回 in(5,1) order by field(id, 5, 1)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> dtoList <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">&quot;order by field(id, &quot;</span> <span class="token operator">+</span> ids <span class="token operator">+</span><span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
   <span class="token comment">//这里因为in 的原因，查询出来的顺序跟插入参数顺序不一致，改用order by field(id, 5, 1)，手动指定字段和s</span>
    <span class="token comment">//        List&lt;UserDTO&gt; dtoList = userService.listByIds(list)</span>
    <span class="token comment">//                .stream()</span>
    <span class="token comment">//                .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))</span>
    <span class="token comment">//                .collect(Collectors.toList());</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>dtoList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div><h2 id="_5、好友关注"><a href="#_5、好友关注" class="header-anchor">#</a> 5、好友关注</h2> <h3 id="_1、关注和取关"><a href="#_1、关注和取关" class="header-anchor">#</a> 1、关注和取关</h3> <h4 id="_1、需求-4"><a href="#_1、需求-4" class="header-anchor">#</a> 1、需求</h4> <p>需求：基于该表数据结构，实现两个接口：</p> <ul><li>关注和取关接口</li> <li>判断是否关注的接口</li></ul> <p>关注是User之间的关系，是博主与粉丝的关系，数据库中有一张tb_follow表来标示：</p> <p><img src="/assets/img/image-20220615090348000.8b3abed8.png" alt="image-20220615090348000"></p> <h4 id="_2、实现-3"><a href="#_2、实现-3" class="header-anchor">#</a> 2、实现</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isFollow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取登录用户</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;follow:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
    <span class="token comment">//判断关注还是取关</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isFollow<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Follow</span> follow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Follow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        follow<span class="token punctuation">.</span><span class="token function">setFollowUserId</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        follow<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">save</span><span class="token punctuation">(</span>follow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;follow_user_id&quot;</span><span class="token punctuation">,</span> followUserId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">isFollow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取登录用户</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//查询是否关注</span>
    <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;follow_user_id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_2、共同关注"><a href="#_2、共同关注" class="header-anchor">#</a> 2、共同关注</h3> <h4 id="_1、需求-5"><a href="#_1、需求-5" class="header-anchor">#</a> 1、需求</h4> <p>需求：利用Redis中恰当的数据结构，实现共同关注功能。在博主个人页面展示出当前用户与博主的共同好友。</p> <h4 id="_2、实现-4"><a href="#_2、实现-4" class="header-anchor">#</a> 2、实现</h4> <p>共同关注是指user1和user2共同关注的博主，这里可以使用<code>SortSet</code>，可查看两个key共同的值</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ZINTERSTORE destination numkeys key [key ...]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>计算给定的一个或多个有序集的交集并将结果集存储在新的有序集合 destination 中</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 共同关注
     * @param id
     * @return
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">followCommons</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;follow:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
    <span class="token class-name">String</span> key2 <span class="token operator">=</span> <span class="token string">&quot;follow:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token comment">//求交集</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> intersect <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intersect</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> key2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> intersect <span class="token operator">||</span> intersect<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//转换id</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> intersect<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//查询用户</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">listByIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="_3、关注推送"><a href="#_3、关注推送" class="header-anchor">#</a> 3、关注推送</h3> <p>关注推送也叫做Feed流，直译为投喂。为用户持续的提供“沉浸式”的体验，通过无限下拉刷新获取新的信息。</p> <p>传统模式下，用户需要的内容通过自己去查找</p> <p><img src="/assets/img/image-20220615093626087.d0714bd3.png" alt="image-20220615093626087"></p> <p>Feed模式下，通过用户浏览的内容进行分析，然后推送给用户</p> <p><img src="/assets/img/image-20220615093719028.648fc4fe.png" alt="image-20220615093719028"></p> <h4 id="_1、feed流"><a href="#_1、feed流" class="header-anchor">#</a> 1、Feed流</h4> <blockquote><p>Feed流产品有两种常见模式：</p> <ul><li>Timeline：不做内容筛选，简单的按照内容发布时间排序，常用于好友或关注。例如朋友圈
<ul><li>优点：信息全面，不会有缺失。并且实现也相对简单</li> <li>缺点：信息噪音较多，用户不一定感兴趣，内容获取效率低</li></ul></li> <li>智能排序：利用智能算法屏蔽掉违规的、用户不感兴趣的内容。推送用户感兴趣信息来吸引用户
<ul><li>优点：投喂用户感兴趣信息，用户粘度很高，容易沉迷</li> <li>缺点：如果算法不精准，可能起到反作用</li></ul></li></ul></blockquote> <h4 id="_2、timeline模式"><a href="#_2、timeline模式" class="header-anchor">#</a> 2、Timeline模式</h4> <blockquote><p>该模式的实现方案有三种：</p> <ul><li>拉模式</li> <li>推模式</li> <li>推拉结合</li></ul></blockquote> <h5 id="_1、拉模式"><a href="#_1、拉模式" class="header-anchor">#</a> 1、拉模式</h5> <blockquote><p>拉模式：也叫做读扩散。简单来说就是关注者要读取的时候，实时去查询被关注者的发件箱，然后进行读取</p></blockquote> <p><img src="/assets/img/image-20220615094214339.36785087.png" alt="image-20220615094214339"></p> <p>每人都有一个发件箱，收件箱，张三、李四、王五、赵六四个人，赵六关注张三和李四。</p> <p>现在张三和李四同时发两条信息，王五发送一条，赵六因关注张三和李四，这时会去查询张三李四的发件箱，然后进行读取，未关注王五则读取不到信息。</p> <h5 id="_2、推模式"><a href="#_2、推模式" class="header-anchor">#</a> 2、推模式</h5> <blockquote><p>推模式：也叫做写扩散。简单来说就是推送到每一个关注的邮箱，他们读取自己的邮箱的信息</p></blockquote> <p><img src="/assets/img/image-20220615113036103.a861a308.png" alt="image-20220615113036103"></p> <h5 id="_3、推拉结合"><a href="#_3、推拉结合" class="header-anchor">#</a> 3、推拉结合</h5> <blockquote><p>推拉结合模式：也叫做读写混合，兼具推和拉两种模式的优点。</p></blockquote> <p><img src="/assets/img/image-20220615113946105.46f7a819.png" alt="image-20220615113946105"></p> <p>对于普通人，粉丝量不大的，采用拉模式；对于大V且是活跃粉丝，采用推模式，精准推送，活跃度不高的可采用拉模式</p> <h5 id="_4、对比"><a href="#_4、对比" class="header-anchor">#</a> 4、对比</h5> <table><thead><tr><th></th> <th><strong>拉模式</strong></th> <th><strong>推模式</strong></th> <th><strong>推拉结合</strong></th></tr></thead> <tbody><tr><td><strong>写比例</strong></td> <td>低</td> <td>高</td> <td>中</td></tr> <tr><td><strong>读比例</strong></td> <td>高</td> <td>低</td> <td>中</td></tr> <tr><td><strong>用户读取延迟</strong></td> <td>高</td> <td>低</td> <td>低</td></tr> <tr><td><strong>实现难度</strong></td> <td>复杂</td> <td>简单</td> <td>很复杂</td></tr> <tr><td><strong>使用场景</strong></td> <td>很少使用</td> <td>用户量少、没有大V</td> <td>过千万的用户量，有大V</td></tr></tbody></table> <h4 id="_3、基于推模式实现关注推送功能"><a href="#_3、基于推模式实现关注推送功能" class="header-anchor">#</a> 3、基于推模式实现关注推送功能</h4> <h5 id="_1、需求-6"><a href="#_1、需求-6" class="header-anchor">#</a> 1、需求</h5> <blockquote><p>需求：</p> <ul><li>修改新增探店笔记的业务，在保存blog到数据库的同时，推送到粉丝的收件箱</li> <li>收件箱满足可以根据时间戳排序，必须用Redis的数据结构实现</li> <li>查询收件箱数据时，可以实现分页查询</li></ul></blockquote> <h5 id="_2、feed流的分页问题"><a href="#_2、feed流的分页问题" class="header-anchor">#</a> 2、Feed流的分页问题</h5> <p>Feed流中的数据会不断更新，所以数据的角标也在变化，因此不能采用传统的分页模式。</p> <p>传统角标的效果：</p> <p><img src="/assets/img/image-20220616100348706.9faef8ac.png" alt="image-20220616100348706"></p> <p>实际需要的效果：</p> <p><img src="/assets/img/image-20220616100454128.647a82a1.png" alt="image-20220616100454128"></p> <h5 id="_3、实现-2"><a href="#_3、实现-2" class="header-anchor">#</a> 3、实现</h5> <p>1.修改新增探店笔记的业务，在保存blog到数据库的同时，推送到粉丝的收件箱</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">saveBlog</span><span class="token punctuation">(</span><span class="token class-name">Blog</span> blog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取登录用户</span>
    <span class="token class-name">UserDTO</span> user <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    blog<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存探店博文</span>
    <span class="token keyword">boolean</span> save <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>save<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;新增笔记失败！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//查询笔记所有粉丝</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">&gt;</span></span> followList <span class="token operator">=</span> followService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;follow_user_id&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//笔记Id推送给粉丝</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Follow</span> follow <span class="token operator">:</span> followList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>FEED_KEY <span class="token operator">+</span> follow<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回id</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>blog<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> followUserId<span class="token punctuation">,</span> <span class="token class-name">Boolean</span> isFollow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取登录用户</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;follow:&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
    <span class="token comment">//判断关注还是取关</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isFollow<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Follow</span> follow <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Follow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        follow<span class="token punctuation">.</span><span class="token function">setFollowUserId</span><span class="token punctuation">(</span>followUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        follow<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isSuccess <span class="token operator">=</span> <span class="token function">save</span><span class="token punctuation">(</span>follow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//把关注用户的id存入redis set集合</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> followUserId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> remove <span class="token operator">=</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Follow</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;follow_user_id&quot;</span><span class="token punctuation">,</span> followUserId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>remove<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//从redis set集合中移除</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> followUserId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>2.收件箱满足可以根据时间戳排序，必须用Redis的数据结构实现</p> <p>3.查询收件箱数据时，可以实现分页查询</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 收件箱笔记滚动分页
     * @param lastId
     * @param offset
     * @return
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryBlogOfFollow</span><span class="token punctuation">(</span><span class="token class-name">Long</span> lastId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取当前用户</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//查询收件箱</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>FEED_KEY <span class="token operator">+</span> userId<span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZSetOperations<span class="token punctuation">.</span>TypedTuple</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> range <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">reverseRangeByScoreWithScores</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> lastId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> range <span class="token operator">||</span> range<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//解析数据blogId,minTime时间戳</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>range<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> minTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> os <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ZSetOperations<span class="token punctuation">.</span>TypedTuple</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> tuple <span class="token operator">:</span> range<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取iD</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>tuple<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取分数（时间戳）</span>
        <span class="token keyword">long</span> time <span class="token operator">=</span> tuple<span class="token punctuation">.</span><span class="token function">getScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">==</span> minTime<span class="token punctuation">)</span><span class="token punctuation">{</span>
            os<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            minTime <span class="token operator">=</span> time<span class="token punctuation">;</span>
            os <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//根据id查询blog 返回也要根据顺序返回</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Blog</span><span class="token punctuation">&gt;</span></span> blogs <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">&quot;order by field(id, &quot;</span> <span class="token operator">+</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Blog</span> blog <span class="token operator">:</span> blogs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">isBlogLiked</span><span class="token punctuation">(</span>blog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//封装返回</span>
    <span class="token class-name">ScrollResult</span> scrollResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScrollResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    scrollResult<span class="token punctuation">.</span><span class="token function">setList</span><span class="token punctuation">(</span>blogs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    scrollResult<span class="token punctuation">.</span><span class="token function">setMinTime</span><span class="token punctuation">(</span>minTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    scrollResult<span class="token punctuation">.</span><span class="token function">setOffset</span><span class="token punctuation">(</span>os<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>scrollResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h2 id="_6、附近商户"><a href="#_6、附近商户" class="header-anchor">#</a> 6、附近商户</h2> <h3 id="_1、geo数据结构"><a href="#_1、geo数据结构" class="header-anchor">#</a> 1、GEO数据结构</h3> <blockquote><p>GEO就是Geolocation的简写形式，代表地理坐标。Redis在3.2版本中加入了对GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据。</p></blockquote> <p>常见的命令有：</p> <ul><li><code>GEOADD</code>：添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）</li> <li><code>GEODIST</code>：计算指定的两个点之间的距离并返回</li> <li><code>GEOHASH</code>：将指定member的坐标转为hash字符串形式并返回</li> <li><code>GEOPOS</code>：返回指定member的坐标</li> <li><code>GEORADIUS</code>：指定圆心、半径，找到该圆内包含的所有member，并按照与圆心之间的距离排序后返回。6.2以后已废弃</li> <li><code>GEOSEARCH</code>：在指定范围内搜索member，并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形。6.2.新功能</li> <li><code>GEOSEARCHSTORE</code>：与GEOSEARCH功能一致，不过可以把结果存储到一个指定的key。 6.2.新功能</li></ul> <h4 id="_1、练习redis的geo功能"><a href="#_1、练习redis的geo功能" class="header-anchor">#</a> 1、练习Redis的GEO功能</h4> <p>1、添加下面几条数据：</p> <ul><li>北京南站（ 116.378248 39.865275 ）</li> <li>北京站（ 116.42803 39.903738 ）</li> <li>北京西站（ 116.322287 39.893729 ）</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>GEOADD g1 <span class="token number">116.378248</span> <span class="token number">39.865275</span> bjn <span class="token number">116.42803</span> <span class="token number">39.903738</span> bjz <span class="token number">116.322287</span> <span class="token number">39.893729</span> bjx
<span class="token string">&quot;3&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>2、计算北京西站到北京站的距离</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>GEODIST g1 bjn bjx km
<span class="token string">&quot;5.7300&quot;</span>
localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>GEODIST g1 bjz bjx km
<span class="token string">&quot;9.0916&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>3、搜索天安门（ 116.397904 39.909005 ）附近10km内的所有火车站，并按照距离升序排序</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 6.2版本之前</span>
localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>GEORADIUS g1 <span class="token number">116.397904</span> <span class="token number">39.909005</span> <span class="token number">10</span> km WITHDIST
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;bjz&quot;</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;2.6361&quot;</span>

<span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;bjn&quot;</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;5.1452&quot;</span>

<span class="token number">3</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;bjx&quot;</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;6.6723&quot;</span>

<span class="token comment">#6.2之后的版本</span>
localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>GEOSEARCH g1 FROMLONLAT <span class="token number">116.397904</span> <span class="token number">39.909005</span> BYRADIUS <span class="token number">10</span> km WITHDIST
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;bjz&quot;</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;2.6361&quot;</span>

<span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;bjn&quot;</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;5.1452&quot;</span>

<span class="token number">3</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;bjx&quot;</span>
   <span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;6.6723&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="_2、测试类导入redis"><a href="#_2、测试类导入redis" class="header-anchor">#</a> 2、测试类导入redis</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 店铺数据导入redis
     */</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadShopData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//获取商户列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> shopService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//根据类型进行分组</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span><span class="token class-name">Shop</span><span class="token operator">::</span><span class="token function">getTypeId</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//获取类型ID</span>
        <span class="token class-name">Long</span> typeId <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;shop:geo:&quot;</span> <span class="token operator">+</span> typeId<span class="token punctuation">;</span>
        <span class="token comment">//获取相同店铺类型的集合</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> value <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> locations <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//写入redis GEOADD key 经度 纬度 member</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span> shop <span class="token operator">:</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            locations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
                shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>shop<span class="token punctuation">.</span><span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shop<span class="token punctuation">.</span><span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> locations<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_2、附近商户搜索"><a href="#_2、附近商户搜索" class="header-anchor">#</a> 2、附近商户搜索</h3> <p>按照商户类型做分组，类型相同的商户作为同一组，以typeId为key存入同一个GEO集合中即可</p> <p><img src="/assets/img/image-20220616114933992.928a3210.png" alt="image-20220616114933992"></p> <p>SpringDataRedis的2.3.9版本并不支持Redis 6.2提供的GEOSEARCH命令，因此我们需要提示其版本，修改自己的POM文件，内容如</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--排除旧版本--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.data<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.data<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>6.1.8.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>代码实现</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">queryShopByType</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> typeId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> current<span class="token punctuation">,</span> <span class="token class-name">Double</span> x<span class="token punctuation">,</span> <span class="token class-name">Double</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//是否需要根据坐标查询</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> x <span class="token operator">||</span> <span class="token keyword">null</span> <span class="token operator">==</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根据类型分页查询</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;type_id&quot;</span><span class="token punctuation">,</span> typeId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>DEFAULT_PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回数据</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getRecords</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//计算分页参数</span>
    <span class="token keyword">int</span> from <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>DEFAULT_PAGE_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">int</span> end <span class="token operator">=</span> current <span class="token operator">*</span> <span class="token class-name">SystemConstants</span><span class="token punctuation">.</span>MAX_PAGE_SIZE<span class="token punctuation">;</span>
    <span class="token comment">//查询redis，按照距离，分页</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>SHOP_GEO_KEY <span class="token operator">+</span> typeId<span class="token punctuation">;</span>
    <span class="token class-name">GeoResults</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForGeo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>
        key<span class="token punctuation">,</span>
        <span class="token class-name">GeoReference</span><span class="token punctuation">.</span><span class="token function">fromCoordinate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">Distance</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoSearchCommandArgs</span><span class="token punctuation">.</span><span class="token function">newGeoSearchArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includeDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//解析出id</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GeoResult</span><span class="token punctuation">&lt;</span><span class="token class-name">RedisGeoCommands<span class="token punctuation">.</span>GeoLocation</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> from<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//截取from - end 的部分</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Distance</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">skip</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token comment">//获取店铺ID</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取距离</span>
        <span class="token class-name">Distance</span> distance <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> distance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//根据id查询shop</span>
    <span class="token class-name">String</span> join <span class="token operator">=</span> <span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Shop</span><span class="token punctuation">&gt;</span></span> shopList <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token string">&quot;order by filed(id,&quot;</span> <span class="token operator">+</span> join <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Shop</span> shop <span class="token operator">:</span> shopList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shop<span class="token punctuation">.</span><span class="token function">setDistance</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>shop<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>shopList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h2 id="_7、用户签到"><a href="#_7、用户签到" class="header-anchor">#</a> 7、用户签到</h2> <h3 id="_1、bitmap用法"><a href="#_1、bitmap用法" class="header-anchor">#</a> 1、BitMap用法</h3> <h4 id="_1、场景-4"><a href="#_1、场景-4" class="header-anchor">#</a> 1、场景</h4> <p>假如我们用一张表来存储用户签到信息，其结构应该如下：</p> <p><img src="/assets/img/image-20220616153704689.102fed0f.png" alt="image-20220616153704689"></p> <blockquote><p>假如有1000万用户，平均每人每年签到次数为10次，则这张表一年的数据量为 1亿条
每签到一次需要使用（8 + 8 + 1 + 1 + 3 + 1）共22 字节的内存，一个月则最多需要600多字节</p></blockquote> <p>很显然，这种做法占用空间过大，那有没有更好的做法呢？</p> <h5 id="优化版"><a href="#优化版" class="header-anchor">#</a> 优化版</h5> <blockquote><p>我们按月来统计用户签到信息，签到记录为1，未签到则记录为0.</p></blockquote> <p><img src="/assets/img/image-20220616153916706.5dc30846.png" alt="image-20220616153916706"></p> <p>例：张三2022年1月的签到记录，key为<code>张三：202201</code>，值为0或1组成的bit，那这样一个月也就2字节</p> <p><strong>把每一个bit位对应当月的每一天，形成了映射关系。用0和1标示业务状态，这种思路就称为位图（BitMap）</strong></p> <p>Redis中是利用string类型数据结构实现BitMap，因此最大上限是512M，转换为bit则是 2^32个bit位</p> <h4 id="_2、用法"><a href="#_2、用法" class="header-anchor">#</a> 2、用法</h4> <blockquote><p>Redis中是利用string类型数据结构实现BitMap，因此最大上限是512M，转换为bit则是 2^32个bit位。</p></blockquote> <p>BitMap的操作命令有：</p> <ul><li>SETBIT：向指定位置（offset）存入一个0或1</li> <li>GETBIT ：获取指定位置（offset）的bit值</li> <li>BITCOUNT ：统计BitMap中值为1的bit位的数量</li> <li>BITFIELD ：操作（查询、修改、自增）BitMap中bit数组中的指定位置（offset）的值</li> <li>BITFIELD_RO ：获取BitMap中bit数组，并以十进制形式返回</li> <li>BITOP ：将多个BitMap的结果做位运算（与 、或、异或）</li> <li>BITPOS ：查找bit数组中指定范围内第一个0或1出现的位置</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>setbit zs <span class="token number">0</span> <span class="token number">1</span>
<span class="token string">&quot;0&quot;</span>
localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>setbit zs <span class="token number">1</span> <span class="token number">0</span>
<span class="token string">&quot;0&quot;</span>
localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>getbit zs <span class="token number">1</span>
<span class="token string">&quot;0&quot;</span>
localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>bitcount zs
<span class="token string">&quot;1&quot;</span>
localhost:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span>bitpos zs <span class="token number">1</span>
<span class="token string">&quot;0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_2、签到功能"><a href="#_2、签到功能" class="header-anchor">#</a> 2、签到功能</h3> <h4 id="_1、需求-7"><a href="#_1、需求-7" class="header-anchor">#</a> 1、需求</h4> <blockquote><p>实现签到接口，将当前用户当天签到信息保存到Redis中</p></blockquote> <h4 id="_2、实现-5"><a href="#_2、实现-5" class="header-anchor">#</a> 2、实现</h4> <p>提示：因为BitMap底层是基于String数据结构，因此其操作也都封装在字符串相关操作中了。</p> <p><img src="/assets/img/image-20220616161352940-16553672344001.894405df.png" alt="image-20220616161352940"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 签到
     * @return
     */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取登录用户</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//获取日期，获取today是当前月的第几天</span>
    <span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> keySuffix <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;:yyyyMM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> dayOfMonth <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">getDayOfMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//存入redis</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>USER_SIGN_KEY <span class="token operator">+</span> userId <span class="token operator">+</span> keySuffix<span class="token punctuation">;</span>
    stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dayOfMonth <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_3、签到统计"><a href="#_3、签到统计" class="header-anchor">#</a> 3、签到统计</h3> <p>Q1：什么叫做连续签到天数？</p> <blockquote><p>从最后一次签到开始向前统计，直到遇到第一次未签到为止，计算总的签到次数，就是连续签到天数。</p></blockquote> <p><img src="data:image/png;base64,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" alt="image-20220616161526309"></p> <p>Q2：如何得到本月到今天为止的所有签到数据？</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>BITFIELD key GET u<span class="token punctuation">[</span>dayOfMonth<span class="token punctuation">]</span> <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Q3：如何从后向前遍历每个bit位？</p> <blockquote><p>与 1 做与运算，就能得到最后一个bit位。
随后右移1位，下一个bit位就成为了最后一个bit位。</p></blockquote> <h4 id="实现签到统计功能"><a href="#实现签到统计功能" class="header-anchor">#</a> 实现签到统计功能</h4> <h5 id="_1、需求-8"><a href="#_1、需求-8" class="header-anchor">#</a> 1、需求</h5> <blockquote><p>统计当前用户截止当前时间在本月的连续签到天数</p></blockquote> <h5 id="_2、实现-6"><a href="#_2、实现-6" class="header-anchor">#</a> 2、实现</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span> <span class="token function">signCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取登录用户</span>
    <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token class-name">UserHolder</span><span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//获取日期，获取today是当前月的第几天</span>
    <span class="token class-name">LocalDateTime</span> time <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> keySuffix <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">&quot;:yyyyMM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> dayOfMonth <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">getDayOfMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//存入redis</span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisConstants</span><span class="token punctuation">.</span>USER_SIGN_KEY <span class="token operator">+</span> userId <span class="token operator">+</span> keySuffix<span class="token punctuation">;</span>
    <span class="token comment">//获取本月截止 今天为止的所有签到记录，返回一个十进制的数字</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bitField</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>
                                                                   <span class="token class-name">BitFieldSubCommands</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">BitFieldSubCommands<span class="token punctuation">.</span>BitFieldType</span><span class="token punctuation">.</span><span class="token function">unsigned</span><span class="token punctuation">(</span>dayOfMonth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valueAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//循环遍历</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> result <span class="token operator">||</span> result<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Long</span> num <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> num <span class="token operator">||</span> <span class="token number">0</span> <span class="token operator">==</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//让这个数字与1做与运算，得到数字的最后一个bit位</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断是否为0，如果为0，则表示未签到，结束，不为0，已签到，计数器+1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token punctuation">(</span>num <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//把数字右移一位，抛弃最后一个bit位，继续下一个bit位</span>
        num <span class="token operator">&gt;&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="_8、uv统计"><a href="#_8、uv统计" class="header-anchor">#</a> 8、UV统计</h2> <h3 id="_1、hyperloglog用法"><a href="#_1、hyperloglog用法" class="header-anchor">#</a> 1、HyperLogLog用法</h3> <p>首先我们搞懂两个概念：</p> <blockquote><p>UV：全称Unique Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录1次。
PV：全称Page View，也叫页面访问量或点击量，用户每访问网站的一个页面，记录1次PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。</p></blockquote> <p>UV统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。但是如果每个访问的用户都保存到Redis中，数据量会非常恐怖。</p> <p>Hyperloglog(HLL)是从Loglog算法派生的概率算法，用于确定非常大的集合的基数，而不需要存储其所有值。相关算法原理大家可以参考：https://juejin.cn/post/6844903785744056333#heading-0</p> <p>Redis中的HLL是基于string结构实现的，单个HLL的内存永远小于16kb，内存占用低的令人发指！作为代价，其测量结果是概率性的，有小于0.81％的误差。不过对于UV统计来说，这完全可以忽略。</p> <p><img src="/assets/img/image-20220616164333032.9850cc6e.png" alt="image-20220616164333032"></p> <h3 id="_2、实现uv统计"><a href="#_2、实现uv统计" class="header-anchor">#</a> 2、实现UV统计</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        j <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        values<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;user_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">999</span> <span class="token operator">==</span> j<span class="token punctuation">)</span><span class="token punctuation">{</span>
            stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;hl&quot;</span><span class="token punctuation">,</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Long</span> count <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token string">&quot;hl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_3、总结-3"><a href="#_3、总结-3" class="header-anchor">#</a> 3、总结</h3> <p>HyperLogLog的作用：</p> <blockquote><p>做海量数据的统计工作</p></blockquote> <ul><li>HyperLogLog的优点：内存占用极低、性能非常好</li> <li>HyperLogLog的缺点：有一定的误差</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022-11-13</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notes/database/MySQL.html" class="prev">
        MySQL
      </a></span> <span class="next"><a href="/notes/frame/JavaWebNote.html">
        Java Web
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div id="goTop" class="hide-cat" data-v-bf92849a></div><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/assets/js/app.9fae93c2.js" defer></script><script src="/assets/js/8.6de2748b.js" defer></script><script src="/assets/js/5.3fa9fdce.js" defer></script>
  </body>
</html>
